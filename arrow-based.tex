\section{Arrow-based conditions}
\slabel{ab-conditions}

In this section we recall the standard notion of nested condition, using notations that will make the connection with the variation proposed in this paper as straightforward as possible. Here and in the remainder of the paper, we will mostly omit the term ``nested'' and just refer to \emph{conditions}; however, to distinguish them from our variation, we will refer to the standard notion of nested conditions as \emph{arrow-based}.

The definitions below use \emph{objects} and \emph{arrows} as building blocks. These can for now be thought of as the objects and arrows of any category $\bC$; however, our examples and intuitions will all be based on $\cat{Graph}$,\todo{AC: formal def. of the category in background section?} the category of directed, edge-labelled multigraphs. 

Arrow-based conditions are inductively defined as follows:

\begin{definition}[arrow-based condition]\dlabel{ab-condition}
  Let $R$ be any object of $\bC$. $\AC R$ (the set of \emph{arrow-based conditions} over $R$) and $\AB R$ (the set of \emph{arrow-based branches} over $R$) are the smallest sets such that
  \begin{itemize}
  \item $c\in \AC R$ if $c=(R,p_1\ccdots p_w)$ is a pair with $p_i\in \AB R$ is a finite set;
  \item $p\in \AB R$ if $p=(a,c)$ where $a: R\func P$ is an arrow of $\bC$ and $c\in \AC P$.
  \end{itemize}
\end{definition}
%
%\emph{Terminology and notation:}
We regularly abbreviate ``arrow-based" to ``ab". We call $R$ the \emph{root} of an -ab-condition or ab-branch, and $P$ the \emph{pattern} of a branch (which is simultaneously the root of its subconditon). \fcite{ab-condition} provides a visualisation of an ab-condition $c$. We use $b,c$ to range over ab-conditions and $p,q$ to range over ab-branches. We use $|c|=w$ to denote the width of an ab-condition $c$, $R^c$ to denote its root, and $p^c_i=(a^c_i,c_i)$ its $i$-th branch. Finally, we use $P^c_i$ ($=R^{c_i}$) for the pattern of branch $p^c_i$. In all these cases, we may omit the superscript $c$ if it is clear from the context.
%
\begin{figure}
  \centering
  \input{figs/ab-condition}
  \caption{Pictorial representation of a arrow-based condition $c$}
  \flabel{ab-condition}
\end{figure}

Note that, as a consequence of the inductive nature of \dcite{ab-condition}, every ab-condition has a finite \emph{depth} $\depth(c)$, defined as $0$ if $\cB_c=\emptyset$ and $1+\max_{p\in \cB_c} \depth(c_p)$ otherwise. The depth will provide a basis for inductive proofs.

\begin{example}\exlabel{ab-conditions}
The following figure depicts two arrow-based conditions. The first expresses a property $\phi$ over arrows from the empty graph, the second a property $\psi$ over arrows from the discrete one-node graph (meaning essentially that we already know the image of that node). In FOL, the properties can be expressed as follows:
\begin{itemize}
\item $\phi\equiv \exists x,y\st b(x,y) \wedge \neg a(y,y)\wedge \neg \exists z\st c(y,z)$
\item $\psi\equiv a(x,x)\vee \exists y\st b(x,y) \wedge \forall v,z\st c(y,v)\wedge c(y,z) \rightarrow v=z$
\end{itemize}
Note that in most cases we have used variable names to represent nodes, to make the connection to the corresponding FOL properties more immediately understandable. The arrows are in all cases implied by the graph structure and variable names.
\begin{center}
\input{figs/ex-ab-conditions}
\end{center}
\end{example}
%
A condition expresses a property of arrows from its root to an arbitrary object. This is operationalised through the notion of \emph{satisfaction}.

\begin{definition}[satisfaction of arrow-based conditions]\dlabel{ab-satisfaction}
  Let $c$ be an ab-condition and $g:R^c\func G$ an arrow from $c$'s root to some object $G$. We say that \emph{$g$ satisfies $c$}, denoted $g\sat c$, if there is a branch $p_i$ of $c$ and an arrow $h:P_i\func G$ such that
  \begin{itemize}
  \item $g=r_p;h$
  \item $h\nsat c_i$.
  \end{itemize}
\end{definition}
%
%\emph{Terminology and notation.}
If $g\sat c$, we also say that $g$ is a \emph{model} for $c$. We call $p$ the \emph{responsible branch} and $h$ the \emph{witness} for $g\sat C$. Pictorially, $g\sat c$ with responsible branch $p$ and witness $h$ can be visualised as in \fcite{ab-satisfaction}.
%
\begin{figure}
  \centering
  \input{figs/ab-satisfaction}
  \caption{Pictorial representation of $g\sat c$, with responsible branch $p$ and witness $h$}
  \flabel{ab-satisfaction}
\end{figure}

Based on the notion of satisfaction, we also define \emph{semantic entailment} $b\entails c$ and \emph{semantic equivalent} $b\equiv c$ over conditions:
%
\begin{align*}
b \entails c & \text{ if for all arrows $g$: } g\sat b \text{ implies } c\sat g \\
b \equiv c & \text{ if for all arrows $g$: } g\sat b \text{ if and only if } c\sat g \\
\end{align*}
%
\begin{example}\exlabel{ab-satisfaction}
For the ab-conditions in \excite{ab-conditions}, the following morphisms can be considered as models:
\begin{itemize}
\item Let $G_1=\mygraph{
\node (1) {$\bullet$};
\node (2) [right=of 1] {$\bullet$};
\path (1) edge[bend left=20,->] node[above] {$\scriptstyle{b}$} (2)
      (2) edge[bend left=20,->] node[below] {$\scriptstyle{b}$} (1)
	  (1) edge[loop left,->] node[left] {$\scriptstyle{a}$} (1);
	  }$
and let $g$ be the only arrow from the empty graph to $G_1$. This is a model of $\phi$: the witness $h$ (for the top level) maps $x$ to the left-hand node and $y$ to the right-hand node. $h$ does not satisfy the subcondition because it cannot be extended with either the loop specified by the left branch or the outgoing $c$-edge specified by the right branch.
	  
\item Let $G_2=\mygraph{
\node (1) {$\bullet$};
\node (2) [right=of 1] {$\bullet$};
\node (3) [right=of 2] {$\bullet$};
\path (1) edge[bend left=20,->] node[above] {$\scriptstyle{b}$} (2)
      (2) edge[bend left=20,->] node[below] {$\scriptstyle{b}$} (1)
	  (1) edge[loop left,->] node[left] {$\scriptstyle{a}$} (1)
      (2) edge[->] node[above] {$\scriptstyle{c}$} (3);
	  }$
and let $g$ be the only arrow from the empty graph to $G_2$. This is \emph{not} a model of $\phi$: there are two candidate witnesses, but both satisfy one of the branches of the subcondition.

\item Let $G_1$ be as above and consider the arrow $g$ from the one-node discrete graph that maps that node to $G_1$'s left-hand node. This is a model of $\psi$, with the obvious witness.


\end{itemize}
\end{example}

\subsection{Morphisms of arrow-based conditions}

The notion of \emph{morphism} of nested conditions has not received much attention in the literature. Given the fact that an ab-condition is essentially a diagram in the category $\bC$, it is natural to think that a morphism from $b$ to $c$ should essentially be a morphism between their diagrams, involving arrows from objects of $b$ to objects of $c$ such that all subdiagrams commute. However, since the semantics of conditions is really captured by the notion of satisfaction, we want satisfaction to be preserved by morphisms, in some precise sense. For that to be the case, we need a more refined notion of morphism that plays well with the second clause of \dcite{ab-satisfaction}, in which there is a negation: the witness $h$ should \emph{not} satisfy the subcondition $c_b$. 

This intuition explains why in the morphisms we are going to introduce, at each level conditions are related by arrows going in the opposite direction of the arrows relating the corresponding subconditions.  

Recall that, in any category, given an arrow $r: A \to B$ a \emph{section} for $r$ is an arrow $s: B \to A$ such that $s;r = id_B$. In this case $r$ is called a retraction (for $s$), and it is easily shown that $r$ is epi.

\begin{definition}[arrow-based condition morphism]\dlabel{ab-morphism}
  Given two ab-conditions $b$ and $c$, an \emph{arrow-based condition morphism} $m: b \to c$ is a triple $(t,o,m_1\ccdots m_{|b|})$ such that   
  \begin{itemize}
    \item $t:R_b\func R_c$ is an arrow, called the \emph{top-level arrow} of $m$;
	\item $o:[1,|b|]\to[1,|c|]$ is a function from $b$'s branches to $c$'s branches;
  \item for all $1\leq i\leq |b|$,
  \begin{enumerate*}[label=(\roman*)]
  \item $m_i:c_{o(i)}\to b_i$ is an ab-morphism with top-level arrow $t_i$ and 
	\item there is a section $s_i:R^c\to R^b$ for $t$ (meaning $s_i;t=\id$),
    \end{enumerate*}
	such that $s_i;a^b_i=t;a^c_{o(i)}$.
\end{itemize}
\end{definition}
%
Hence, a morphism consists of a \emph{top} arrow $t$ from the root of the source condition to that of the target condition, and for each branch $p^b_i$ of the source condition a \emph{backward} morphism $m_i$ from the subcondition of a branch $p^c_{o(i)}$ of the target condition to the subcondition of $p^b_i$, such that there is a section of $t$ making the square composed with the top arrow of $m_i$ commute.

Pictorially, $m$ can be visualised as in \fcite{ab-morphism}. We use $m:b\func c$ to denote that $m$ is an ab-condition morphism from $b$ to $c$, and $t^m$ to denote its top arrow (both of which notations were already used in the definition above). Note that if $|b|>0$, then $t_m$ is a retraction, as it must have at least one section.  The dashed arrows $s_1, \ldots, s_n$ are the required sections for $t$, one for each $1\leq i\leq |b|$: such sections don't need to be distinct.  

%
\begin{figure}
  \centering
  \input{figs/ab-morphism}
  \caption{Pictorial representation of an arrow-based condition morphism $m:b\func c$, with $b=(R^b,p^b_1\ccdots p^b_w)$ and $m = (t,o,m_1\ccdots m_w)$. For each $1 \leq i \leq w$, $s_i$ is the section of $t$ required by the definition.}
  \flabel{ab-morphism}
\end{figure}

\medskip\noindent Morphisms have the expected properties: identities and composition exist and the categorical laws are satisfied, thus arrow-based conditions and their morphisms form a category.
%

\begin{proposition}[category \cat{AB-Cond}]
  The category $\cat{AB-Cond}$ having arrow-based conditions (\dcite{ab-condition}) as objects and arrow-based condition morphisms (\dcite{ab-morphism}) as arrows is well-defined.
\end{proposition}
 
\begin{proof}
  Given an ab-condition $c=(R,\cB)$, the identity morphism $\id_c:c\func c$ is defined as $(\id_R,\setof{(p,\id_{c_p})}_{p\in \cB})$: the required commutativity trivially holds since $\id_R$ is a section for itself.
  
Given two ab-condition morphisms $m:b\func c$ and $n:c\func e$, their composition is defined as $m;n=(t^m;t^n,o^m;o^n,(n_{o^m(1)};m_1)\ccdots (n_{o^m(w)};m_{w}))$ (where $w=|b|$). The well-definedness of $m;n$ can be proved in a standard way, also considering that if $s_m$ is a section for $t_m$ and $s_n$ is a section for $t_n$, then $s_n;s_m$ is a section for $t_m;t_n$.

The identity laws and associativity of composition can be proved in a standard way. \qed
\end{proof}
%
With this notion of morphism, we have the desired preservation of satisfaction, in the following sense.

\begin{proposition}[ab-condition morphisms preserve satisfaction]
  \plabel{ab-preserve-satisfaction}
Let $b$ and $c$  be arrow-based conditions. If $m:b\func c$ is an ab-condition morphism, then $t^m;g\sat b$ implies $g \sat c$ for all arrows $g:R^c\func G$.
\end{proposition}
%
\emph{Proof.} By induction. Assume that for all $1\leq i\leq |b|$, the property holds for $m_i:c_{o(i)} \to b_i$. Let $p_i$ be the responsible branch and $h: P^b_i \to G$ the witness for $t_m;g\sat b$. 
Hence we have $(\dagger)\, t^m; g=a_i;h$ and $h \nsat c_i$.  Now let $q \in \cB_c$ be the source branch of $m_{p}$, and $s_i$ be the section for $t^m$ such that $(\star)\, s_i;a^b_i = a^c_{o(i)}; t_i$. 
We show that $p^c_{o(i)}$ itself is a responsible branch and $(\ddagger)\, h'=t_i;h$ a witness for $g\sat c$, namely that 
\begin{itemize}
\item $g = a^c_{o(i)};h'$: In fact, $a^c_{o(i)};h' =\!(\ddagger)\ a^c_{o(i)};t_i;h =\!(\star)\ s_i;r^b_i; h  =\!(\dagger)\ s_i;t^m;g = g$. 
\item $h' \nsat c_{o(i)}$: In fact, since there is an ab-condition morphism $m_i: c_{(o(i)} \to b_i$, if $h'= t_i;h \sat c_{o(i)}$ then by the induction hypothesis we can infer that $h \sat b_i$, contradicting the hypothesis. \qed
\end{itemize}

It is noteworthy that the arrows that satisfy $b$ and $c$ are not the \emph{same} ones --- in general they cannot be, as $b$ and $c$, having different roots, actually express properties of different domains (the arrows from $R^b$ and $R^c$, respectively). However, the morphism $m$ establishes $t^m:R^b\func R^c$, and the proposition then states that for any arrow from $R^b$ \emph{that factors through $t^m$}, satisfaction of $b$ (by that arrow) implies satisfaction of $c$ by ``the remainder after $t^m$''.


\subsubsection{Epi-based morphisms of nested conditions}

The definition of ab-condition morphisms of \dcite{ab-morphism} is strongly motivated by results presented later in the paper, but is by no means the only possible one. Still assuming that at each level arrows relating the roots of the conditions should flip direction, a possibly simpler definition of condition morphism is the following.  

\begin{definition}[simple arrow-based condition morphism]\dlabel{simple-morphism}
  Given two ab-conditions $b,c$, a \emph{simple ab-condition morphism} $m$ from $b$ to $c$ is a pair $(t,o,m_1\ccdots m_{|b|})$ such that $t:R^b\func R^c$ is an arrow and for all $1\leq i\leq |b|$, $m_i:c_{{o(i)}}\func b_i$ is a simple ab-condition morphism from the subcondition of branch $p^c_{o(i)}$ satisfying $(\star)\, t;a^c_{o)i)};t_i=r_i$. 
  A simple morphism is called \emph{epi-based} if all the arrows composing it (relating the roots of (sub)conditions) are epi. 
\end{definition}
%
Ab-conditions and simple condition morphism form a category denoted \cat{AB$^\to$-Cond}, and while by \cat{AB$^\twoheadrightarrow$-Cond} we denote the category having the same objects but only epi-based morphisms.  (and epi-based ones) inclide
In general, simple morphisms do not preserve satisfaction, as shown in the example \ref{non-surjective-mapping}. However, epi-based morphisms do preserve satisfaction. 


\begin{proposition}
  Let $b,c$ be arrow-based conditions. If $m:b\func c$ is an epi-based ab-condition morphism, then $t^m;g\sat b$ implies $g \sat c$ for all arrows $g:R^c\func G$.
  \end{proposition}
  %
  \emph{Proof.} By induction. Assume that for all $1\leq i\leq |b|$, the property holds for $m_i$. Let $p$ be the responsible branch and $h$ the witness for $t^m;g\sat b$; hence $(\dagger)\, t^m;g=a^b_i;h$ and $h\nsat c_i$. We show that $p^c_{o(i)}$ is a responsible branch and $(\ddagger)\, h'=t_i;h$ a witness for $t^m;g\sat p^c_{o(i)}$. In fact, 
  \begin{itemize}
  \item $g = a^c_{o(i)};h'$: for, $t^m;a^c_{o(i)};h' =\!(\ddagger)\, t^m;a^c_{o(i)};t_i;h =\!(\star)\, a^b_i; h =\!(\dagger)\, t^m;g$, from which  $g = a^c_{o(i)};h'$ follows because $t_m$ is epi. 
  \item $h'\nsat p^c_{o(i)}$: as in the proof of \pcite{ab-preserve-satisfaction}.\qed
  \end{itemize}
  %
Interestingly, even though both ab-condition morphisms (\dcite{ab-morphism}) and epi-based ones preserve satisfaction, they are incomparable as shown by examples \exref{epi-based morphism, no retraction} and~\exref{retraction based morphism, not epi}: if two conditions are related by one kind of morphisms they are not necessarily related by the other kind. 

Comparing the two definitions, note that retractions are epi in any category, but not vice versa: for example, in \cat{Graph} there are epis which don't have a section. Therefore asking for the existence of a section is a stronger condition than being an epi: however, existence of a section (in ab-morphisms) is not required when the source condition has no branchess. Instead the commutativity requirement in \dcite{simple-morphism} is stronger. In fact, if there is a section $s_i: R_c \to R_b$ for $t$, then  $t;a^c_{o(i)};t_i=a^b_i$ implies $s_i; a^b_i = a^c_{o(i)}; t_i$. 
