\section{Arrow-based conditions}
\slabel{ab-conditions}

In this section we recall the standard notion of nested condition from~\cite{Rensink-FOL}, using notations that will make the connection with the variation proposed in this paper as straightforward as possible. Here and in the remainder of the paper, we will mostly omit the term ``nested'' and just refer to \emph{conditions}; however, to distinguish between variations upon this theme, we will refer to the standard notion of nested conditions as \emph{arrow-based}.

Along the paper examples and intuitions will be based on $\cat{Graph}$, the category of directed, edge-labelled multigraphs. Let us introduce the formal definition, as well as some constructions and operations on graphs we will need later.

\begin{definition}[Category of Graphs]\label{def:graph-and-morphism}
  A \emph{graph}~$G = (V_G,E_G,s_G,t_G,\ell_G)$ has sets~$V_G$ of nodes and~$E_G$ of edges, along with source and target functions~$s_G,t_G\of E_G\to V_G$, and an edge-labeling function $\ell_G\of E_G \to \Lab$.\footnote{Without loss of generality we assume $V_G \cap E_G= \varnothing$.}
  A \emph{graph morphism}~$f:G\to H$ is a pair of functions~$f = (f_V\of V_G\to V_H, f_E\of E_G\to E_H)$ that preserve incidence (that is, $s_G; f_V = f_E;s_H$ and $t_G; f_V = f_E ; t_H$) and labels ($f_E;\ell_H = \ell_G$).
  Graphs and graph morphisms determine the category of graphs~$\cat{Graph}$.

  Given a set $X$, we denote by $\disc{X} = (X,\varnothing,\varnothing,\varnothing,\varnothing)$ the \emph{discrete graph} having $X$ as nodes; thus $\disc{\varnothing}$ denotes the empty graph. Given a function $f\of X \to Y$ and a subset $X' \subseteq X$, by $f\restr X'\of X' \to Y$ we denote the obvious restriction. Graph $G$ is a \emph{subgraph} of $H$, written $G \subseteq H$, if $V_G \subseteq V_H$, $E_G \subseteq E_H$, $s_G = s_H\restr E_G$, $t_G = t_H\restr E_G$ and $\ell_G = \ell_H\restr E_G$. If $g \of H \to K$ is a graph morphism and $G \subseteq H$, then $g \restr G \of G \to K$ is its restriction defined componentwise for nodes and edges.  

  Graphs $G$ and $H$ are \emph{disjoint} if $V_G \cap V_H = \varnothing = E_G \cap E_H$. In this case their \emph{union} is the (well-defined) graph $G \cup H$ defined in the expected way. Given morphisms $g\of G \to K$ and $h \of H \to K$, if $G$ and $H$ are disjoint we denote by $[g,h]\of G\cup H \to K$ the morphism defined as $[g,h](x) = g(x)$ if $x \in G$, and $[g,h](x) = h(x)$ if $x \in H$.\footnote{When not ambiguous we may omit some subscripts and use a graph name $G$ to denote the set of its items $V_G \cup E_G$.}\todo{AR: Later (e.g., \dcite{adding-nodes-to-condition}), we use $\cup$ for the union of morphisms; actually, I like that better.}
\end{definition}

Referring to a graph, we often write $\oneedgewithlab{x}{e}{a}{y}$ to say that edge $e$ is such that $\ell(e)= \la$, $s(e) = x$ and $t(e) = y$, and $\oneedge{x}{a}{y}$ if there is such an edge.

\medskip

Though examples will be based on $\cat{Graph}$, formal definitions and results will be phrased in terms of objects and arrows of a generic category $\bC$ that we assume to be a \emph{presheaf topos}, i.e., a category of contravariant functors from a small category \cat{S} to \cat{Set}, thus \cat{C} $= [\op{\cat{S}} \to \cat{Set}]$. Several categories of graphs and hypergraphs are presheaf toposes: for example, directed unlabeled graphs are obtained with \cat{S} the free category generated by $\mygraph{
  \node (1) {$\bullet$};
  \node (2) [right=of 1] {$\bullet$};
  \path (1) edge[bend left=20,->] (2)
        (1) edge[bend right=20,->] (2);
}$.\todo{Maybe say what $\Graph$ is as a presheaf topos?} Furthermore, presheaf toposes are closed under the construction of slice and functor categories, thus they include labeled/typed (hyper)graphs (see Sec.~5 of~\cite{AzziCR19}). We will denote the collection of objects of a category $\cat{C}$ by $|\cat{C}|$, and for $A,B \in |\cat{C}|$ we denote by $\cat{C}(A,B)$ the (hom)set of arrows from $A$ to $B$.  

Assuming that \cat{C} is a presheaf topos ensures several properties we need in the constructions of this paper: in particular, that all limits and colimits exist (and can be computed pointwise), and also that epis are stable under pullback. Furthermore, \cat{C} is \emph{adhesive}~\cite{ls:adhesive-journal}, enjoying several properties exploited in the algebraic theory of graph rewriting, where the results of this paper have potential interesting applications.\footnote{Note that requiring \cat{C} to be just adhesive would not suffice: for example, we need arbitrary pushouts, while adhesivity only guarantees pushouts along monos.}

\medskip\noindent
Arrow-based conditions are inductively defined as follows:

\begin{definition}[arrow-based condition]\dlabel{ab-condition}
  Let $R$ be an object of $\bC$. $\AC R$ (the set of \emph{arrow-based conditions} over $R$) and $\AB R$ (the set of \emph{arrow-based branches} over $R$) are the smallest sets such that
  \begin{itemize}
  \item $c\in \AC R$ if $c=(R,p_1\ccdots p_w)$ is a pair with $p_i\in \AB R$ for all $1\leq i\leq w$, where $w \geq 0$;
  \item $p\in \AB R$ if $p=(a,c)$ where $a: R\to P$ is an arrow of $\bC$ and $c\in \AC P$.
  \end{itemize}
\end{definition}
%
We regularly abbreviate ``arrow-based" to ``ab". We call $R$ the \emph{root} of an ab-condition or ab-branch, and $P$ the \emph{pattern} of an ab-branch (which is simultaneously the root of its subconditon). \fcite{ab-condition} provides a visualisation of an ab-condition $c$. We use $b,c$ to range over ab-conditions and $p,q$ to range over ab-branches. We use $|c|=w$ to denote the width of an ab-condition $c$, $R^c$ to denote its root, and $p^c_i=(a^c_i,c_i)$ its $i$-th branch. Finally, we use $P^c_i$ ($=R^{c_i}$) for the pattern of branch $p^c_i$. In all these cases, we may omit the superscript $c$ if it is clear from the context.
%
\begin{figure}[t]
\centering
\subcaptionbox
  {Condition $c=(R,p_1\ccdots p_w)$, with $p_i=(a_i,c_i)$ for $1\leq i\leq w$
   \flabel{ab-condition}}
  [.45\textwidth]
  {\input{figs/ab-condition}}
\quad
\subcaptionbox
  {$g\sat c$, with responsible branch $p_i=(a_i,c_i)$ and witness $h$ such that $g=a_i;h$
   \flabel{ab-satisfaction}}
  [.5\textwidth]
  {\input{figs/ab-satisfaction}}
\caption{Visualisations for arrow-based conditions}
\end{figure}

Note that, as a consequence of the inductive nature of \dcite{ab-condition}, every ab-condition has a finite \emph{depth} $\depth(c)$, defined as $0$ if $|c|=0$ and $1+\max_{1\leq i\leq |c|} \depth(c_i)$ otherwise. The depth will provide a basis for inductive proofs.

\begin{example}\exlabel{ab-conditions}
\fcite{ab-conditions} shows the graphical representation of three arrow-based conditions, rooted in the discrete one-node graph \inline{\onenode x}. The leftmost one, $c_1 \in \AC{\inline{\onenode x}}$, is defined according to \dcite{ab-condition} as 

$\begin{array}{ll}
c_1 = (\inline{\onenode x}, (f,c_{11})) & c_{11} = (\inline{\oneloopleft{x}{b}}, (g,c_{111})(h,c_{112}))\\
c_{111} = (\inline{\looponeedge{x}{b}{a}{y}}, \epsilon) & c_{112} = (\inline{\looponeedge{x}{b}{c}{y}}, \epsilon)
\end{array}$

\noindent
For the depths,  $\depth(c_{111}) = \depth(c_{112}) = 0$, $\depth(c_{11}) = 1$ and $\depth(c_1) = 2$.


Anticipating the correspondence with FOL discussed later, assuming that we already know the image of $x$ in a graph, the three conditions enjoy the following:
\begin{itemize}
\item $c_1$ is equivalent to $\lb(x,x)\wedge \neg \exists y\st(\la(x,y)\vee \lc(x,y))$
\item $c_2$ is equivalent to $\exists y\st \lb(x,y) \wedge \neg \la(y,y)\wedge \neg \exists z\st \lc(y,z)$ 
\item $c_3$ is equivalent to $\la(x,x)\vee (\exists y\st \lb(x,y) \wedge (\forall v,z\st \lc(y,v)\wedge \lc(y,z) \rightarrow v=z))$
\end{itemize}
%
Note that we have used variable names to represent nodes, to make the connection to the corresponding FOL properties more understandable. The morphisms are in all cases implied by the graph structure and variable names.
\qed
\end{example}
%
\begin{figure}[t]
\centering
\input{figs/ex-ab-conditions}
\caption{Examples of arrow-based conditions (see \excite{ab-conditions})}
\flabel{ab-conditions}
\end{figure}

\subsection{Satisfaction}

A condition expresses a property of arrows from its root to arbitrary objects. This is operationalised through the notion of \emph{satisfaction}.

\begin{definition}[satisfaction of arrow-based conditions]\dlabel{ab-satisfaction}
  Let $c$ be an ab-condition over $R$ and $g:R\to G$ an arrow from $c$'s root to some object $G$. We say that \emph{$g$ satisfies $c$}, denoted $g\sat c$, if there is a branch $p_i=(a_i,c_i)$ of $c$ and an arrow $h:P_i\to G$ such that
  \begin{enumerate}
  \item $g=a_i;h$ and
  \item $h\nsat c_i$.
  \end{enumerate}
\end{definition}
%
If $g\sat c$, we also say that $g$ is a \emph{model} for $c$. We call $p_i$ the \emph{responsible branch} and $h$ the \emph{witness} for $g\sat c$. Pictorially, $g\sat c$ with responsible branch $p_i$ and witness $h$ can be visualised as in \fcite{ab-satisfaction}.

Based on the notion of satisfaction, for ab-conditions $b$ and $c$ (over the same root) we  define \emph{semantic entailment} $b\entails c$ and \emph{semantic equivalence} $b\equiv c$:
%
\begin{align*}
b \entails c & \text{ if for all arrows $g$: } g\sat b \text{ implies } g\sat c \\
b \equiv c & \text{ if for all arrows $g$: } g\sat b \text{ if and only if } g\sat c \enspace. 
\end{align*}

\begin{example}\exlabel{ab-satisfaction}
Let us consider some models for the ab-conditions in \fcite{ab-conditions}.
\begin{itemize}[topsep=0pt]
\item Let $G_1=\myinlinegraph{
\node (1) {$\bullet$};
\node (2) [right=of 1] {$\bullet$};
\path (1) edge[bend left=20,->] node[near start,above] {\lb} (2)
      (2) edge[bend left=20,->] node[near start,below] {\lb} (1)
	  (1) edge[loop left,->] node[left] {\lc} (1);
}$
and let $g$ be the morphism from the one-node discrete graph \inline{\onenode x} to the left-hand node of $G_1$. It is clear that $g\nsat c_1$ because there is no witness for $c_{11}$ ($G_1$ does not have the required $\lb$-loop). Instead, we have $g\sat c_2$: the witness $h$ (for $c_{21}$) maps $y$ to the right-hand node of $G_1$; and $h$ does not satisfy the subconditions of $c_{21}$ because it cannot be extended with either the $\la$-loop specified by $c_{211}$ or the outgoing $\lc$-edge specified by $c_{212}$. Similarly, $g\sat c_3$.

\item Let $G_2=\myinlinegraph{
\node (1) {$\bullet$};
\node (2) [right=of 1] {$\bullet$};
\node (3) [right=of 2] {$\bullet$};
\path (1) edge[bend left=20,->] node[near start,above] {\lb} (2)
      (2) edge[bend left=20,->] node[near start,below] {\lb} (1)
	  (1) edge[loop left,->] node[left] {\la} (1)
      (2) edge[->] node[above] {\lc} (3);
	  }$
and let $g,g',g''$ be the morphisms from \inline{\onenode x} to $G_2$ mapping \inline{\onenode x} to the left, mid and right node of $G_2$, respectively. None of these models satisfy $c_1$, for the same reason as above. Moreover, none satisfy $c_2$: though $g$ and $g'$ have witnesses for $c_{21}$, these are ruled out by either $c_{212}$ (in the case of $g$) or $c_{211}$ (in the case of $g'$); $g''$ not even has a witness for $c_{21}$. Instead, both $g\sat c_3$ (in fact there are two distinct witnesses, one for $c_{31}$ and one for $c_{32}$) and $g'\sat c_3$ (due to $c_{32}$); but again $g''\nsat c_3$.

\item If $G_3=\inline{\oneloopleft \bullet b}$, then the only morphism $g$ from \inline{\onenode x} to $G_3$ has $g\sat c_1$, $g\sat c_2$ and $g\sat c_3$. 
\end{itemize}
In general, it can be checked that every model of $c_1$ is also a model of $c_2$ and every model of $c_2$ is a model of $c_3$, thus $c_1\entails c_2$ and $c_2 \entails c_3$. On the other hand, $c_2\nsat c_1$ as shown by $g:\inline{\onenode x}\to G_1$, and $c_3 \nsat c_2$ as shown by $g:\inline{\onenode x}\to G_2$.\qed
\end{example}

\subsection{Connection to first-order logic}
\label{sec:FOL}

It has been shown (e.g., \cite{Rensink-FOL,Habel-FOL}) that every first-order logic (FOL) formula on graphs can be encoded as an arrow-based nested condition over $\Graph$ and vice versa. For the sake of completeness, we summarise the connection here. We restrict to binary predicates, which we take from the set of edge labels $\Lab$. For the purpose of this discussion, w.l.o.g.\ we assume that graph nodes are variables, taken from a set $\Var$.\todo{Should we explicitly say something about the technical issues caused by the discrepancy between the treatment of free variables in FOL vs NC?}



\begin{definition}[graph formulas and satisfaction]
  \label{def:graph_formulas}
The set of \emph{(graph) formulas} is generated by the following grammar
%
\[ \phi \:::=\: \True
        \:\mid\: \False
		\:\mid\: \la(x_1,x_2)
        \:\mid\: x_1 \Eq x_2
		\:\mid\: \phi_1\wedge \phi_2
		\:\mid\: \phi_1\vee \phi_2
		\:\mid\: \neg\phi
		\:\mid\: \exists \bar x\st \phi 
		\:\mid\: \forall \bar x\st \phi 
		\]
where the $x_i$ are variables (from $\Var$), 
%$\bar x\in \Var^*$ 
$\bar x\subseteq \Var$ is a finite set of variables and $\la \in \Lab$ is a binary predicate. The set of \emph{free variables} of a formula $\phi$, denoted $\fv(\phi)$, is defined inductively in the usual way. When needed, without loss of generality we assume that the sets of free and bound variables of a formula are disjoint.  

The semantics of graph formulas is defined through a satisfaction relation, denoted $\sat^\FOL$, between graph morphisms and formulas. Given a formula $\phi$ and a graph morphism $g \of A \to G$, satisfaction is defined only if $\fv(\phi) \subseteq V_A$, inductively over the structure of $\phi$ as follows: 

\[\begin{array}{ll}
  g\sat^\FOL \True & \text{always} \\
  g\sat^\FOL \False & \text{never} \\
  g\sat^\FOL \la(x_1,x_2) & \iffdef \text{there is an edge } e\in E_G \text{ such that } g_V(x_1) \stackrel{e:\la}{\longrightarrow} g_V(x_2)\\
  %  \text{ with } s(e)=g(x_1), \ell(e)=\la, t(e)=g(x_2) \\
  g\sat^\FOL x_1\Eq x_2 & \iffdef g_V(x_1)=g_V(x_2) \\
  g\sat^\FOL \phi_1\wedge \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ and } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \phi_1\vee \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ or } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \neg\phi & \iffdef \text{not } g\sat^\FOL \phi \\
  g\sat^\FOL \exists X\st \phi  & \iffdef \text{ there is a graph $B$ such that $A \subseteq B$ and a morphism}\\ & \text{$h\of B\to G$ such that $h \restr A = g$ and $h \sat^\FOL \phi$}\hfill (\sat^\FOL \exists)\\
  g\sat^\FOL \forall X\st \phi  & \iffdef \text{ for each graph $B$ such that $A \subseteq B$ and for any morphism}\\ & \text{$h\of B\to G$, if  $h \restr A = g$ then $h \sat^\FOL \phi$}\enspace.\hfill (\sat^\FOL \forall)\\
  \end{array}
  \]

  If $g \sat^\FOL \phi$ holds, we call $g$ a \emph{model} of $\phi$. 
\end{definition}

Note that though satisfaction is defined for arbitrary graph morphisms, actually only their action on the nodes (which act as free variables) is relevant. This is expressed by the following lemma.

\begin{lemma}[satisfaction depends on free variables only]
  \label{lem:sat_only_free_vars}
  Let $f\of A \to G$ and $g\of B \to G$ be two morphisms and $\phi$ be a formula such that $f \sat^\FOL \phi$. If the following diagram commutes, where hooked arrows are graph inclusions, then also $g \sat^\FOL \phi$ holds.
  %\begin{center}
    \begin{equation}\label{eq:vars-only}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\phi)}$};
      \node  (A) [above right of=vars]{$A$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
      \node [below right of=vars] (B) {$B$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
    \end{tikzpicture}
    \end{equation}
   % \end{center} 
\end{lemma}

\begin{proof}[]
Note that $\fv(\phi) \subseteq V_B$ is guaranteed by the inclusion 
$\disc{\fv(\phi)} \hookrightarrow B$.
We proceed by induction on the structure of $\phi$. The statement is trivially true for $\phi \in \{\True, \False\}$. 

If $\phi = \neg \phi'$, suppose by absurd that $f \sat^\FOL \phi$ and $g \not \sat^\FOL \phi$: then $g  \sat^\FOL \phi'$. Since $\fv(\phi') = \fv(\phi)$ and given the symmetric role of $f$ and $g$ in the statement, by induction hypothesis we get $f \sat^\FOL \phi'$, a contradiction.

If $\phi = \la(x_1,x_2)$, by $f \sat^\FOL \phi$ there is an edge $e \in E_G$ such that  $f_V(x_1) \stackrel{e:\la}{\longrightarrow} f_V(x_2)$; since $f_V(x_i) = g_V(x_i)$ for $i \in \{1,2\}$ the same edge witnesses  $g \sat^\FOL \la(x_1,x_2)$. A similar argument applies if $\phi = x_1 \Eq x_2$.

If $\phi = \phi_1 \wedge \phi_2$, since $\fv(\phi_i) \subseteq \fv(\phi_1 \wedge \phi_2)$ for $i \in \{1,2\}$, from the square to the right in \eqref{vars-only-and} we get the outer commuting square for  $i \in \{1,2\}$. Since $f \sat^\FOL \phi_1 \wedge \phi_2$ implies $f \sat^\FOL \phi_i$, by induction hypothesis we get $g \sat^\FOL \phi_i$ for  $i \in \{1,2\}$, hence $g \sat^\FOL \phi_1 \wedge \phi_2$. A similar argument applies if $\phi = \phi_1 \vee \phi_2$.

%\begin{center}
  \begin{equation}\label{eq:vars-only-and}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node [left of =vars,node distance = 3 cm] (vari) {$\disc{\fv(\phi_i)}$};
    \node (vars) {$\disc{\fv(\phi_1 \wedge \phi_2)}$}
    edge [<-right hook] (vari);
    \node  (A) [above right of=vars]{$A$}
    edge [<-right hook] (vari)
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
    \node [below right of=vars] (B) {$B$}
    edge [<-right hook] (vars) 
    edge [<-right hook] (vari)
    edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
  \end{tikzpicture}
\end{equation}
%  \end{center}

Let $\phi = \exists X\st \phi'$, and assume w.l.o.g.~that $X \cap V_A = X \cap V_B = \varnothing$. From $f \sat^\FOL \phi$ we know that there is a graph $A' \supseteq A$ and a morphism $f': A' \to G$ such that $f'\restr A = f$ and $f' \sat^\FOL \phi'$ (thus $\fv(\phi') \subseteq V_{A'}$), as shown in \eqref{vars-only-exists}. Recall that $\fv(\exists X\st \phi') \stackrel{\mathit{def}}{=} \fv(\phi') \setminus X$, thus $\fv(\exists X\st \phi') \subseteq \fv(\phi')$. 
Define $B' = B \cup \disc{\fv(\phi')\cap X}$ and $g'\of B' \to G$ as  $g'(x) = g(x)$ if $x \in V_B \cup E_B$, and $g'(x) = f'(x)$ if $x \in \fv(\phi')\cap X$. 
Well-definedness of $g'$ follows by the assumption that $X \cap V_B = \varnothing$. 
Now we can apply the induction hypothesis to the inner square:  $f' \sat^\FOL \phi'$ implies $g' \sat^\FOL \phi'$. Clearly, $B \subseteq B'$ and $g'\restr B = g$ hence $g \sat^\FOL \exists X\st \phi'$, as desired.


\begin{equation}
\label{eq:vars-only-exists}
\begin{tikzpicture}
  \node at ( 3,0) (G) {$G$};
  \node at ( 0,2) (A)  {$A$}
  edge [->] node[auto] {$\scriptstyle{f}$} (G);
  \node at ( 0,-2) (B) {$B$}
  edge [->] node[auto, swap] {$\scriptstyle{g}$} (G);
  \node at ( 0,1) (A') {$A'$}
  edge [<-right hook] (A)
  edge [->] node[auto,swap] {$\scriptstyle{f'}$} (G);
  \node at ( 0,-1) (B') {$B \cup \disc{\fv(\phi')\cap X}$}
  edge [<-right hook] (B)
  edge [->] node[auto] {$\scriptstyle{g'}$} (G);
  \node at (-5,0) (fv-ex) {$\disc{\fv(\exists X\st \phi')}$}
  edge [right hook->] (A) 
  edge [left hook->] (B);
  \node at (-2,0) (fv-phi) {$\disc{\fv(\phi')}$}
  edge [right hook->] (A')
  edge [left hook->] (B')
  edge [<-right hook] (fv-ex);
\end{tikzpicture}
\end{equation}

For $\phi = \forall X \st \phi'$ the statement follows from the previous points by observing that $g \sat^\FOL \forall X \st \phi' \Leftrightarrow g \sat^\FOL \neg (\exists X \st \neg \phi')$. \qed
% $\ell_G(e)= \la$, and  
\end{proof}

  %
 % Note that the last clause\todo{AR: is $X\subseteq N_B$ necessary in that clause?} requires that $\ctx{N_A}{\exists X\st \phi}$ is a {\cfor}, which implies that $X \cap \bv(\phi) = \emptyset$.


% Just as for conditions, the semantics of FOL is defined through a notion of satisfaction; however, the models are not arbitrary arrows in $\Graph$ but \emph{valuations} that map variables to the nodes of a graph. Such a valuation can be seen as an arrow from the discrete graph with node set $X\subseteq \Var$, here denoted $D_X$. Hence, the models of a formula $\phi$ are arrows $v:D_X\to G$ (for some $X\supseteq \fv(\phi)$ and some graph $G$) such that $v\sat^\FOL \phi$. For an arbitrary graph $A$ with node set $V_A$, let $v_A:D_{V_A}\to A$ map the discrete graph over $V_A$ to $A$.

\subsubsection{From ab-conditions to formulas.}

Taking inspiration from Theorem 1 of \cite{Rensink-FOL}, but departing slightly because of the different notation, let us show how can we obtain for every arrow-based condition $c\in \AC{R}$ a $\FOL$ formula $\phi_c$ (with $\fv(\phi_c)\subseteq V_R$) having the same models, i.e.\ such that $g\sat c$ iff $g\sat^\FOL \phi_c$ for any arrow $g\of R\to G$. To avoid variable capture, it is convenient to consider ab-conditions which are \emph{well formed}, that is such that all graphs appearing in them have pairwise disjoint sets of nodes and of edges. Without loss of generality, we can always assume that an ab-condition is well formed, because we can rename node and edge identities up to isomorphism.

\begin{definition}[encoding ab-conditions as $\FOL$ formulas]
  \label{def:encoding}
  Given a graph $R = (V_R, E_R, s_R, t_R, \ell_R)$, its $\FOL$ encoding is the formula   
\begin{equation}
	\psi_R = %\textstyle
% \bigwedge_{x\in V_P}{x=x} \wedge
 \bigwedge_{e\in E_R} \ell_R(e)\bigl(s_R(e),t_R(e)\bigr)\label{eq:psiR}
\end{equation}
Given a well-formed ab-condition $c\in \AC R$ with $c=(R,(a_1,c_1)\ccdots (a_w,c_w))$ and $a_i:R \to P_i$ for each $i \in \{1, \ldots, w\}$, its $\FOL$ encoding is the formula 
\begin{align}
	\phi_c = %\textstyle
  \bigvee_{i\in \{1,\ldots,w\}} \left(\exists V_{P_i}\st \psi_{P_i} \land  \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x)\right) \land  \neg \phi_{c_i}\right)\label{eq:phiC}
\end{align}
\end{definition}

\begin{figure}[t]
  \centering
\begin{tikzpicture}[on grid]
  \node[graph] (10) {\onenode{x}};
  \node[left=0 of 10.west,inner sep=0] {$c$};
  \node[graph,below=of 10] (11) {\oneloopleft{x_1}{b}}; 
  \node[left=0 of 11.west,inner sep=0] {$c_{1}$};
  \node[graph,below left=1 and 1.1 of 11] (111) {\looponeedge{x_2}{b}{a}{y_2}};
  \node[above right=0 of 111.north west,inner sep=1] {$c_{2}$};
  \node[graph,below right=1 and 1.1 of 11] (112) {\looponeedge{x_3}{b}{c}{y_3}};
  \node[above left=0 of 112.north east,inner sep=1] {$c_{3}$};

  \path (10) edge[->] node[left] {$f$} (11)
        (11) edge[->] node[left] {$g$} (111)
        (11) edge[->] node[right] {$h$}(112);
\end{tikzpicture}
\caption{A well-formed ab-condition equivalent to $c_1$ of Example~\ref{ex:ab-conditions}}
\label{ab-condition-c}
\end{figure}


\begin{example}[formula associated with a condition]
As an example, let's detail the formula $\phi_{c}$ associated with the condition $c$ of Figure~\ref{ab-condition-c}, a well-formed variant of condition $c_1$ of Example~\ref{ex:ab-conditions}.  We use the names $c,c_1,c_2$ and $c_3$ to denote both the graphs they are attached to, and the conditions rooted at them.

For the four graphs, using \eqref{psiR}, we obtain:

$
\begin{array}{ll}
\psi_{c} &= \True\\
\psi_{c_{1}} &= \lb(x_{1},x_{1})\\
\psi_{c_{2}} &= \lb(x_{2},x_{2})\land \la(x_{2},y_{2})\\ 
\psi_{c_{3}} &= \lb(x_{3},x_{3})\land \lc(x_{3},y_{3})\\
\end{array}
$

\medskip
Now let us consider the four conditions, using \eqref{phiC}, bottom-up: 

$
\begin{array}{ll}
\phi_{c_{2}} & = \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
\phi_{c_{3}} & =  \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
 \phi_{c_{1}} & = (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2} \land \neg \phi_{c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3} \land \neg \phi_{c_{3}})\\
 \phi_{c} & = \exists \{x_{1}\}\st \psi_{c_{1}} \land x \Eq x_{1} \land  \neg \phi_{c_{1}}
\end{array}
$

\medskip
We can simplify $\phi_{c_1}$ as follows: 

$
\begin{array}{ll}
 \phi_{c_{1}} & = (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2} \land \neg \phi_{c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3} \land \neg \phi_{c_{3}})\\
  & \equiv \{\text{replacing $\phi_{c_{2}}$ and $\phi_{c_{3}}$ with their values ($\False$) and evaluating}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3})\\
 & \equiv \{\text{replacing $\psi_{c_{2}}$ and $\psi_{c_{3}}$ with their values}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st \lb(x_{2},x_{2})\land \la(x_{2},y_{2}) \land x_{1} \Eq x_{2})\quad \vee \\
 & \qquad \qquad (\exists \{x_{3},y_{3}\} \st  \lb(x_{3},x_{3})\land \lc(x_{3},y_{3}) \land x_{1} \Eq x_{3})\\
& \equiv \{\text{applying the \emph{singleton law} twice (see \eqref{singleton}), eliminating $x_2$ and $x_3$}\}\\
& \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{3}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{3}))\\
& \equiv \{\text{$\alpha$-conversion, $\exists$ distributes over $\vee$}\}\\
% & \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{2}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{2}))\\
& \equiv \exists \{y\} \st (\lb(x_{1},x_{1})\land \la(x_{1},y)) \lor ( \lb(x_{1},x_{1})\land \lc(x_{1},y))\\
& \equiv \exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y))\\
\end{array}
$

\medskip
The \emph{singleton law} is the following logical equivalence, where $P[^y/_x]$ is formula $P$ where all free occurrences of $x$ are replaced by $y$: 
\begin{equation}
\exists x\st x \Eq y \wedge P \quad \equiv \quad P[^y/_x] \label{eq:singleton}
\end{equation} 
It allows to get rid of an existential quantifier when the quantified variable is equated to a term. As it can be grasped from the current example, this law  has a relevant role in simplifying formulas associated with conditions, because they contain several existentials.

\medskip
Finally for $\phi_c$ we obtain:

$
\begin{array}{ll}
\phi_{c} & = \exists \{x_{1}\}\st \psi_{c_{1}} \land x \Eq x_{1} \land  \neg \phi_{c_{1}}\\
 & \equiv \{\text{replacing $\psi_{c_{1}}$ and $\phi_{c_{1}}$ with their values}\}\\
& \equiv \exists \{x_{1}\}\st\lb(x_{1},x_{1}) \land x \Eq x_{1} \land  \neg (\exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y)))\\
 & \equiv \{\text{eliminating $x_1$ by the singleton law}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \lb(x,x)\land (\la(x,y) \lor \lc(x,y)))\\
 & \equiv \{\text{standard but lengthy manipulation}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \la(x,y) \lor \lc(x,y))\\
\end{array}
$


which is indeed the $\FOL$ formula anticipated in Example~\ref{ex:ab-conditions}.


\end{example}


As shown below formally, a graph morphism $g: R \to G$ satisfies an ab-condition $c$ according to \dcite{ab-satisfaction} if and only if it satisfies $\phi_c$ according to \dcite{encoding}. Intuitively, in the formula $\phi_c$ defined in~\eqref{phiC}, the disjunction means that there is a branch $i$ such that there is a morphism $h: P_i \to G$ (by $\psi_{P_i}$), where  $\bigwedge_{x \in V_{R}} x \Eq a_i(x)$ guarantees $g=a_i;h$, and finally $\neg \phi_{c_i}$ ensures $h\nsat c_i$. Let's analise all this in detail.


Considering formula \eqref{psiR}, note that $\fv(\psi_R) \subseteq V_R$, and the free variables are exactly all the non-isolated nodes of $R$.\footnote{A node is \emph{isolated} if it is neither the source nor the target of any edge.} Formula $\psi_R$ represents the structure of graph $R$ in the following sense.
\begin{lemma}[properties of $\psi_R$]
  \label{lem:psi-R}
Given a morphism $m: A \to G$ with $G$ not empty and a graph $R$, let $\psi_R$ be defined as in \eqref{psiR}. Then the following are equivalent:
\begin{enumerate} 
  \item $m \sat^\FOL \psi_R$;
  \item $\fv(\psi_R) \subseteq V_A$ and there is a morphism $j \of R \to G$ such that for each $x \in \fv(\psi_R)$ it holds that $m_V(x) = j_V(x)$;
  \item there is a morphism $j \of R \to G$ such that the following diagram commutes:\todo{Do we need both clauses 2 and 3? They are so obviously equivalent}
\begin{center}
\begin{tikzpicture}[auto,node distance = 1.5cm]
  \node (vars) {$\disc{\fv(\psi_R)}$};
  \node  (A) [above right of=vars]{$A$}
  edge [<-right hook] (vars);
  \node [below right of=A] (G) {$G$}
  edge [<-] node[auto,swap] {$m$} (A);
  \node [below right of=vars] (R) {$R$}
  edge [<-right hook] (vars) 
  edge [->] node[auto,swap] {$j$} (G); 
\end{tikzpicture}
\end{center} 
\end{enumerate}
\end{lemma}

\begin{proof}[]
\begin{description}
\item [($2 \Leftrightarrow 3$)] is obvious, by the definition of the discrete graph $\disc{\fv(\psi_R)}$.
\item [($1 \Rightarrow  2$)] 
%Let $e \in E_R$ with $s_R(e)=x$, $t_R(e) = y$ and $\ell_R(e)= \la$. Clearly $x,y \in \fv(\psi_R)$ and thus $\{x,y\} \in V_A$ by definition of satisfaction. Then define $j_V(x) = m_V(x)$, $j_V(y) = m_V(y)$, and $j_E(e) = e'$ where $e' \in E_G$ is the edge witnessing that $m \sat^\FOL \la(x,y)$. Repeating this for all edges in $E_R$ defines morphism $j\of R \to G$ on all edges and non-isolated nodes of $R$

First, observe that $\fv(\psi_R) \subseteq V_A$ by  definition of satisfaction. Then define $j\of R \to G$ as follows:
\begin{itemize}
\item $j_V(x) = m_V(x)$ for each non-isolated $x \in V_R$. This is well-defined because $x \in \fv(\psi_R)$.
\item  $j_V(x)$ is defined arbitrarily if $x$ is isolated in $R$: this is possible because $G$ is not empty.
\item For each $e \in E_R$, $j_E(e) = e'$ where $e' \in E_G$ is an edge of $G$ witnessing that $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$.
\end{itemize}
The well-definedness of morphism $j$ and the fact that it satisfies condition 2 are obvious by construction. 
\item [($2 \Rightarrow  1$)] Given 2, we have to show that for each $e \in E_R$, $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$, that is, there is an edge $e' \in E_G$ with $s_G(e') = m_V(s_R(e))$, $t_G(e') = m_V(t_R(e))$ and $\ell_G(e') = \ell_R(e)$. Since $s_R(e),t_R(e) \in \fv(\psi_R)$, they also belong to $V_A$ by hypothesis. Then it is easy to check that setting $e' = j_E(e)$ the required conditions are satisfied. Indeed, $m_V(s_R(e)) = j_V(s_R(e)) = s_G(j_E(e)) = s_G(e')$, similarly for $m_V(t_R(e))$, and $\ell_G(e') = \ell_G(j_E(e)) = \ell_R(e)$.
\end{description}
\end{proof}

We can show now that an ab-condition $c$ and the corresponding formula $\phi_c$, as defined in \eqref{phiC}, have exactly the same models.

\begin{proposition}[properties of $\phi_c$]
  \label{pr:same-models}
  Let $c\in \AC R$ be an ab-condition over $R$ and $\phi_c$ be its $\FOL$ encoding as for Definition~\ref{def:encoding}. Given a graph morphism $g: R \to G$ we have
  \[ g \sat c \qquad \iff \qquad g \sat^\FOL \phi_c\enspace.\] 
\end{proposition}

\begin{proof}[]
Let $c=(R,(a_1,c_1)\ccdots(a_w,c_w))$. We proceed by induction on the depth. If $\depth(c) = 0$ we trivially have that neither $c$ nor $\phi_c = \False$ have any model.

Now assume that $\depth(c) = n$ and that the statement holds for any $c'$ with $\depth(c')<n$.

\paragraph{(Only if case - $\Rightarrow$)}

Suppose that $g \sat c$ with responsible branch $p_j = (a_j,c_j)$, with $j \in \{1, \ldots, w\}$, and witness $h\of P_j \to G$. By \dcite{ab-satisfaction} we have $(\dagger)~ a_j;h = g$ and $(\ddagger)~ g \not \sat c_j$.
%
We show \eqref{g-sat-exists}, from which the statement follows: 
\begin{equation}
  \label{eq:g-sat-exists}
g\sat^\FOL \exists V_{P_j}\st \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}
\end{equation}

Assuming w.l.o.g.~that $R\cap P_j = \varnothing$, let $R \stackrel{in_1}{\hookrightarrow} R \cup P_j$ be the obvious inclusion, and let $R\cup P_j \stackrel{[g,h]}{\longrightarrow} G$ be the only morphism induced by $g$ and $h$. To prove  \eqref{g-sat-exists} we show that 

\begin{equation}
[g,h] \sat^\FOL \psi_{P_j} \wedge \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x) \right) \land \neg \phi_{c_i}
\end{equation}
\noindent
by considering in turn the three conjuncts, from which \eqref{g-sat-exists} follows by $(\sat^\FOL \exists)$.
% \renewcommand{\labelenumi}{\alph{enumi})} 
\begin{enumerate}
  \item $[g,h] \sat^\FOL \psi_{P_j}$. By Lemma~\ref{lem:psi-R}, this follows from the following commuting diagram: 
\begin{center}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node (vars) {$\disc{\fv(\psi_{P_j})}$};
    \node  (A) [above right of=vars]{$R\cup P_j$}
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$[g,h]$} (A);
    \node [below right of=vars] (R) {$P_j$}
    edge [<-right hook] (vars) 
    edge [->] node[auto,swap] {$h$} (G); 
  \end{tikzpicture}
  \end{center} 
  \item $[g,h] \sat^\FOL \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x) \right)$. Let $x \in V_{R}$. %Clearly, $a_j(x) \in V_{P_j}$ for each $x \in V_{R}$. 
  Then $[g,h](x) \stackrel{x\in R}= g(x) \stackrel{(\dagger)}= a_j;h(x) = h(a_j(x)) \stackrel{a_j(x) \in P_j}= [g,h](a_j(x))$. Hence $[g,h] \sat^\FOL x \Eq a_j(x)$. 
  \item $[g,h] \sat^\FOL \neg \phi_{c_j}$. By Lemma~\ref{lem:sat_only_free_vars}, given the following commuting diagram it is sufficient to show that $h\sat^\FOL \neg \phi_{c_j}$.
  \begin{equation}\label{eq:vars-only-2}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\neg \phi_{c_j})}$};
      \node  (A) [above right of=vars]{$P_j$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{h}$} (A);
      \node [below right of=vars] (B) {$R \cup P_j$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{[g,h]}$} (G); 
    \end{tikzpicture}
    \end{equation}
  
  Indeed, since $(\ddagger)~h \not \sat c_j$ by assumption and $\depth(c_j) < n$, by induction hypothesis we have $h\not\sat^\FOL \phi_{c_j}$, i.e., $h\sat^\FOL \neg \phi_{c_j}$. 
\end{enumerate}

\paragraph{(If case - $\Leftarrow$)}
Let $g\of R \to G$ be a morphism and assume that $g \sat^\FOL \phi_c$. Let $j \in \{1,\ldots,w\}$ be such that
\[g\sat^\FOL \exists V_{P_j}\st \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}\]

As expected, $(a_j, P_j)$ will be the responsible branch for $g \sat c$: we have to find a witness morphism from $P_j$ to $G$.
By $(\sat^\FOL \exists)$ there is  graph $B$ (see \eqref{proof4})  with $R \subseteq B$ and a morphism $k\of B \to G$ such that $k\restr R = g$ and 

\[k \sat^\FOL \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}\]

\begin{equation}
  \label{eq:proof4}
  \begin{tikzpicture}[node distance = 2cm]
    \node at (2,0.5) (G) {$G$};
    \node at (0,0) (B) {$B$}
    edge [->] node[auto] {$\scriptstyle{k}$} (G);
    \node at (0,-1) (Pj) {$P_j$}
    edge [->] node[auto,swap]  (h) {$\scriptstyle{h}$}  (G);
    \node at (0,1) (R) {$R$}
    edge [right hook->] (B)
    edge [->] node[auto] {$\scriptstyle{g}$} (G)
    edge [->,bend angle=45,bend right] node[auto,swap] {$\scriptstyle{a_j}$} (Pj);
    \node at (-2,-0.5) (vars) {$\disc{\fv(\psi_{P_j})}$}
    edge [right hook->] (B)
    edge [right hook->] (Pj);
  \end{tikzpicture}
  \end{equation}   

Since $k \sat^\FOL \psi_{P_j}$, by Lemma~\ref{lem:psi-R} there is a morphism $h: P_j \to G$ such that the lower square in \eqref{proof4} commutes. Note that the action of $h$ is uniquely determined on the free variables of $\psi_{P_j}$, i.e.~on the non-isolated nodes of $P_j$. 

% Since $k \sat^\FOL \bigwedge_{x \in V_{R}} x \Eq a_j(x)$ we have that $\{a_j(x) \mid x \in V_R\}\subseteq V_B$.  Define $h': P_j \to G$ as follows: $h'(y) = k(y)$ if $y = a_j(x)$ for some $x \in V_R$ and $y$ is isolated in $P_j$, $h'(y) = h(y)$ otherwise. Note that for each $x \in V_R$, $h'(a_j(x)) = k(a_j(x))$.

% Let us show that $a_j;h' = g$. Let $x \in V_R$. Since $k \sat^\FOL x \Eq a_j(x)$, we have $g(x) = k(x) = k(a_j(x)) = h'(a_j(x))$.

% To conclude, we show that from $h'$ we can obtain a witness $h''$  for $g \sat c$, i.e.~such that $a_j;h'' = g$ and $h' \not \sat c_j$. We know that $k \sat^\FOL \neg \phi_{c_j}$, thus  $\fv(\phi_{c_j}) \subseteq V_{B}$ and clearly $\fv(\phi_{c_j}) \subseteq V_{P_j}$. However, for some $x \in \fv(\phi_{c_j})$ we could have $k(x) \neq h'(x)$ in case $x$ is isolated in $P_j$ and is not in the image of $a_j$. Thus define $h'': P_j \to G$ as follows:  $h''(y) = k(y)$ if $y \in \fv(\phi_{c_j})$ and  $y$ is isolated in $P_j$, $h''(y) = h'(y)$ otherwise. Note that for each $x \in V_R $ we have $h''(a_j(x)) = h'(a_j(x))$, therefore $a_j;h'' = g$. Furthermore, for all $x \in \fv(\phi_{c_j})$ we have $h''(x) = k(x)$ by construction. Therefore by Lemma~\ref{lem:sat_only_free_vars}, since $k\sat^\FOL \neg \phi_{c_j}$ also $h''\sat^\FOL \neg \phi_{c_j}$. Since $\depth(c_j) < n$, by induction hypothesis $h'' \not \sat c_j$, which concludes the proof.

% \todo{I try to do it shorter}

We show that from $h$ we can obtain a witness $h'$  for $g \sat c$, i.e.~such that $a_j;h' = g$ and $h' \not \sat c_j$.
%
Since $k \sat^\FOL \bigwedge_{x \in V_{R}} x \Eq a_j(x)$ and $k \sat^\FOL \neg \phi_{c_j}$, 
we have that $\{a_j(x) \mid x \in V_R\} \cup \fv(\phi_{c_j}) \subseteq V_B$. Clearly also $\{a_j(x) \mid x \in V_R\} \cup \fv(\phi_{c_j}) \subseteq V_{P_j}$. Define $h': P_j \to G$ as follows: $h'(y) = k(y)$ if $y = a_j(x)$ for some $x \in V_R$ or $y \in \fv(\phi_{c_j})$ and $y$ is isolated in $P_j$, $h'(y) = h(y)$ otherwise. Note that by construction for each $x \in V_R$, $(\dagger)\ h'(a_j(x)) = k(a_j(x))$ and for each $x \in \fv(\phi_{c_j})$ we have $(\ddagger)\ h'(x) = k(x)$. 

Let us show that $a_j;h' = g$. Let $x \in V_R$. Since $k \sat^\FOL x \Eq a_j(x)$ and using $(\dagger)$, we have $g(x) = k(x) = k(a_j(x)) = h'(a_j(x))$. Furthermore, by Lemma~\ref{lem:sat_only_free_vars} and $(\ddagger)$, since $k\sat^\FOL \neg \phi_{c_j}$  also $h'\sat^\FOL \neg \phi_{c_j}$. Since $\depth(c_j) < n$, by induction hypothesis $h' \not \sat c_j$, which concludes the proof.

\qed
\end{proof}

\subsubsection{From formulas to ab-conditions.} The other way around, we show that every $\FOL$ formula generated by the grammar of Def.~\ref{def:graph_formulas} can be encoded as an ab-condition having exactly the same models. Since $g:A \to G \sat^\FOL \phi$ implies that $V_A$ contains the free variables of $\phi$, the root graph of the ab-condition encoding $\phi$ must include $\fv(\phi)$ in the nodes, but can be larger. Therefore with each formula $\phi$ we associate an ``upward-closed'' set of ab-conditions $\abc{\phi}$, all having a discrete root including $\fv(\phi)$. 
To formalize this, we introduce an operation that adds fresh nodes to the root of a condition, intuitively copying them identically along all branches.

\begin{definition}[adding nodes to a condition]
  \label{def:adding-nodes-to-condition}
  Let $c = (R,(a_1,c_1)\ccdots (a_w,c_w))$ be an ab-condition, and $J$ be a non-empty, finite set disjoint from all graphs in $c$; in particular, $J \cap V_R = \varnothing$. Condition $c \uplus J$ is defined as $c \uplus J = (R \cup \disc{J}, (a_1 \cup id_{\disc{J}}, c_1 \uplus J)\ccdots(a_w \cup id_{\disc{J}}, c_w \uplus J))$. 

  A set of ab-conditions $\cC$ is \emph{upward closed} if for each $c \in \cC$ and non-empty finite set $J$,\todo{AR: disjoint from all graphs in $c$?} if $J \cap V_{R^c} = \varnothing$ then $c \uplus J \in \cC$.
\end{definition}

Note that $c$ and $c \uplus J$ are incomparable with respect to entailment because they have different roots. Nevertherless, it is easy to prove that  
for each morphism $m \of R \uplus \disc{J} \to G$,\todo{AC: explict proof? AR: I really think this is immediate}
\begin{eqnarray}
m \sat c \uplus J & \iff & m \restr R \sat c \eqlabel{eq:modRestricted}\\
m\sat^\FOL \phi_c & \iff & m \sat^\FOL \phi_{c\uplus J} \eqlabel{eq:condExpanded}
\end{eqnarray}

  
\begin{definition}[from formulas to ab-conditions]
  \label{def:from-formulas-to-ab-conditions}
The  \emph{set of ab-conditions encoding a formula $\phi$}, denoted $\abc{\phi}$, is the smallest upward-closed set determined by the following inductive clauses: 
\begin{enumerate}
\item 
If $\phi = \False$, then $(\disc{\varnothing}, \epsilon)\in \abc{\phi}$.
\item If $\phi = \True$, then $(\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))\in \abc{\phi}$.
\item 
If $\phi = x \Eq y$, then $(\disc{\{x,y\}}, (\{x\mapsto \bullet,y \mapsto \bullet\}, (\disc{\{\bullet\}},\epsilon))) \in \abc{\phi}$.\todo{AR: I would prefer $x$ or $y$ rather than $\bullet$}
\item 
If $\phi = \la(x,y)$, then $(\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon))) \in \abc{\phi}$.
\item 
If $\phi = \neg \phi'$ and $(R,p_1\ccdots p_w)\in \abc{\phi'}$ then $(R,(id_R, (R,p_1\ccdots p_w)))\in \abc{\phi}$.
\item 
If $\phi = \phi_1 \lor \phi_2$ and $(R,p_1\ccdots p_w)\in \abc{\phi_1}$, $(R,q_1\ccdots q_v) \in \abc{\phi_2}$ then $(R,p_1\ccdots p_wq_1\ccdots q_v) \in \abc{\phi}$.
\item 
If $\phi = \exists X \st \phi'$ and $(R,(a_1,c_1)\ccdots (a_w,c_w)) \in \abc{\phi'}$ then
$(R\setminus \disc{X},(i;a_1,c_1)\ccdots (i;a_w,c_w)) \in \abc{\phi}$, where $i\of R\setminus \disc{X} \hookrightarrow R$ is the inclusion. 
\item 
Finally, by exploiting the usual equivalences we define $\abc{\phi_1 \land \phi_2} = \abc{\neg (\neg \phi_1 \lor \neg \phi_2)}$ and $\abc{\forall X\st \phi} = \abc{\neg \exists X \st \neg \phi}$.
\end{enumerate}
\end{definition}

The correctness of this encoding is stated as follows.\todo{In this form, it does not emerge why we need the upward-closedness. I would like to include a corollary that states something for \emph{any} $g$; maybe $g \sat^\FOL \phi \iff \exists c\in C(\phi)\st g \sat c$?}

\begin{proposition}[properties of $\abc{\phi}$]
  \label{pr:same-models-2}
Given a formula $\phi$ and any ab-condition $c = (R, (p_1\ccdots p_w)) \in \abc{\phi}$, for each graph morphism $g \of R \to G$ we have

\[ g \sat^\FOL \phi \qquad \iff \qquad g \sat c \enspace.\] 

\end{proposition}
\begin{proof}[]
We show by induction on depth that given a condition $c \in \abc{\phi}$ the formulas $\phi$ and $\phi_{c}$ (as for Def.~\ref{def:encoding}) are logically equivalent. 
Since by Prop.~\ref{pr:same-models} $c$ and $\phi_{c}$ have the same models, the statement follows. Actually, given \eqref{eq:modRestricted} it is sufficient to prove $\phi \equiv \phi_{c}$ for the generators of sets $\abc{\phi}$ as defined in Def.~\ref{def:from-formulas-to-ab-conditions}.\todo{AC: explain better why?}

\begin{enumerate}
  \item 
  If $\phi = \False$, % then $(\varnothing, \epsilon)\in \abc{\phi}$.
  let $c = (\disc{\varnothing}, \epsilon)$. Then $\phi_c$ is an empty disjunction, which is $\False$.
  
  \item If $\phi = \True$, let $c = (\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists \varnothing\st \psi_{\disc{\varnothing}} \land \True' \land \neg \phi_{(\disc{\varnothing},\epsilon)} \equiv \True$. In fact  $\True'$ arises from an empty conjunction,  the existential over an empty set can be dropped, $\psi_{\disc{\varnothing}} = \True$ (see \eqref{psiR}), and $\phi_{(\disc{\varnothing},\epsilon)} = \False$ by the previous point.
  \item 
If $\phi = x \Eq y$, let $c = (\disc{\{x,y\}}, (\{x\mapsto \bullet,y \mapsto \bullet\}, (\disc{\{\bullet\}},\epsilon)))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists \{\bullet\} \st  \psi_{\disc{\{\bullet\}}} \land (x \Eq \bullet \land y \Eq \bullet) \land \neg \phi_{(\disc{\{\bullet\}},\epsilon)}$. Since $ \psi_{\disc{\{\bullet\}}} = \True$ (see \eqref{psiR}) and $\phi_{(\disc{\{\bullet\}},\epsilon)} = \False$ using point 1., $\phi_c$ is equivalent to $\exists \{\bullet\} \st  x \Eq \bullet \land y \Eq \bullet$, which in turn is equivalent to $x \Eq y$, as desired, by the singleton law~\eqref{singleton}.

\item 
If $\phi = \la(x,y)$, let  $c = (\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon)))$. Then $\phi_c  = \bigvee_{i \in \{1\}}  \exists \{x', y'\} \st  \psi_{\inline{\oneedge{x'}{a}{y'}}} \land (x \Eq x' \land y \Eq y' \land \neg \phi_{(\inline{\oneedge{x'}{a}{y'}},\epsilon)}$. We have $ \psi_{\inline{\oneedge{x'}{a}{y'}}}  = \la(x',y')$ by \eqref{psiR}, and  $\phi_{(\inline{\oneedge{x'}{a}{y'}},\epsilon)} = \False$ using point 1., thus $\phi_c \equiv \exists \{x', y'\} \st   \la(x',y') \land x \Eq x' \land y \Eq y'$. By a first application of the singleton law  $\phi_c \equiv \exists \{y'\} \st   \la(x,y')  \land y \Eq y'$, and by a second application $\phi_c \equiv \la(x,y)$, as desired.
\item 
If $\phi = \neg \phi'$ and $c' = (R,p_1\ccdots p_w)\in \abc{\phi'}$ then $(R,(id_R, c'))\in \abc{\phi}$. To avoid variable capturing, let $c'' = (R',p'_1\ccdots p'_w)$ be a renamed-apart version of $c'$ obtained by replacing each item $x$ with $x'$. Let $c = (R,(id'_R, c''))$, where $id'_R(x) = x'$.   Then $\phi_c = \bigvee_{i \in \{1\}}  \exists V_{R'} \st \psi_{R'} \land \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big) \land \neg \phi_{c''}$. Note that 
the effect of $\exists V_{R'} \st  \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big)$, by repeated applications of the singleton law, consists of applying the substition $x' \mapsto x$ to the remaining quantified formulas, i.e. $\psi_{R'} \land \neg \phi_{c''}$, thus obtaining $\phi_c \equiv \psi_{R} \land \neg \phi_{c'}$. Formula $\psi_{R}$ is trivially satisfied by any candidate model, which must be a morphism with $R$ as source, thus $\phi_c \equiv \neg \phi_{c'}$. By induction hypothesis, since $c' \in \abc{\phi'}$ we have $\phi' \equiv \phi_{c'}$, thus $\phi_c \equiv \neg \phi_{c'} \equiv \neg \phi' = \phi$, as desired.

% If $\phi = \neg \phi'$ and $c' = (R,p_1\ccdots p_w)\in \abc{\phi'}$, let $c = (R,(id_R, c'))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists V_R \st \psi_R \land \big(\bigwedge_{x \in V_R} x \Eq id_R(x)\big) \land \neg \phi_{c'}$. 
\item 
If $\phi = \phi_1 \lor \phi_2$, let $c_1 = (R,p_1\ccdots p_w) \in \abc{\phi_1}$, and $c_2 = (R,q_1\ccdots q_v) \in \abc{\phi_2}$. Let $c = (R,p_1\ccdots p_wq_1\ccdots q_v)$. We have to show that $\phi_c \equiv \phi_1 \lor \phi_2$. This is obvious, by exploiting the induction hypothesis ($\phi_1 \equiv \phi_{c_1}$ and $\phi_2 \equiv \phi_{c_2}$) and given that $\phi_c$ is a disjunction over the set of branches of $c$ (which is the union of branches of $c_1$ and $c_2$) of formulas that depend only on the branch itself and of the root graph $R$, which is the same for $c$, $c_1$ and $c_2$.
\item 
If $\phi = \exists X \st \phi'$ and $c' = (R,(a_1,c_1)\ccdots (a_w,c_w)) \in \abc{\phi'}$, let $c =  (R\setminus \disc{X},(i;a_1,c_1)\ccdots (i;a_w,c_w))$, where $i\of R\setminus \disc{X} \hookrightarrow R$ is the inclusion. We show that $\phi_c \equiv\exists X\st \phi_{c'}$, and conclude by induction hypothesis. Note that $\phi_c$ and $\phi_{c'}$ are almost identical, only differing for the conjuction of equalities, which ranges over $V_R$ in $\phi_{c'}$ ($\bigwedge_{x\in V_R} x \Eq a_i(x)$) and over $V_{R\setminus \disc{X}} = V_R \setminus X$ in $\phi_{c}$ ($\bigwedge_{x\in {V_R\setminus X}} x \Eq a_i(x)$). By repeated applications of the singleton law one obtains that $\exists X\st \bigwedge_{x\in V_R} x \Eq a_i(x)\quad \equiv \quad \bigwedge_{x\in {V_R\setminus X}} x \Eq a_i(x)$.\footnote{For example, $\exists x\st x \Eq f(x) \wedge y \Eq f(y) \quad \equiv \quad  y \Eq f(y)[^{f(x)}/_x] \quad \equiv \quad  y \Eq f(y)$.}
Thus we can conclude observing that the existential quantification on $X$ in $\exists X\st \phi_{c'}$ can be pushed inside the disjunction (by a $\FOL$ law), and it does not affect the other formulas like $\psi_i$ or $\neg \phi_i$, assuming that the condition is well formed (therefore $X$ is disjoint from all the graphs in the branches).  
\end{enumerate}
\end{proof}


\todo{AC: Add example of condition $\abc{\phi}$ for a suitable $\phi$?}


\subsection{Connection to first-order logic [OLD, to be deleted]}
Theorems 1 and~3 of \cite{Rensink-FOL} state that
\begin{enumerate*}[label=\emph{(\roman*)}]
\item for every arrow-based condition $c\in \AC R$ there exists a formula $\phi_c$ with $\fv(\phi_c)=X_R$ such that $g\sat c$ iff $v_R;g\sat^\FOL \phi_c$ for any arrow $g\of R\to G$; and

\item for every FOL-formula $\phi$, there is an arrow-based condition $c_\phi$ with $R^{c_\phi}=\disc{\fv(\phi)}$ such that $v\sat^\FOL \phi$ iff $v\sat c_\phi$ for any valuation $v\of \disc{\fv(\phi)}\to G$.
\end{enumerate*}
The constructions of $\phi_c$ and of $c_\phi$ are given in detail in \cite{Rensink-FOL}.

\iffull
\todo[inline]{The story is currently not complete!}
This means that there is a technical hurdle: the models of a FOL formula are arrows from the discrete graph consisting of its free variables, whereas the models of a nested condition are arrows from their root, which can be an arbitrary graph. To overcome this hurdle, we will introduce the auxiliary notion of a \emph{context} in which a formula is evaluated, essentially consisting of already known facts (reflecting the role of the root object of a condition). In order to define contexts, we first identify a fragment of FOL with a strong relation to graphs.

\begin{itemize}
\item We call a formula $\rho$ \emph{regular} if it equals $\bigwedge_{i\in I} \pi_i$ for some finite set $I$, where for all $i\in I$, $\pi_i$ equals either $x_i=y_i$ or $\la_i(x_i,y_i)$ for some variables $x_i,y_i$ and binary predicate $\la_i$.

\item A regular formula $\rho$ gives rise to an equivalence ${\simeq_\rho}\subseteq \fv(\rho)\times \fv(\rho)$ defined as the smallest equivalence such that $x\simeq_\rho y$ for each conjunct $x=y$ in $\rho$.

\item A regular formula $\rho$ can be encoded as a graph $G_\rho$ with node set $[\fv(\rho)]/{\simeq_\rho}$, and an edge $e$ with $s_e=[x]_{\simeq_\rho}$, $\ell_e=\la$ and $t_e=[y]_{\simeq_\rho}$ for each conjunct $\la(x,y)$ in $\rho$.

\item Vice versa, a graph $G=\tupof{X,E}$ gives rise to the regular formula $\rho_G=\bigwedge_{x\in X} x=x \wedge \bigwedge_{e\in E} \ell_e(s_e,t_e)$.

\item Clearly, $\rho$ and $\rho_{G_\rho}$ are equivalent for any regular formula $\rho$.
\end{itemize}



The correspondence of FOL to (arrow-based) conditions hinges on the existence of a \emph{normal form} for FOL formulas.
%
\begin{itemize}
\item For two regular formulas $\rho=\bigwedge_{i\in I} \pi_i$ and $\rho=\bigwedge_{i\in I'} \pi'_i$, we say that $\rho'$ \emph{subsumes} $\rho$, denoted $\rho\sqsubseteq \rho'$, if for all $i\in I$ there is some $i'\in I'$ such that $\pi'_i=\pi'_{i'}$.

\item If $\rho'$ subsumes $\rho$, there is an obvious graph morphism from $G_\rho$ to $G_{\rho'}$ with node mapping $[x]_{\simeq_\rho}\mapsto [x]_{\simeq_{\rho'}}$, which is well-defined because ${\simeq_\rho}\subseteq {\simeq_{\rho'}}$.

\item A formula $\phi$ is in \emph{nested normal form} (NNF) if it equals $\bigvee_{j\in J} \exists X_j\st \rho_j\wedge\neg \phi_j$ for some finite index set $J$ (assumed to be of the form $\setof{1,\ldots,|J|}$), where for all $j\in J$:
\begin{itemize}
\item $X_j$ is a finite set of variables,
\item $\rho_j$ is a regular formula, and
\item $\phi_j$ is an NNF formula;
\end{itemize}
such that, moreover, all $X_j$ are disjoint from one another and also from $\fv(\phi)$.
\end{itemize}
%
A regular formula $\rho$ can be encoded as a graph $G_\rho$ with node set $[\fv(\rho)]/{\simeq_\rho}$, where $x_i\simeq_\rho y_i$ for each conjunct $x_i=y_i$ in $\rho$, and edges $([x_i]_{\simeq_\rho},\la,[y_i]_{\simeq_\rho})$ for each conjunct $\la(x_i,y_i)$ in $\rho$. If $\rho'$ subsumes $\rho$, there is an obvious graph morphism from $G_\rho$ to $G_{\rho'}$ with node mapping $[x]_{\simeq_\rho}\mapsto [x]_{\simeq_{\rho'}}$, which is well-defined because ${\simeq_\rho}\subseteq {\simeq_{\rho'}}$.

To formalise the connection between FOL formulas and nested conditions, we also need the concept of a \emph{context} for a formula $\phi$, which is a regular formula $\gamma$ such that $\fv(\phi)\subseteq \fv(\gamma)$. Clearly, the context of a formula is not fixed.
%
\begin{itemize}
\item An NNF formula $\phi=\bigvee_{j\in J} \exists X_j\st (\rho_j\wedge\neg \phi_j)$ is called \emph{saturated} with respect to a regular formula $\rho$ if $\rho$ is a context for $\phi$, and for all $j\in J$, $\rho\sqsubseteq \rho_j$ and $\phi_j$ is saturated with respect to $\rho_j$.
\end{itemize}
%
If $\rho$ is a regular formula and $\phi=\bigvee_{j\in J} \exists X_j\st \rho_j\wedge\neg \phi_j$ an NNF formula saturated with respect to $\rho$, then the corresponding arrow-based condition is given by
\[ c_{\rho,\phi}=(G_\rho,p_1\ccdots p_{|J|}) \text{ with } p_j=(a_j,c_{\rho_j,\phi_j}) \text{ for all $1\leq j\leq |J|$,}
\]
where $a_j$ is the morphism from $G_\rho$ to $G_{\rho_j}$ induced by $\rho\sqsubseteq \rho_j$.
\fi
