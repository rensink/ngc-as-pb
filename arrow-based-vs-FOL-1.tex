\section{Connection to first-order logic}
\label{sec:FOL}

It has been shown (e.g., \cite{Rensink-FOL,Habel-FOL}) that every first-order logic (FOL) formula on graphs can be encoded as an arrow-based nested condition over $\Graph$ and vice versa. For the sake of completeness, we summarise the connection here. We restrict to binary predicates, which we take from the set of edge labels $\Lab$. For the purpose of this discussion, w.l.o.g.\ we assume that graph nodes are variables, taken from a set $\Var$.\todo{Should we explicitly say something about the technical issues caused by the discrepancy between the treatment of free variables in FOL vs NC?}



\begin{definition}[graph formulas and satisfaction]
  \label{def:graph_formulas}
The set of \emph{(graph) formulas} is generated by the following grammar
%
\[ \phi \:::=\: \True
        \:\mid\: \False
		\:\mid\: \la(x_1,x_2)
        \:\mid\: x_1 \Eq x_2
		\:\mid\: \phi_1\wedge \phi_2
		\:\mid\: \phi_1\vee \phi_2
		\:\mid\: \neg\phi
		\:\mid\: \exists \bar x\st \phi 
		\:\mid\: \forall \bar x\st \phi 
		\]
where the $x_i$ are variables (from $\Var$), 
%$\bar x\in \Var^*$ 
$\bar x\subseteq \Var$ is a finite set of variables and $\la \in \Lab$ is a binary predicate. The set of \emph{free variables} of a formula $\phi$, denoted $\fv(\phi)$, is defined inductively in the usual way. When needed, without loss of generality we assume that the sets of free and bound variables of a formula are disjoint.  

The semantics of graph formulas is defined through a satisfaction relation, denoted $\sat^\FOL$, between graph morphisms and formulas. Given a formula $\phi$ and a graph morphism $g \of A \to G$, satisfaction is defined only if $\fv(\phi) \subseteq V_A$, inductively over the structure of $\phi$ as follows: 

\[\begin{array}{ll}
  g\sat^\FOL \True & \text{always} \\
  g\sat^\FOL \False & \text{never} \\
  g\sat^\FOL \la(x_1,x_2) & \iffdef \text{there is an edge } e\in E_G \text{ such that } g_V(x_1) \stackrel{e:\la}{\longrightarrow} g_V(x_2)\\
  %  \text{ with } s(e)=g(x_1), \ell(e)=\la, t(e)=g(x_2) \\
  g\sat^\FOL x_1\Eq x_2 & \iffdef g_V(x_1)=g_V(x_2) \\
  g\sat^\FOL \phi_1\wedge \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ and } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \phi_1\vee \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ or } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \neg\phi & \iffdef \text{not } g\sat^\FOL \phi \\
  g\sat^\FOL \exists X\st \phi  & \iffdef \text{ there is a graph $B$ such that $A \subseteq B$ and a morphism}\\ & \text{$h\of B\to G$ such that $h \restr A = g$ and $h \sat^\FOL \phi$}\hfill (\sat^\FOL \exists)\\
  g\sat^\FOL \forall X\st \phi  & \iffdef \text{ for each graph $B$ such that $A \subseteq B$ and for any morphism}\\ & \text{$h\of B\to G$, if  $h \restr A = g$ then $h \sat^\FOL \phi$}\enspace.\hfill (\sat^\FOL \forall)\\
  \end{array}
  \]

  If $g \sat^\FOL \phi$ holds, we call $g$ a \emph{model} of $\phi$. 
\end{definition}

Note that though satisfaction is defined for arbitrary graph morphisms, actually only their action on the nodes (which act as free variables) is relevant. This is expressed by the following lemma.

\begin{lemma}[satisfaction depends on free variables only]
  \label{lem:sat_only_free_vars}
  Let $f\of A \to G$ and $g\of B \to G$ be two morphisms and $\phi$ be a formula such that $f \sat^\FOL \phi$. If the following diagram commutes, where hooked arrows are graph inclusions, then also $g \sat^\FOL \phi$ holds.
  %\begin{center}
    \begin{equation}\label{eq:vars-only}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\phi)}$};
      \node  (A) [above right of=vars]{$A$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
      \node [below right of=vars] (B) {$B$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
    \end{tikzpicture}
    \end{equation}
   % \end{center} 
\end{lemma}

\begin{proof}[]
Note that $\fv(\phi) \subseteq V_B$ is guaranteed by the inclusion 
$\disc{\fv(\phi)} \hookrightarrow B$.
We proceed by induction on the structure of $\phi$. The statement is trivially true for $\phi \in \{\True, \False\}$. 

If $\phi = \neg \phi'$, suppose by absurd that $f \sat^\FOL \phi$ and $g \not \sat^\FOL \phi$: then $g  \sat^\FOL \phi'$. Since $\fv(\phi') = \fv(\phi)$ and given the symmetric role of $f$ and $g$ in the statement, by induction hypothesis we get $f \sat^\FOL \phi'$, a contradiction.

If $\phi = \la(x_1,x_2)$, by $f \sat^\FOL \phi$ there is an edge $e \in E_G$ such that  $f_V(x_1) \stackrel{e:\la}{\longrightarrow} f_V(x_2)$; since $f_V(x_i) = g_V(x_i)$ for $i \in \{1,2\}$ the same edge witnesses  $g \sat^\FOL \la(x_1,x_2)$. A similar argument applies if $\phi = x_1 \Eq x_2$.

If $\phi = \phi_1 \wedge \phi_2$, since $\fv(\phi_i) \subseteq \fv(\phi_1 \wedge \phi_2)$ for $i \in \{1,2\}$, from the square to the right in \eqref{vars-only-and} we get the outer commuting square for  $i \in \{1,2\}$. Since $f \sat^\FOL \phi_1 \wedge \phi_2$ implies $f \sat^\FOL \phi_i$, by induction hypothesis we get $g \sat^\FOL \phi_i$ for  $i \in \{1,2\}$, hence $g \sat^\FOL \phi_1 \wedge \phi_2$. A similar argument applies if $\phi = \phi_1 \vee \phi_2$.

%\begin{center}
  \begin{equation}\label{eq:vars-only-and}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node [left of =vars,node distance = 3 cm] (vari) {$\disc{\fv(\phi_i)}$};
    \node (vars) {$\disc{\fv(\phi_1 \wedge \phi_2)}$}
    edge [<-right hook] (vari);
    \node  (A) [above right of=vars]{$A$}
    edge [<-right hook] (vari)
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
    \node [below right of=vars] (B) {$B$}
    edge [<-right hook] (vars) 
    edge [<-right hook] (vari)
    edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
  \end{tikzpicture}
\end{equation}
%  \end{center}

Let $\phi = \exists X\st \phi'$, and assume w.l.o.g.~that $X \cap V_A = X \cap V_B = \varnothing$. From $f \sat^\FOL \phi$ we know that there is a graph $A' \supseteq A$ and a morphism $f': A' \to G$ such that $f'\restr A = f$ and $f' \sat^\FOL \phi'$ (thus $\fv(\phi') \subseteq V_{A'}$), as shown in \eqref{vars-only-exists}. Recall that $\fv(\exists X\st \phi') \stackrel{\mathit{def}}{=} \fv(\phi') \setminus X$, thus $\fv(\exists X\st \phi') \subseteq \fv(\phi')$. 
Define $B' = B \cup \disc{\fv(\phi')\cap X}$ and $g'\of B' \to G$ as  $g'(x) = g(x)$ if $x \in V_B \cup E_B$, and $g'(x) = f'(x)$ if $x \in \fv(\phi')\cap X$. 
Well-definedness of $g'$ follows by the assumption that $X \cap V_B = \varnothing$. 
Now we can apply the induction hypothesis to the inner square:  $f' \sat^\FOL \phi'$ implies $g' \sat^\FOL \phi'$. Clearly, $B \subseteq B'$ and $g'\restr B = g$ hence $g \sat^\FOL \exists X\st \phi'$, as desired.


\begin{equation}
\label{eq:vars-only-exists}
\begin{tikzpicture}
  \node at ( 3,0) (G) {$G$};
  \node at ( 0,2) (A)  {$A$}
  edge [->] node[auto] {$\scriptstyle{f}$} (G);
  \node at ( 0,-2) (B) {$B$}
  edge [->] node[auto, swap] {$\scriptstyle{g}$} (G);
  \node at ( 0,1) (A') {$A'$}
  edge [<-right hook] (A)
  edge [->] node[auto,swap] {$\scriptstyle{f'}$} (G);
  \node at ( 0,-1) (B') {$B \cup \disc{\fv(\phi')\cap X}$}
  edge [<-right hook] (B)
  edge [->] node[auto] {$\scriptstyle{g'}$} (G);
  \node at (-5,0) (fv-ex) {$\disc{\fv(\exists X\st \phi')}$}
  edge [right hook->] (A) 
  edge [left hook->] (B);
  \node at (-2,0) (fv-phi) {$\disc{\fv(\phi')}$}
  edge [right hook->] (A')
  edge [left hook->] (B')
  edge [<-right hook] (fv-ex);
\end{tikzpicture}
\end{equation}

For $\phi = \forall X \st \phi'$ the statement follows from the previous points by observing that $g \sat^\FOL \forall X \st \phi' \Leftrightarrow g \sat^\FOL \neg (\exists X \st \neg \phi')$. \qed
% $\ell_G(e)= \la$, and  
\end{proof}

  %
 % Note that the last clause\todo{AR: is $X\subseteq N_B$ necessary in that clause?} requires that $\ctx{N_A}{\exists X\st \phi}$ is a {\cfor}, which implies that $X \cap \bv(\phi) = \emptyset$.


% Just as for conditions, the semantics of FOL is defined through a notion of satisfaction; however, the models are not arbitrary arrows in $\Graph$ but \emph{valuations} that map variables to the nodes of a graph. Such a valuation can be seen as an arrow from the discrete graph with node set $X\subseteq \Var$, here denoted $D_X$. Hence, the models of a formula $\phi$ are arrows $v:D_X\to G$ (for some $X\supseteq \fv(\phi)$ and some graph $G$) such that $v\sat^\FOL \phi$. For an arbitrary graph $A$ with node set $V_A$, let $v_A:D_{V_A}\to A$ map the discrete graph over $V_A$ to $A$.

\subsubsection{From ab-conditions to formulas.}

Taking inspiration from Theorem 1 of \cite{Rensink-FOL}, but departing slightly because of the different notation, let us show how can we obtain for every arrow-based condition $c\in \AC{R}$ a $\FOL$ formula $\phi_c$ (with $\fv(\phi_c)\subseteq V_R$) having the same models, i.e.\ such that $g\sat c$ iff $g\sat^\FOL \phi_c$ for any arrow $g\of R\to G$. To avoid variable capture, it is convenient to consider ab-conditions which are \emph{well formed}, that is such that all graphs appearing in them have pairwise disjoint sets of nodes and of edges. Without loss of generality, we can always assume that an ab-condition is well formed, because we can rename node and edge identities up to isomorphism.

\begin{definition}[encoding ab-conditions as $\FOL$ formulas]
  \label{def:encoding}
  Given a graph $R = (V_R, E_R, s_R, t_R, \ell_R)$, its $\FOL$ encoding is the formula   
\begin{equation}
	\psi_R = %\textstyle
% \bigwedge_{x\in V_P}{x=x} \wedge
 \bigwedge_{e\in E_R} \ell_R(e)\bigl(s_R(e),t_R(e)\bigr)\label{eq:psiR}
\end{equation}
Given a well-formed ab-condition $c\in \AC R$ with $c=(R,(a_1,c_1)\ccdots (a_w,c_w))$ and $a_i:R \to P_i$ for each $i \in \{1, \ldots, w\}$, its $\FOL$ encoding is the formula 
\begin{align}
	\phi_c = %\textstyle
  \bigvee_{i\in \{1,\ldots,w\}} \left(\exists V_{P_i}\st \psi_{P_i} \land  \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x)\right) \land  \neg \phi_{c_i}\right)\label{eq:phiC}
\end{align}
\end{definition}

\begin{figure}[t]
  \centering
\begin{tikzpicture}[on grid]
  \node[graph] (10) {\onenode{x}};
  \node[left=0 of 10.west,inner sep=0] {$c$};
  \node[graph,below=of 10] (11) {\oneloopleft{x_1}{b}}; 
  \node[left=0 of 11.west,inner sep=0] {$c_{1}$};
  \node[graph,below left=1 and 1.1 of 11] (111) {\looponeedge{x_2}{b}{a}{y_2}};
  \node[above right=0 of 111.north west,inner sep=1] {$c_{2}$};
  \node[graph,below right=1 and 1.1 of 11] (112) {\looponeedge{x_3}{b}{c}{y_3}};
  \node[above left=0 of 112.north east,inner sep=1] {$c_{3}$};

  \path (10) edge[->] node[left] {$f$} (11)
        (11) edge[->] node[left] {$g$} (111)
        (11) edge[->] node[right] {$h$}(112);
\end{tikzpicture}
\caption{A well-formed ab-condition equivalent to $c_1$ of Example~\ref{ex:ab-conditions}}
\label{ab-condition-c}
\end{figure}


\begin{example}[formula associated with a condition]
As an example, let's detail the formula $\phi_{c}$ associated with the condition $c$ of Figure~\ref{ab-condition-c}, a well-formed variant of condition $c_1$ of Example~\ref{ex:ab-conditions}.  We use the names $c,c_1,c_2$ and $c_3$ to denote both the graphs they are attached to, and the conditions rooted at them.

For the four graphs, using \eqref{psiR}, we obtain:

$
\begin{array}{ll}
\psi_{c} &= \True\\
\psi_{c_{1}} &= \lb(x_{1},x_{1})\\
\psi_{c_{2}} &= \lb(x_{2},x_{2})\land \la(x_{2},y_{2})\\ 
\psi_{c_{3}} &= \lb(x_{3},x_{3})\land \lc(x_{3},y_{3})\\
\end{array}
$

\medskip
Now let us consider the four conditions, using \eqref{phiC}, bottom-up: 

$
\begin{array}{ll}
\phi_{c_{2}} & = \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
\phi_{c_{3}} & =  \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
 \phi_{c_{1}} & = (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2} \land \neg \phi_{c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3} \land \neg \phi_{c_{3}})\\
 \phi_{c} & = \exists \{x_{1}\}\st \psi_{c_{1}} \land x \Eq x_{1} \land  \neg \phi_{c_{1}}
\end{array}
$

\medskip
We can simplify $\phi_{c_1}$ as follows: 

$
\begin{array}{ll}
 \phi_{c_{1}} & = (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2} \land \neg \phi_{c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3} \land \neg \phi_{c_{3}})\\
  & \equiv \{\text{replacing $\phi_{c_{2}}$ and $\phi_{c_{3}}$ with their values ($\False$) and evaluating}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st \psi_{c_{2}} \land x_{1} \Eq x_{2}) \vee (\exists \{x_{3},y_{3}\} \st  \psi_{c_{3}} \land x_{1} \Eq x_{3})\\
 & \equiv \{\text{replacing $\psi_{c_{2}}$ and $\psi_{c_{3}}$ with their values}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st \lb(x_{2},x_{2})\land \la(x_{2},y_{2}) \land x_{1} \Eq x_{2})\quad \vee \\
 & \qquad \qquad (\exists \{x_{3},y_{3}\} \st  \lb(x_{3},x_{3})\land \lc(x_{3},y_{3}) \land x_{1} \Eq x_{3})\\
& \equiv \{\text{applying the \emph{singleton law} twice (see \eqref{singleton}), eliminating $x_2$ and $x_3$}\}\\
& \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{3}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{3}))\\
& \equiv \{\text{$\alpha$-conversion, $\exists$ distributes over $\vee$}\}\\
% & \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{2}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{2}))\\
& \equiv \exists \{y\} \st (\lb(x_{1},x_{1})\land \la(x_{1},y)) \lor ( \lb(x_{1},x_{1})\land \lc(x_{1},y))\\
& \equiv \exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y))\\
\end{array}
$

\medskip
The \emph{singleton law} is the following logical equivalence, where $P[^y/_x]$ is formula $P$ where all free occurrences of $x$ are replaced by $y$: 
\begin{equation}
\exists x\st x \Eq y \wedge P \quad \equiv \quad P[^y/_x] \label{eq:singleton}
\end{equation} 
It allows to get rid of an existential quantifier when the quantified variable is equated to a term. As it can be grasped from the current example, this law  has a relevant role in simplifying formulas associated with conditions, because they contain several existentials.

\medskip
Finally for $\phi_c$ we obtain:

$
\begin{array}{ll}
\phi_{c} & = \exists \{x_{1}\}\st \psi_{c_{1}} \land x \Eq x_{1} \land  \neg \phi_{c_{1}}\\
 & \equiv \{\text{replacing $\psi_{c_{1}}$ and $\phi_{c_{1}}$ with their values}\}\\
& \equiv \exists \{x_{1}\}\st\lb(x_{1},x_{1}) \land x \Eq x_{1} \land  \neg (\exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y)))\\
 & \equiv \{\text{eliminating $x_1$ by the singleton law}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \lb(x,x)\land (\la(x,y) \lor \lc(x,y)))\\
 & \equiv \{\text{standard but lengthy manipulation}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \la(x,y) \lor \lc(x,y))\\
\end{array}
$


which is indeed the $\FOL$ formula anticipated in Example~\ref{ex:ab-conditions}.


\end{example}


As shown below formally, a graph morphism $g: R \to G$ satisfies an ab-condition $c$ according to \dcite{ab-satisfaction} if and only if it satisfies $\phi_c$ according to \dcite{encoding}. Intuitively, in the formula $\phi_c$ defined in~\eqref{phiC}, the disjunction means that there is a branch $i$ such that there is a morphism $h: P_i \to G$ (by $\psi_{P_i}$), where  $\bigwedge_{x \in V_{R}} x \Eq a_i(x)$ guarantees $g=a_i;h$, and finally $\neg \phi_{c_i}$ ensures $h\nsat c_i$. Let's analise all this in detail.


Considering formula \eqref{psiR}, note that $\fv(\psi_R) \subseteq V_R$, and the free variables are exactly all the non-isolated nodes of $R$.\footnote{A node is \emph{isolated} if it is neither the source nor the target of any edge.} Formula $\psi_R$ represents the structure of graph $R$ in the following sense.
\begin{lemma}[properties of $\psi_R$]
  \label{lem:psi-R}
Given a morphism $m: A \to G$ with $G$ not empty and a graph $R$, let $\psi_R$ be defined as in \eqref{psiR}. Then the following are equivalent:
\begin{enumerate} 
  \item $m \sat^\FOL \psi_R$;
  \item $\fv(\psi_R) \subseteq V_A$ and there is a morphism $j \of R \to G$ such that for each $x \in \fv(\psi_R)$ it holds that $m_V(x) = j_V(x)$;
  \item there is a morphism $j \of R \to G$ such that the following diagram commutes:\todo{Do we need both clauses 2 and 3? They are so obviously equivalent}
\begin{center}
\begin{tikzpicture}[auto,node distance = 1.5cm]
  \node (vars) {$\disc{\fv(\psi_R)}$};
  \node  (A) [above right of=vars]{$A$}
  edge [<-right hook] (vars);
  \node [below right of=A] (G) {$G$}
  edge [<-] node[auto,swap] {$m$} (A);
  \node [below right of=vars] (R) {$R$}
  edge [<-right hook] (vars) 
  edge [->] node[auto,swap] {$j$} (G); 
\end{tikzpicture}
\end{center} 
\end{enumerate}
\end{lemma}

\begin{proof}[]
\begin{description}
\item [($2 \Leftrightarrow 3$)] is obvious, by the definition of the discrete graph $\disc{\fv(\psi_R)}$.
\item [($1 \Rightarrow  2$)] 
%Let $e \in E_R$ with $s_R(e)=x$, $t_R(e) = y$ and $\ell_R(e)= \la$. Clearly $x,y \in \fv(\psi_R)$ and thus $\{x,y\} \in V_A$ by definition of satisfaction. Then define $j_V(x) = m_V(x)$, $j_V(y) = m_V(y)$, and $j_E(e) = e'$ where $e' \in E_G$ is the edge witnessing that $m \sat^\FOL \la(x,y)$. Repeating this for all edges in $E_R$ defines morphism $j\of R \to G$ on all edges and non-isolated nodes of $R$

First, observe that $\fv(\psi_R) \subseteq V_A$ by  definition of satisfaction. Then define $j\of R \to G$ as follows:
\begin{itemize}
\item $j_V(x) = m_V(x)$ for each non-isolated $x \in V_R$. This is well-defined because $x \in \fv(\psi_R)$.
\item  $j_V(x)$ is defined arbitrarily if $x$ is isolated in $R$: this is possible because $G$ is not empty.
\item For each $e \in E_R$, $j_E(e) = e'$ where $e' \in E_G$ is an edge of $G$ witnessing that $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$.
\end{itemize}
The well-definedness of morphism $j$ and the fact that it satisfies condition 2 are obvious by construction. 
\item [($2 \Rightarrow  1$)] Given 2, we have to show that for each $e \in E_R$, $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$, that is, there is an edge $e' \in E_G$ with $s_G(e') = m_V(s_R(e))$, $t_G(e') = m_V(t_R(e))$ and $\ell_G(e') = \ell_R(e)$. Since $s_R(e),t_R(e) \in \fv(\psi_R)$, they also belong to $V_A$ by hypothesis. Then it is easy to check that setting $e' = j_E(e)$ the required conditions are satisfied. Indeed, $m_V(s_R(e)) = j_V(s_R(e)) = s_G(j_E(e)) = s_G(e')$, similarly for $m_V(t_R(e))$, and $\ell_G(e') = \ell_G(j_E(e)) = \ell_R(e)$.
\end{description}
\end{proof}

We can show now that an ab-condition $c$ and the corresponding formula $\phi_c$, as defined in \eqref{phiC}, have exactly the same models.

\begin{proposition}[properties of $\phi_c$]
  \label{pr:same-models}
  Let $c\in \AC R$ be an ab-condition over $R$ and $\phi_c$ be its $\FOL$ encoding as for Definition~\ref{def:encoding}. Given a graph morphism $g: R \to G$ we have
  \[ g \sat c \qquad \iff \qquad g \sat^\FOL \phi_c\enspace.\] 
\end{proposition}

\begin{proof}[]
Let $c=(R,(a_1,c_1)\ccdots(a_w,c_w))$. We proceed by induction on the depth. If $\depth(c) = 0$ we trivially have that neither $c$ nor $\phi_c = \False$ have any model.

Now assume that $\depth(c) = n$ and that the statement holds for any $c'$ with $\depth(c')<n$.

\paragraph{(Only if case - $\Rightarrow$)}

Suppose that $g \sat c$ with responsible branch $p_j = (a_j,c_j)$, with $j \in \{1, \ldots, w\}$, and witness $h\of P_j \to G$. By \dcite{ab-satisfaction} we have $(\dagger)~ a_j;h = g$ and $(\ddagger)~ g \not \sat c_j$.
%
We show \eqref{g-sat-exists}, from which the statement follows: 
\begin{equation}
  \label{eq:g-sat-exists}
g\sat^\FOL \exists V_{P_j}\st \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}
\end{equation}

Assuming w.l.o.g.~that $R\cap P_j = \varnothing$, let $R \stackrel{in_1}{\hookrightarrow} R \cup P_j$ be the obvious inclusion, and let $R\cup P_j \stackrel{[g,h]}{\longrightarrow} G$ be the only morphism induced by $g$ and $h$. To prove  \eqref{g-sat-exists} we show that 

\begin{equation}
[g,h] \sat^\FOL \psi_{P_j} \wedge \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x) \right) \land \neg \phi_{c_i}
\end{equation}
\noindent
by considering in turn the three conjuncts, from which \eqref{g-sat-exists} follows by $(\sat^\FOL \exists)$.
% \renewcommand{\labelenumi}{\alph{enumi})} 
\begin{enumerate}
  \item $[g,h] \sat^\FOL \psi_{P_j}$. By Lemma~\ref{lem:psi-R}, this follows from the following commuting diagram: 
\begin{center}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node (vars) {$\disc{\fv(\psi_{P_j})}$};
    \node  (A) [above right of=vars]{$R\cup P_j$}
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$[g,h]$} (A);
    \node [below right of=vars] (R) {$P_j$}
    edge [<-right hook] (vars) 
    edge [->] node[auto,swap] {$h$} (G); 
  \end{tikzpicture}
  \end{center} 
  \item $[g,h] \sat^\FOL \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x) \right)$. Let $x \in V_{R}$. %Clearly, $a_j(x) \in V_{P_j}$ for each $x \in V_{R}$. 
  Then $[g,h](x) \stackrel{x\in R}= g(x) \stackrel{(\dagger)}= a_j;h(x) = h(a_j(x)) \stackrel{a_j(x) \in P_j}= [g,h](a_j(x))$. Hence $[g,h] \sat^\FOL x \Eq a_j(x)$. 
  \item $[g,h] \sat^\FOL \neg \phi_{c_j}$. By Lemma~\ref{lem:sat_only_free_vars}, given the following commuting diagram it is sufficient to show that $h\sat^\FOL \neg \phi_{c_j}$.
  \begin{equation}\label{eq:vars-only-2}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\neg \phi_{c_j})}$};
      \node  (A) [above right of=vars]{$P_j$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{h}$} (A);
      \node [below right of=vars] (B) {$R \cup P_j$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{[g,h]}$} (G); 
    \end{tikzpicture}
    \end{equation}
  
  Indeed, since $(\ddagger)~h \not \sat c_j$ by assumption and $\depth(c_j) < n$, by induction hypothesis we have $h\not\sat^\FOL \phi_{c_j}$, i.e., $h\sat^\FOL \neg \phi_{c_j}$. 
\end{enumerate}

\paragraph{(If case - $\Leftarrow$)}
Let $g\of R \to G$ be a morphism and assume that $g \sat^\FOL \phi_c$. Let $j \in \{1,\ldots,w\}$ be such that
\[g\sat^\FOL \exists V_{P_j}\st \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}\]

As expected, $(a_j, P_j)$ will be the responsible branch for $g \sat c$: we have to find a witness morphism from $P_j$ to $G$.
By $(\sat^\FOL \exists)$ there is  graph $B$ (see \eqref{proof4})  with $R \subseteq B$ and a morphism $k\of B \to G$ such that $k\restr R = g$ and 

\[k \sat^\FOL \psi_{P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \phi_{c_j}\]

\begin{equation}
  \label{eq:proof4}
  \begin{tikzpicture}[node distance = 2cm]
    \node at (2,0.5) (G) {$G$};
    \node at (0,0) (B) {$B$}
    edge [->] node[auto] {$\scriptstyle{k}$} (G);
    \node at (0,-1) (Pj) {$P_j$}
    edge [->] node[auto,swap]  (h) {$\scriptstyle{h}$}  (G);
    \node at (0,1) (R) {$R$}
    edge [right hook->] (B)
    edge [->] node[auto] {$\scriptstyle{g}$} (G)
    edge [->,bend angle=45,bend right] node[auto,swap] {$\scriptstyle{a_j}$} (Pj);
    \node at (-2,-0.5) (vars) {$\disc{\fv(\psi_{P_j})}$}
    edge [right hook->] (B)
    edge [right hook->] (Pj);
  \end{tikzpicture}
  \end{equation}   

Since $k \sat^\FOL \psi_{P_j}$, by Lemma~\ref{lem:psi-R} there is a morphism $h: P_j \to G$ such that the lower square in \eqref{proof4} commutes. Note that the action of $h$ is uniquely determined on the free variables of $\psi_{P_j}$, i.e.~on the non-isolated nodes of $P_j$. 

% Since $k \sat^\FOL \bigwedge_{x \in V_{R}} x \Eq a_j(x)$ we have that $\{a_j(x) \mid x \in V_R\}\subseteq V_B$.  Define $h': P_j \to G$ as follows: $h'(y) = k(y)$ if $y = a_j(x)$ for some $x \in V_R$ and $y$ is isolated in $P_j$, $h'(y) = h(y)$ otherwise. Note that for each $x \in V_R$, $h'(a_j(x)) = k(a_j(x))$.

% Let us show that $a_j;h' = g$. Let $x \in V_R$. Since $k \sat^\FOL x \Eq a_j(x)$, we have $g(x) = k(x) = k(a_j(x)) = h'(a_j(x))$.

% To conclude, we show that from $h'$ we can obtain a witness $h''$  for $g \sat c$, i.e.~such that $a_j;h'' = g$ and $h' \not \sat c_j$. We know that $k \sat^\FOL \neg \phi_{c_j}$, thus  $\fv(\phi_{c_j}) \subseteq V_{B}$ and clearly $\fv(\phi_{c_j}) \subseteq V_{P_j}$. However, for some $x \in \fv(\phi_{c_j})$ we could have $k(x) \neq h'(x)$ in case $x$ is isolated in $P_j$ and is not in the image of $a_j$. Thus define $h'': P_j \to G$ as follows:  $h''(y) = k(y)$ if $y \in \fv(\phi_{c_j})$ and  $y$ is isolated in $P_j$, $h''(y) = h'(y)$ otherwise. Note that for each $x \in V_R $ we have $h''(a_j(x)) = h'(a_j(x))$, therefore $a_j;h'' = g$. Furthermore, for all $x \in \fv(\phi_{c_j})$ we have $h''(x) = k(x)$ by construction. Therefore by Lemma~\ref{lem:sat_only_free_vars}, since $k\sat^\FOL \neg \phi_{c_j}$ also $h''\sat^\FOL \neg \phi_{c_j}$. Since $\depth(c_j) < n$, by induction hypothesis $h'' \not \sat c_j$, which concludes the proof.

% \todo{I try to do it shorter}

We show that from $h$ we can obtain a witness $h'$  for $g \sat c$, i.e.~such that $a_j;h' = g$ and $h' \not \sat c_j$.
%
Since $k \sat^\FOL \bigwedge_{x \in V_{R}} x \Eq a_j(x)$ and $k \sat^\FOL \neg \phi_{c_j}$, 
we have that $\{a_j(x) \mid x \in V_R\} \cup \fv(\phi_{c_j}) \subseteq V_B$. Clearly also $\{a_j(x) \mid x \in V_R\} \cup \fv(\phi_{c_j}) \subseteq V_{P_j}$. Define $h': P_j \to G$ as follows: $h'(y) = k(y)$ if $y = a_j(x)$ for some $x \in V_R$ or $y \in \fv(\phi_{c_j})$ and $y$ is isolated in $P_j$, $h'(y) = h(y)$ otherwise. Note that by construction for each $x \in V_R$, $(\dagger)\ h'(a_j(x)) = k(a_j(x))$ and for each $x \in \fv(\phi_{c_j})$ we have $(\ddagger)\ h'(x) = k(x)$. 

Let us show that $a_j;h' = g$. Let $x \in V_R$. Since $k \sat^\FOL x \Eq a_j(x)$ and using $(\dagger)$, we have $g(x) = k(x) = k(a_j(x)) = h'(a_j(x))$. Furthermore, by Lemma~\ref{lem:sat_only_free_vars} and $(\ddagger)$, since $k\sat^\FOL \neg \phi_{c_j}$  also $h'\sat^\FOL \neg \phi_{c_j}$. Since $\depth(c_j) < n$, by induction hypothesis $h' \not \sat c_j$, which concludes the proof.

\qed
\end{proof}

\subsubsection{From formulas to ab-conditions.} The other way around, we show that every $\FOL$ formula generated by the grammar of Def.~\ref{def:graph_formulas} can be encoded as an ab-condition having exactly the same models. Since $g:A \to G \sat^\FOL \phi$ implies that $V_A$ contains the free variables of $\phi$, the root graph of the ab-condition encoding $\phi$ must include $\fv(\phi)$ in the nodes, but can be larger. Therefore with each formula $\phi$ we associate an ``upward-closed'' set of ab-conditions $\abc{\phi}$, all having a discrete root including $\fv(\phi)$. 
To formalize this, we introduce an operation that adds fresh nodes to the root of a condition, intuitively copying them identically along all branches.

\begin{definition}[adding nodes to a condition]
  \label{def:adding-nodes-to-condition}
  Let $c = (R,(a_1,c_1)\ccdots (a_w,c_w))$ be an ab-condition, and $J$ be a non-empty, finite set disjoint from all graphs in $c$; in particular, $J \cap V_R = \varnothing$. Condition $c \uplus J$ is defined as $c \uplus J = (R \cup \disc{J}, (a_1 \cup id_{\disc{J}}, c_1 \uplus J)\ccdots(a_w \cup id_{\disc{J}}, c_w \uplus J))$. 

  A set of ab-conditions $\cC$ is \emph{upward closed} if for each $c \in \cC$ and non-empty finite set $J$ disjoint from all graphs in $c$ it holds that $c \uplus J \in \cC$. \todo{AR: disjoint from all graphs in $c$? AC: done} 
\end{definition}

Note that $c$ and $c \uplus J$ are incomparable with respect to entailment because they have different roots. Nevertherless, it is easy to prove that  
for each morphism $m \of R \uplus \disc{J} \to G$,\todo{AC: explict proof? AR: I really think this is immediate}
\begin{eqnarray}
m \sat c \uplus J & \iff & m \restr R \sat c \eqlabel{eq:modRestricted}\\
m\sat^\FOL \phi_c & \iff & m \sat^\FOL \phi_{c\uplus J} \eqlabel{eq:condExpanded}
\end{eqnarray}

  
\begin{definition}[from formulas to ab-conditions]
  \label{def:from-formulas-to-ab-conditions}
The  \emph{set of ab-conditions encoding a formula $\phi$}, denoted $\abc{\phi}$, is the smallest upward-closed set determined by the following inductive clauses: 
\begin{enumerate}
\item 
If $\phi = \False$, then $(\disc{\varnothing}, \epsilon)\in \abc{\phi}$.
\item If $\phi = \True$, then $(\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))\in \abc{\phi}$.
\item 
If $\phi = x \Eq y$, then $(\disc{\{x,y\}}, (\{x\mapsto z,y \mapsto z\}, (\disc{\{z\}},\epsilon))) \in \abc{\phi}$.\todo{AR: I would prefer $x$ or $y$ rather than $\bullet$. AC: done}
\item 
If $\phi = \la(x,y)$, then $(\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon))) \in \abc{\phi}$.
\item 
If $\phi = \neg \phi'$ and $(R,p_1\ccdots p_w)\in \abc{\phi'}$ then $(R,(id_R, (R,p_1\ccdots p_w)))\in \abc{\phi}$.
\item 
If $\phi = \phi_1 \lor \phi_2$ and $(R,p_1\ccdots p_w)\in \abc{\phi_1}$, $(R,q_1\ccdots q_v) \in \abc{\phi_2}$ then $(R,p_1\ccdots p_wq_1\ccdots q_v) \in \abc{\phi}$.
\item 
If $\phi = \exists X \st \phi'$ and $(R,(a_1,c_1)\ccdots (a_w,c_w)) \in \abc{\phi'}$ then
$(R\setminus \disc{X},(i;a_1,c_1)\ccdots (i;a_w,c_w)) \in \abc{\phi}$, where $i\of R\setminus \disc{X} \hookrightarrow R$ is the inclusion. 
\item 
Finally, by exploiting the usual equivalences we define $\abc{\phi_1 \land \phi_2} = \abc{\neg (\neg \phi_1 \lor \neg \phi_2)}$ and $\abc{\forall X\st \phi} = \abc{\neg \exists X \st \neg \phi}$.
\end{enumerate}
\end{definition}

The correctness of this encoding is stated as follows.\todo{In this form, it does not emerge why we need the upward-closedness. I would like to include a corollary that states something for \emph{any} $g$; maybe $g \sat^\FOL \phi \iff \exists c\in C(\phi)\st g \sat c$?}

\begin{proposition}[properties of $\abc{\phi}$]
  \label{pr:same-models-2}
Given a formula $\phi$ and any ab-condition $c = (R, (p_1\ccdots p_w)) \in \abc{\phi}$, for each graph morphism $g \of R \to G$ we have

\[ g \sat^\FOL \phi \qquad \iff \qquad g \sat c \enspace.\] 

\end{proposition}
\begin{proof}[]
We show by induction on depth that given a condition $c \in \abc{\phi}$ the formulas $\phi$ and $\phi_{c}$ (as for Def.~\ref{def:encoding}) are logically equivalent. 
Since by Prop.~\ref{pr:same-models} $c$ and $\phi_{c}$ have the same models, the statement follows. Actually, given \eqref{eq:modRestricted} it is sufficient to prove $\phi \equiv \phi_{c}$ for the generators of sets $\abc{\phi}$ as defined in Def.~\ref{def:from-formulas-to-ab-conditions}.\todo{AC: explain better why?}

\begin{enumerate}
  \item 
  If $\phi = \False$, % then $(\varnothing, \epsilon)\in \abc{\phi}$.
  let $c = (\disc{\varnothing}, \epsilon)$. Then $\phi_c$ is an empty disjunction, which is $\False$.
  
  \item If $\phi = \True$, let $c = (\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists \varnothing\st \psi_{\disc{\varnothing}} \land \True' \land \neg \phi_{(\disc{\varnothing},\epsilon)} \equiv \True$. In fact  $\True'$ arises from an empty conjunction,  the existential over an empty set can be dropped, $\psi_{\disc{\varnothing}} = \True$ (see \eqref{psiR}), and $\phi_{(\disc{\varnothing},\epsilon)} = \False$ by the previous point.
  \item 
If $\phi = x \Eq y$, let $c = (\disc{\{x,y\}}, (\{x\mapsto z,y \mapsto z\}, (\disc{\{z\}},\epsilon)))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists \{z\} \st  \psi_{\disc{\{z\}}} \land (x \Eq z \land y \Eq z) \land \neg \phi_{(\disc{\{z\}},\epsilon)}$. Since $ \psi_{\disc{\{z\}}} = \True$ (see \eqref{psiR}) and $\phi_{(\disc{\{z\}},\epsilon)} = \False$ using point 1., $\phi_c$ is equivalent to $\exists \{z\} \st  x \Eq z \land y \Eq z$, which in turn is equivalent to $x \Eq y$, as desired, by the singleton law~\eqref{singleton}.

\item 
If $\phi = \la(x,y)$, let  $c = (\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon)))$. Then $\phi_c  = \bigvee_{i \in \{1\}}  \exists \{x', y'\} \st  \psi_{\inline{\oneedge{x'}{a}{y'}}} \land (x \Eq x' \land y \Eq y' \land \neg \phi_{(\inline{\oneedge{x'}{a}{y'}},\epsilon)}$. We have $ \psi_{\inline{\oneedge{x'}{a}{y'}}}  = \la(x',y')$ by \eqref{psiR}, and  $\phi_{(\inline{\oneedge{x'}{a}{y'}},\epsilon)} = \False$ using point 1., thus $\phi_c \equiv \exists \{x', y'\} \st   \la(x',y') \land x \Eq x' \land y \Eq y'$. By a first application of the singleton law  $\phi_c \equiv \exists \{y'\} \st   \la(x,y')  \land y \Eq y'$, and by a second application $\phi_c \equiv \la(x,y)$, as desired.
\item 
If $\phi = \neg \phi'$ and $c' = (R,p_1\ccdots p_w)\in \abc{\phi'}$ then $(R,(id_R, c'))\in \abc{\phi}$. To avoid variable capturing, let $c'' = (R',p'_1\ccdots p'_w)$ be a renamed-apart version of $c'$ obtained by replacing each item $x$ with $x'$. Let $c = (R,(id'_R, c''))$, where $id'_R(x) = x'$.   Then $\phi_c = \bigvee_{i \in \{1\}}  \exists V_{R'} \st \psi_{R'} \land \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big) \land \neg \phi_{c''}$. Note that 
the effect of $\exists V_{R'} \st  \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big)$, by repeated applications of the singleton law, consists of applying the substition $x' \mapsto x$ to the remaining quantified formulas, i.e. $\psi_{R'} \land \neg \phi_{c''}$, thus obtaining $\phi_c \equiv \psi_{R} \land \neg \phi_{c'}$. Formula $\psi_{R}$ is trivially satisfied by any candidate model, which must be a morphism with $R$ as source, thus $\phi_c \equiv \neg \phi_{c'}$. By induction hypothesis, since $c' \in \abc{\phi'}$ we have $\phi' \equiv \phi_{c'}$, thus $\phi_c \equiv \neg \phi_{c'} \equiv \neg \phi' = \phi$, as desired.

% If $\phi = \neg \phi'$ and $c' = (R,p_1\ccdots p_w)\in \abc{\phi'}$, let $c = (R,(id_R, c'))$. Then $\phi_c = \bigvee_{i \in \{1\}}  \exists V_R \st \psi_R \land \big(\bigwedge_{x \in V_R} x \Eq id_R(x)\big) \land \neg \phi_{c'}$. 
\item 
If $\phi = \phi_1 \lor \phi_2$, let $c_1 = (R,p_1\ccdots p_w) \in \abc{\phi_1}$, and $c_2 = (R,q_1\ccdots q_v) \in \abc{\phi_2}$. Let $c = (R,p_1\ccdots p_wq_1\ccdots q_v)$. We have to show that $\phi_c \equiv \phi_1 \lor \phi_2$. This is obvious, by exploiting the induction hypothesis ($\phi_1 \equiv \phi_{c_1}$ and $\phi_2 \equiv \phi_{c_2}$) and given that $\phi_c$ is a disjunction over the set of branches of $c$ (which is the union of branches of $c_1$ and $c_2$) of formulas that depend only on the branch itself and of the root graph $R$, which is the same for $c$, $c_1$ and $c_2$.
\item 
If $\phi = \exists X \st \phi'$ and $c' = (R,(a_1,c_1)\ccdots (a_w,c_w)) \in \abc{\phi'}$, let $c =  (R\setminus \disc{X},(i;a_1,c_1)\ccdots (i;a_w,c_w))$, where $i\of R\setminus \disc{X} \hookrightarrow R$ is the inclusion. We show that $\phi_c \equiv\exists X\st \phi_{c'}$, and conclude by induction hypothesis. Note that $\phi_c$ and $\phi_{c'}$ are almost identical, only differing for the conjuction of equalities, which ranges over $V_R$ in $\phi_{c'}$ ($\bigwedge_{x\in V_R} x \Eq a_i(x)$) and over $V_{R\setminus \disc{X}} = V_R \setminus X$ in $\phi_{c}$ ($\bigwedge_{x\in {V_R\setminus X}} x \Eq a_i(x)$). By repeated applications of the singleton law one obtains that $\exists X\st \bigwedge_{x\in V_R} x \Eq a_i(x)\quad \equiv \quad \bigwedge_{x\in {V_R\setminus X}} x \Eq a_i(x)$.\footnote{For example, $\exists x\st x \Eq f(x) \wedge y \Eq f(y) \quad \equiv \quad  y \Eq f(y)[^{f(x)}/_x] \quad \equiv \quad  y \Eq f(y)$.}
Thus we can conclude observing that the existential quantification on $X$ in $\exists X\st \phi_{c'}$ can be pushed inside the disjunction (by a $\FOL$ law), and it does not affect the other formulas like $\psi_i$ or $\neg \phi_i$, assuming that the condition is well formed (therefore $X$ is disjoint from all the graphs in the branches).  
\end{enumerate}
\end{proof}




\todo{AC: Add example of condition $\abc{\phi}$ for a suitable $\phi$?}
