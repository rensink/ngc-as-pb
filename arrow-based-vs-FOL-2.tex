\section{Connection to first-order logic}
\label{sec:FOL}

It has been shown (e.g., \cite{Rensink-FOL,Habel-FOL}) that every first-order logic (FOL) formula on graphs can be encoded as an arrow-based nested condition over $\Graph$ and vice versa. For the sake of completeness,\todo{AC: Is the formal encoding spelled out somewhere? Can we present this as a contribution?} we summarise the connection here. We restrict to binary predicates, which we take from the set of edge labels $\Lab$. For the purpose of this discussion, w.l.o.g.\ we assume that graph nodes are variables, taken from a set $\Var$.\todo{Should we explicitly say something about the technical issues caused by the discrepancy between the treatment of free variables in FOL vs NC? AC: I don't think it's necessary.}



\begin{definition}[graph formulas and satisfaction]
  \label{def:graph_formulas}
The set of \emph{(graph) formulas} is generated by the following grammar
%
\[ \phi \:::=\: \True
        \:\mid\: \False
		\:\mid\: \la(x_1,x_2)
        \:\mid\: x_1 \Eq x_2
		\:\mid\: \phi_1\wedge \phi_2
		\:\mid\: \phi_1\vee \phi_2
		\:\mid\: \neg\phi
		\:\mid\: \exists \bar x\st \phi 
		\:\mid\: \forall \bar x\st \phi 
		\]
where the $x_i$ are variables (from $\Var$), 
%$\bar x\in \Var^*$ 
$\bar x\subseteq \Var$ is a finite set of variables and $\la \in \Lab$ is a binary predicate. The set of \emph{free variables} of a formula $\phi$, denoted $\fv(\phi)$, is defined inductively in the usual way. When needed, without loss of generality we assume that the sets of free and bound variables of a formula are disjoint.  

The semantics of graph formulas is defined through a satisfaction relation, denoted $\sat^\FOL$, between graph morphisms and formulas. Given a formula $\phi$ and a graph morphism $g \of A \to G$, satisfaction is defined only if $\fv(\phi) \subseteq V_A$, inductively over the structure of $\phi$ as follows: 

\[%\arraycolsep=1.4pt
%\def\arraystretch{1.1}  
\begin{array}{ll}
  g\sat^\FOL \True & \text{always} \\
  g\sat^\FOL \False & \text{never} \\
  g\sat^\FOL \la(x_1,x_2) & \iffdef \text{there is an edge } e\in E_G \text{ such that } g_V(x_1) \stackrel{e:\la}{\longrightarrow} g_V(x_2)\\
  %  \text{ with } s(e)=g(x_1), \ell(e)=\la, t(e)=g(x_2) \\
  g\sat^\FOL x_1\Eq x_2 & \iffdef g_V(x_1)=g_V(x_2) \\
  g\sat^\FOL \phi_1\wedge \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ and } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \phi_1\vee \phi_2 & \iffdef g\sat^\FOL \phi_1 \text{ or } g\sat^\FOL \phi_2 \\
  g\sat^\FOL \neg\phi & \iffdef \text{not } g\sat^\FOL \phi \\
  g\sat^\FOL \exists X\st \phi  & \iffdef \text{ there is a graph $B$ such that $A \subseteq B$ and a morphism}\\ & \text{$h\of B\to G$ such that $h \restr A = g$ and $h \sat^\FOL \phi$}\hfill (\sat^\FOL \exists)\\
  g\sat^\FOL \forall X\st \phi  & \iffdef \text{ for each graph $B$ such that $A \subseteq B$ and for any morphism}\\ & \text{$h\of B\to G$, if  $h \restr A = g$ then $h \sat^\FOL \phi$}\enspace.\hfill (\sat^\FOL \forall)\\
  \end{array}
  \]

  If $g \sat^\FOL \phi$ holds, we call $g$ a \emph{model} of $\phi$. 
\end{definition}

Based on the notion of satisfaction we can define entailment and logical equivalence between $\FOL$ formulas. The definition takes into account the fact that satisfaction is only defined when the source of the morphism contains the free variables of the formula.

\begin{definition}[entailment and equivalence of $\FOL$ formulas]
  \label{def:entailsFOL}
  Given $\FOL$ formulas $\phi$ and $\psi$, 
  \begin{itemize} 
    \item $\phi$ \emph{entails} $\psi$, denoted $\phi \entails \psi$, if $\fv(\psi) \subseteq \fv(\phi)$ and for each morphism $g$, $g \sat^{\FOL} \phi$ implies  $g \sat^{\FOL} \psi$;\todo{AC: shorter: each model of $\phi$ is a model of $\psi$.}
    \item $\phi$ and $\psi$ are \emph{(logically) equivalent}, denoted $\phi \equiv \psi$ if $\phi \entails \psi$ and $\psi \entails \phi$
  \end{itemize}
\end{definition}

For example, we have $\True \lor x\Eq x \entails \True$, but $\True \not \entails \True \lor x\Eq x$, thus the two formulas are not equivalent. Similarly, $\False \land x\Eq x \entails \False$, but not viceversa, despite the fact that both formulas have no models.\todo{AC: do we want this? I expect that this is technically necessary, but I'm not sure. If not, the definition of entailment can be simplified by dropping the condition on free variables.}


Note that while the set of models of an ab-condition with root $R$ includes only morphisms with $R$ as source (Def. \dref{ab-satisfaction}),  the set of models of a formula $\phi$ may include morphisms having as source any graph $A$ such that $\fv(\phi) \subseteq V_A$. We will address this discrepancy when relating ab-conditions and formulas, also by exploiting the following result which states that when checking if a morphism satisfies a formula, only the action
of the morphism on the nodes which are free variables is relevant
% Note that though satisfaction is defined for arbitrary graph morphisms, actually
% only their action on the nodes which are free variables is relevant. This is expressed by the following lemma.

\begin{lemma}[satisfaction depends on free variables only]
  \label{lem:sat_only_free_vars}
  Let $f\of A \to G$ and $g\of B \to G$ be two morphisms and $\phi$ be a formula such that $f \sat^\FOL \phi$. If the following diagram commutes, where hooked arrows are graph inclusions, then also $g \sat^\FOL \phi$ holds.
  %\begin{center}
    \begin{equation}\label{eq:vars-only}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\phi)}$};
      \node  (A) [above right of=vars]{$A$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
      \node [below right of=vars] (B) {$B$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
    \end{tikzpicture}
    \end{equation}
   % \end{center} 
\end{lemma}

\begin{proof}[]
Note that $\fv(\phi) \subseteq V_B$ is guaranteed by the inclusion 
$\disc{\fv(\phi)} \hookrightarrow B$.
We proceed by induction on the structure of $\phi$. The statement is trivially true for $\phi \in \{\True, \False\}$. 

If $\phi = \neg \phi'$, suppose by absurd that $f \sat^\FOL \phi$ and $g \not \sat^\FOL \phi$: then $g  \sat^\FOL \phi'$. Since $\fv(\phi') = \fv(\phi)$ and given the symmetric role of $f$ and $g$ in the statement, by induction hypothesis we get $f \sat^\FOL \phi'$, a contradiction.

If $\phi = \la(x_1,x_2)$, by $f \sat^\FOL \phi$ there is an edge $e \in E_G$ such that  $f_V(x_1) \stackrel{e:\la}{\longrightarrow} f_V(x_2)$; since $f_V(x_i) = g_V(x_i)$ for $i \in \{1,2\}$ the same edge witnesses  $g \sat^\FOL \la(x_1,x_2)$. A similar argument applies if $\phi = x_1 \Eq x_2$.

If $\phi = \phi_1 \wedge \phi_2$, since $\fv(\phi_i) \subseteq \fv(\phi_1 \wedge \phi_2)$ for $i \in \{1,2\}$, from the square to the right in \eqref{vars-only-and} we get the outer commuting square for  $i \in \{1,2\}$. Since $f \sat^\FOL \phi_1 \wedge \phi_2$ implies $f \sat^\FOL \phi_i$, by induction hypothesis we get $g \sat^\FOL \phi_i$ for  $i \in \{1,2\}$, hence $g \sat^\FOL \phi_1 \wedge \phi_2$. A similar argument applies if $\phi = \phi_1 \vee \phi_2$.

%\begin{center}
  \begin{equation}\label{eq:vars-only-and}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node [left of =vars,node distance = 3 cm] (vari) {$\disc{\fv(\phi_i)}$};
    \node (vars) {$\disc{\fv(\phi_1 \wedge \phi_2)}$}
    edge [<-right hook] (vari);
    \node  (A) [above right of=vars]{$A$}
    edge [<-right hook] (vari)
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$\scriptstyle{f}$} (A);
    \node [below right of=vars] (B) {$B$}
    edge [<-right hook] (vars) 
    edge [<-right hook] (vari)
    edge [->] node[auto,swap] {$\scriptstyle{g}$} (G); 
  \end{tikzpicture}
\end{equation}
%  \end{center}

Let $\phi = \exists X\st \phi'$, and assume w.l.o.g.~that $X \cap V_A = X \cap V_B = \varnothing$. From $f \sat^\FOL \phi$ we know that there is a graph $A' \supseteq A$ and a morphism $f': A' \to G$ such that $f'\restr A = f$ and $f' \sat^\FOL \phi'$ (thus $\fv(\phi') \subseteq V_{A'}$), as shown in \eqref{vars-only-exists}. Recall that $\fv(\exists X\st \phi') \stackrel{\mathit{def}}{=} \fv(\phi') \setminus X$, thus $\fv(\exists X\st \phi') \subseteq \fv(\phi')$. 
Define $B' = B \cup \disc{\fv(\phi')\cap X}$ and $g'\of B' \to G$ as  $g'(x) = g(x)$ if $x \in V_B \cup E_B$, and $g'(x) = f'(x)$ if $x \in \fv(\phi')\cap X$. 
Well-definedness of $g'$ follows by the assumption that $X \cap V_B = \varnothing$. 
Now we can apply the induction hypothesis to the inner square:  $f' \sat^\FOL \phi'$ implies $g' \sat^\FOL \phi'$. Clearly, $B \subseteq B'$ and $g'\restr B = g$ hence $g \sat^\FOL \exists X\st \phi'$, as desired.


\begin{equation}
\label{eq:vars-only-exists}
\begin{tikzpicture}
  \node at ( 3,0) (G) {$G$};
  \node at ( 0,2) (A)  {$A$}
  edge [->] node[auto] {$\scriptstyle{f}$} (G);
  \node at ( 0,-2) (B) {$B$}
  edge [->] node[auto, swap] {$\scriptstyle{g}$} (G);
  \node at ( 0,1) (A') {$A'$}
  edge [<-right hook] (A)
  edge [->] node[auto,swap] {$\scriptstyle{f'}$} (G);
  \node at ( 0,-1) (B') {$B \cup \disc{\fv(\phi')\cap X}$}
  edge [<-right hook] (B)
  edge [->] node[auto] {$\scriptstyle{g'}$} (G);
  \node at (-5,0) (fv-ex) {$\disc{\fv(\exists X\st \phi')}$}
  edge [right hook->] (A) 
  edge [left hook->] (B);
  \node at (-2,0) (fv-phi) {$\disc{\fv(\phi')}$}
  edge [right hook->] (A')
  edge [left hook->] (B')
  edge [<-right hook] (fv-ex);
\end{tikzpicture}
\end{equation}
 
For $\phi = \forall X \st \phi'$ the statement follows from the previous points by observing that $g \sat^\FOL \forall X \st \phi' \Leftrightarrow g \sat^\FOL \neg (\exists X \st \neg \phi')$. \qed
% $\ell_G(e)= \la$, and  
\end{proof}

  %
 % Note that the last clause\todo{AR: is $X\subseteq N_B$ necessary in that clause?} requires that $\ctx{N_A}{\exists X\st \phi}$ is a {\cfor}, which implies that $X \cap \bv(\phi) = \emptyset$.


% Just as for conditions, the semantics of FOL is defined through a notion of satisfaction; however, the models are not arbitrary arrows in $\Graph$ but \emph{valuations} that map variables to the nodes of a graph. Such a valuation can be seen as an arrow from the discrete graph with node set $X\subseteq \Var$, here denoted $D_X$. Hence, the models of a formula $\phi$ are arrows $v:D_X\to G$ (for some $X\supseteq \fv(\phi)$ and some graph $G$) such that $v\sat^\FOL \phi$. For an arbitrary graph $A$ with node set $V_A$, let $v_A:D_{V_A}\to A$ map the discrete graph over $V_A$ to $A$.

\subsubsection{From ab-conditions to formulas.}

% forall: change \tofol c into \tofol{c}
Taking inspiration from Theorem 1 of \cite{Rensink-FOL}, but departing slightly because of the different notation, let us show how can we obtain for every arrow-based condition $c\in \AC{R}$ a $\FOL$ formula $\tofol{c}$  (with $\fv(\tofol c) = V_R$) having the same models, i.e.\ such that $g\sat c$ iff $g\sat^\FOL \tofol c$ for any arrow $g\of R\to G$. To avoid variable capture, it is convenient to consider ab-conditions which are \emph{well-formed}, that is such that all graphs appearing in them have pairwise disjoint sets of nodes and of edges. Without loss of generality, we can always assume that an ab-condition is well formed, because we can rename node and edge identities arbitrarily, obtaining an isomorphic variant.

\begin{definition}[encoding ab-conditions as $\FOL$ formulas]
  \label{def:encoding}
  Given a graph $R = (V_R, E_R, s_R, t_R, \ell_R)$, its $\FOL$ encoding is the formula   
\begin{equation}
	\grtofol R = %\textstyle
\left( \bigwedge_{x\in V_R}{x\Eq x} \right) \wedge
\left( \bigwedge_{e\in E_R} \ell_R(e)\bigl(s_R(e),t_R(e)\bigr) \right) \label{eq:psiR}
\end{equation}
Given a well-formed ab-condition $c\in \AC R$ with $c=(R,(a_1,c_1)\ccdots (a_w,c_w))$ and $a_i:R \to P_i$ for each $i \in \{1, \ldots, w\}$, its $\FOL$ encoding is the formula 
\begin{align}
	\tofol c = %\textstyle
  \grtofol R \land 
  \bigvee_{i\in \{1,\ldots,w\}} \left(\exists V_{P_i}\st \grtofol {P_i} \land  \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x)\right) \land  \neg \tofol {c_i}\right)\label{eq:phiC}
\end{align}
\end{definition}

\begin{figure}[t]
  \centering
\begin{tikzpicture}[on grid]
  \node[graph] (10) {\onenode{x}};
  \node[left=0 of 10.west,inner sep=0] {$c$};
  \node[graph,below=of 10] (11) {\oneloopleft{x_1}{b}}; 
  \node[left=0 of 11.west,inner sep=0] {$c_{1}$};
  \node[graph,below left=1 and 1.1 of 11] (111) {\looponeedge{x_2}{b}{a}{y_2}};
  \node[above right=0 of 111.north west,inner sep=1] {$c_{2}$};
  \node[graph,below right=1 and 1.1 of 11] (112) {\looponeedge{x_3}{b}{c}{y_3}};
  \node[above left=0 of 112.north east,inner sep=1] {$c_{3}$};

  \path (10) edge[->] node[left] {$f$} (11)
        (11) edge[->] node[left] {$g$} (111)
        (11) edge[->] node[right] {$h$}(112);
\end{tikzpicture}
\caption{A well-formed ab-condition equivalent to $c_1$ of Example~\ref{ex:ab-conditions}}
\label{ab-condition-c}
\end{figure}

Considering formula \eqref{psiR} note that $\fv(\grtofol R) = V_R$: This is guaranteed by the \emph{identities} of the form $x\Eq x$ in the first conjunct. 

\begin{example}[formula associated with a condition]
As a trivial example, $\grtofol {\disc{\varnothing}} \equiv \True$ because it is the empty conjunction. Instead, for each non-empty discrete graph $\disc{X}$, $\grtofol {\disc{X}} =
\bigwedge_{x\in X}{x\Eq x}$. Note that $\grtofol {\disc{X}} \entails \True$, but $\True  \not \entails \grtofol {\disc{X}}$ because  $\fv(\grtofol {\disc{X}}) = X \not \subseteq \varnothing$. 

  Let's now detail the formula $\tofol {c}$ associated with the condition $c$ of Figure~\ref{ab-condition-c}, a well-formed variant of condition $c_1$ of Example~\ref{ex:ab-conditions}.  We use the names $c,c_1,c_2$ and $c_3$ to denote both the graphs they are attached to, and the conditions rooted at them.

For the four graphs, using \eqref{psiR}, we obtain:

$
\begin{array}{ll}
\grtofol {c} &= x \Eq x\\
\grtofol {c_{1}} &= x_1 \Eq x_1 \land \lb(x_{1},x_{1})\\
\grtofol {c_{2}} &= x_2 \Eq x_2 \land y_2 \Eq y_2 \land \lb(x_{2},x_{2})\land \la(x_{2},y_{2})\\ 
\grtofol {c_{3}} &= x_3 \Eq x_3 \land y_3 \Eq y_3 \land \lb(x_{3},x_{3})\land \lc(x_{3},y_{3})\\
\end{array}
$

\medskip
Now let us consider the four conditions, using \eqref{phiC}, bottom-up: 

$
\begin{array}{ll}
\tofol {c_{2}} & = \tofol {c_{2}} \land \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
\tofol {c_{3}} & =  \vee_{i \in \varnothing} (\ldots) \quad \equiv \quad  \False\\
 \tofol {c_{1}} & = (\exists \{x_{2},y_{2}\} \st \grtofol {c_{2}} \land x_{1} \Eq x_{2} \land \neg \tofol {c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \grtofol {c_{3}} \land x_{1} \Eq x_{3} \land \neg \tofol {c_{3}})\\
 \tofol {c} & = \exists \{x_{1}\}\st \grtofol {c_{1}} \land x \Eq x_{1} \land  \neg \tofol {c_{1}}
\end{array}
$

\medskip
We can simplify $\tofol {c_1}$ as follows: 

$
\begin{array}{ll}
 \tofol {c_{1}} & = (\exists \{x_{2},y_{2}\} \st \grtofol {c_{2}} \land x_{1} \Eq x_{2} \land \neg \tofol {c_{2}}) \vee (\exists \{x_{3},y_{3}\} \st  \grtofol {c_{3}} \land x_{1} \Eq x_{3} \land \neg \tofol {c_{3}})\\
  & \equiv \{\text{replacing $\tofol {c_{2}}$ and $\tofol {c_{3}}$ with their values ($\False$) and evaluating}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st \grtofol {c_{2}} \land x_{1} \Eq x_{2}) \vee (\exists \{x_{3},y_{3}\} \st  \grtofol {c_{3}} \land x_{1} \Eq x_{3})\\
 & \equiv \{\text{replacing $\grtofol {c_{2}}$ and $\grtofol {c_{3}}$ with their values}\}\\
 & \equiv (\exists \{x_{2},y_{2}\} \st x_2 \Eq x_2 \land y_2 \Eq y_2 \land \lb(x_{2},x_{2})\land \la(x_{2},y_{2}) \land x_{1} \Eq x_{2})\quad \vee \\
 & \qquad(\exists \{x_{3},y_{3}\} \st  x_3 \Eq x_3 \land y_3 \Eq y_3 \land  \lb(x_{3},x_{3})\land \lc(x_{3},y_{3}) \land x_{1} \Eq x_{3})\\
& \equiv \{\text{applying the \emph{singleton law}~\eqref{singleton} twice, eliminating $x_2$, $x_3$ and identities}\}\\
& \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{3}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{3}))\\
& \equiv \{\text{$\alpha$-conversion, $\exists$ distributes over $\vee$}\}\\
% & \equiv (\exists \{y_{2}\} \st \lb(x_{1},x_{1})\land \la(x_{1},y_{2})) \lor (\exists \{y_{2}\} \st  \lb(x_{1},x_{1})\land \lc(x_{1},y_{2}))\\
& \equiv \exists \{y\} \st (\lb(x_{1},x_{1})\land \la(x_{1},y)) \lor ( \lb(x_{1},x_{1})\land \lc(x_{1},y))\\
& \equiv \exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y))\\
\end{array}
$

\medskip
The \emph{singleton law} is the following logical equivalence, where $P[^y/_x]$ is formula $P$ where all free occurrences of $x$ are replaced by $y$: 
\begin{equation}
\exists x\st x \Eq y \wedge P \quad \equiv \quad P[^y/_x] \label{eq:singleton}
\end{equation} 
It allows to get rid of an existential quantifier when the quantified variable is equated to a term. As it can be grasped from the current example, this law  has a relevant role in simplifying formulas associated with conditions, because they contain several existentials.

\medskip
Finally for $\tofol c$ we obtain:

$
\begin{array}{ll}
\tofol {c} & = \exists \{x_{1}\}\st \grtofol {c_{1}} \land x \Eq x_{1} \land  \neg \tofol {c_{1}}\\
 & \equiv \{\text{replacing $\grtofol {c_{1}}$ and $\tofol {c_{1}}$ with their values}\}\\
& \equiv \exists \{x_{1}\}\st x_1 \Eq x_1 \land  \lb(x_{1},x_{1}) \land x \Eq x_{1} \land  \neg (\exists \{y\} \st \lb(x_{1},x_{1})\land (\la(x_{1},y) \lor \lc(x_{1},y)))\\
 & \equiv \{\text{eliminating $x_1$ (by the singleton law) and the identity}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \lb(x,x)\land (\la(x,y) \lor \lc(x,y)))\\
 & \equiv \{\text{by standard but lengthy manipulation}\}\\
& \equiv \lb(x,x) \land \neg (\exists \{y\} \st \la(x,y) \lor \lc(x,y))\\
\end{array}
$


which is indeed the $\FOL$ formula anticipated in Example~\ref{ex:ab-conditions}.


\end{example}


As shown below formally, a graph morphism $g: R \to G$ satisfies an ab-condition $c$ according to \dcite{ab-satisfaction} if and only if it satisfies $\tofol c$ according to \dcite{encoding}. Intuitively, in the formula $\tofol c$ defined in~\eqref{phiC}, the disjunction means that there is a branch $i$ such that there is a morphism $h: P_i \to G$ (by $\grtofol {P_i}$), where  $\bigwedge_{x \in V_{R}} x \Eq a_i(x)$ guarantees $g=a_i;h$, and finally $\neg \tofol {c_i}$ ensures $h\nsat c_i$. Let's analise all this in detail.


Considering \eqref{psiR}, formula $\grtofol R$ represents the structure of graph $R$ in the following sense.
\begin{lemma}[properties of $\grtofol R$]
  \label{lem:psi-R}
Given a morphism $m: A \to G$ and a graph $R$, let $\grtofol R$ be defined as in \eqref{psiR}. Then the following are equivalent:
\begin{enumerate} 
  \item $m \sat^\FOL \grtofol R$;
  \item $V_R  \subseteq V_A$ and there is a $j \of R \to G$ such that for each $x \in V_R$ it holds that $m_V(x) = j_V(x)$.
\end{enumerate}
\end{lemma}

\begin{proof}[]
\begin{description}
\item [($1 \Rightarrow  2$)] 
First, observe that $V_R = \fv(\grtofol R) \subseteq V_A$ by  definition of satisfaction. Then define $j\of R \to G$ as follows:
\begin{itemize}
\item $j_V(x) = m_V(x)$ for each $x \in V_R$; 
\item For each $e \in E_R$, $j_E(e) = e'$ where $e' \in E_G$ is an edge of $G$ witnessing that $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$.
\end{itemize}
The well-definedness of morphism $j$ and the fact that it satisfies condition 2 are obvious by construction. 
\item [($2 \Rightarrow  1$)] Given 2, we have to show that $(\dagger)$ for each $x \in V_R$, $m \sat^\FOL x \Eq x$ and $(\ddagger)$ for each $e \in E_R$, $m \sat^\FOL \ell_R(e)(s_R(e),t_R(e))$. Clearly $m \sat^\FOL x \Eq x$ iff $x \in V_A$, therefore $(\dagger)$ is true because $V_R \subseteq V_A$. Concerning $(\ddagger)$, we have to show that there is an edge $e' \in E_G$ with $s_G(e') = m_V(s_R(e))$, $t_G(e') = m_V(t_R(e))$ and $\ell_G(e') = \ell_R(e)$. It is easy to check that setting $e' = j_E(e)$ the required conditions are satisfied. Indeed, $m_V(s_R(e)) = j_V(s_R(e)) = s_G(j_E(e)) = s_G(e')$, similarly for $m_V(t_R(e))$, and $\ell_G(e') = \ell_G(j_E(e)) = \ell_R(e)$.\qed
\end{description}
\end{proof}
%
By using an obviously equivalent diagrammatic representation of condition 2, the lemma says that $m \sat^\FOL \grtofol R$ if and only if there is a morphism $j \of R \to G$ such that the following diagram commutes:
\begin{center}
\begin{tikzpicture}[auto,node distance = 1.5cm]
  \node (vars) {$\disc{V_R}$};
  \node  (A) [above right of=vars]{$A$}
  edge [<-right hook] (vars);
  \node [below right of=A] (G) {$G$}
  edge [<-] node[auto,swap] {$m$} (A);
  \node [below right of=vars] (R) {$R$}
  edge [<-right hook] (vars) 
  edge [->] node[auto,swap] {$j$} (G); 
\end{tikzpicture}
\end{center} 


We can show now that an ab-condition $c$ and the corresponding formula $\tofol c$, as defined in \eqref{phiC}, have exactly the same models.

\begin{proposition}[properties of $\tofol c$]
  \label{pr:same-models}
  Let $c\in \AC R$ be an ab-condition over $R$ and $\tofol c$ be its $\FOL$ encoding as in Def.~\ref{def:encoding}. Given a graph morphism $g: R \to G$ we have
  \[ g \sat c \qquad \iff \qquad g \sat^\FOL \tofol c\enspace.\] 
\end{proposition}

\begin{proof}[]
Let $c=(R,(a_1,c_1)\ccdots(a_w,c_w))$. We proceed by induction on the depth. If $\depth(c) = 0$ we trivially have that neither $c$ nor $\tofol c = \False$ have any model.

Now assume that $\depth(c) = n$ and that the statement holds for any $c'$ with $\depth(c')<n$.

\paragraph{(Only if case - $\Rightarrow$)}

Suppose that $g \sat c$ with responsible branch $p_j = (a_j,c_j)$, with $j \in [1,w]$, and witness $h\of P_j \to G$. By \dcite{ab-satisfaction} we have $(\dagger)~ a_j;h = g$ and $(\ddagger)~ h \not \sat c_j$.
%
We show \eqref{g-sat-exists}, from which the statement follows: 
\begin{equation}
  \label{eq:g-sat-exists}
g\sat^\FOL \exists V_{P_j}\st \grtofol {P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \tofol {c_j}
\end{equation}

Assuming w.l.o.g.~that $R\cap P_j = \varnothing$, let $R \stackrel{in_1}{\hookrightarrow} R \cup P_j$ be the obvious inclusion, and let $R\cup P_j \stackrel{[g,h]}{\longrightarrow} G$ be the only morphism induced by $g$ and $h$. To prove  \eqref{g-sat-exists} we show that 

\begin{equation}
[g,h] \sat^\FOL \grtofol {P_j} \wedge \left(\bigwedge_{x \in V_{R}} x \Eq a_i(x) \right) \land \neg \tofol {c_i}
\end{equation}
\noindent
by considering in turn the three conjuncts, from which \eqref{g-sat-exists} follows by $(\sat^\FOL \exists)$.
% \renewcommand{\labelenumi}{\alph{enumi})} 
\begin{enumerate}
  \item $[g,h] \sat^\FOL \grtofol {P_j}$. By Lemma~\ref{lem:psi-R}, this follows from the following commuting diagram: 
\begin{center}
  \begin{tikzpicture}[auto,node distance = 1.5cm]
    \node (vars) {$\disc{V_{P_j}}$};
    \node  (A) [above right of=vars]{$R\cup P_j$}
    edge [<-right hook] (vars);
    \node [below right of=A] (G) {$G$}
    edge [<-] node[auto,swap] {$[g,h]$} (A);
    \node [below right of=vars] (R) {$P_j$}
    edge [<-right hook] (vars) 
    edge [->] node[auto,swap] {$h$} (G); 
  \end{tikzpicture}
  \end{center} 
  \item $[g,h] \sat^\FOL \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x) \right)$. Let $x \in V_{R}$. %Clearly, $a_j(x) \in V_{P_j}$ for each $x \in V_{R}$. 
  Then $[g,h](x) \stackrel{x\in R}= g(x) \stackrel{(\dagger)}= a_j;h(x) = h(a_j(x)) \stackrel{a_j(x) \in P_j}= [g,h](a_j(x))$. Hence $[g,h] \sat^\FOL x \Eq a_j(x)$. 
  \item $[g,h] \sat^\FOL \neg \tofol {c_j}$. By Lemma~\ref{lem:sat_only_free_vars}, given the following commuting diagram it is sufficient to show that $h\sat^\FOL \neg \tofol {c_j}$.
  \begin{equation}\label{eq:vars-only-2}
    \begin{tikzpicture}[auto,node distance = 1.5cm]
      \node (vars) {$\disc{\fv(\neg \tofol {c_j})}$};
      \node  (A) [above right of=vars]{$P_j$}
      edge [<-right hook] (vars);
      \node [below right of=A] (G) {$G$}
      edge [<-] node[auto,swap] {$\scriptstyle{h}$} (A);
      \node [below right of=vars] (B) {$R \cup P_j$}
      edge [<-right hook] (vars) 
      edge [->] node[auto,swap] {$\scriptstyle{[g,h]}$} (G); 
    \end{tikzpicture}
    \end{equation}
  
  Indeed, since $(\ddagger)~h \not \sat c_j$ by assumption and $\depth(c_j) < n$, by induction hypothesis we have $h\not\sat^\FOL \tofol {c_j}$, i.e., $h\sat^\FOL \neg \tofol {c_j}$. 
\end{enumerate}

\paragraph{(If case - $\Leftarrow$)}
Let $g\of R \to G$ be a morphism and assume that $g \sat^\FOL \tofol c$. Let $j \in [1,w]$ be such that
\[g\sat^\FOL \exists V_{P_j}\st \grtofol {P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \tofol {c_j}\]

As expected, $(a_j\of R \to P_j, c_j)$ will be the responsible branch for $g \sat c$: we have to find a witness morphism from $P_j$ to $G$.
By $(\sat^\FOL \exists)$ there is  graph $B$ (see \eqref{proof4} below)  with $R \subseteq B$ and a morphism $k\of B \to G$ such that $k\restr R = g$ and  
\[k \sat^\FOL \grtofol {P_j} \land \left(\bigwedge_{x \in V_{R}} x \Eq a_j(x)\right) \land  \neg \tofol {c_j}\]

\begin{equation}
  \label{eq:proof4}
  \begin{tikzpicture}[node distance = 2cm]
    \node at (2,0.5) (G) {$G$};
    \node at (0,0) (B) {$B$}
    edge [->] node[auto] {$\scriptstyle{k}$} (G);
    \node at (0,-1) (Pj) {$P_j$}
    edge [->] node[auto,swap]  (h) {$\scriptstyle{h}$}  (G);
    \node at (0,1) (R) {$R$}
    edge [right hook->] (B)
    edge [->] node[auto] {$\scriptstyle{g}$} (G)
    edge [->,bend angle=45,bend right] node[auto,swap] {$\scriptstyle{a_j}$} (Pj);
    \node at (-2,-0.5) (vars) {$\disc{V_{P_j}}$}
    edge [right hook->] (B)
    edge [right hook->] (Pj);
  \end{tikzpicture}
  \end{equation}   

Since $k \sat^\FOL \grtofol {P_j}$, by Lemma~\ref{lem:psi-R} there is a morphism $h: P_j \to G$ such that the lower square in \eqref{proof4} commutes.

We show that from $h$ we can obtain a witness $h'$  for $g \sat c$, i.e.~such that $a_j;h' = g$ and $h' \not \sat c_j$. First, let us show that for each $x \in V_R$ we have $g(x) = h(a_j(x))$. In fact $g(x) \stackrel{g = k\restr R}{=}  k(x) \stackrel{(*)}{=} k(a_j(x)) \stackrel{(\%)}= h(a_j(x))$, where $(*)$ holds because $k\sat^\FOL x\Eq a_j(x)$, and $(\%)$ holds by commutativity of the lower square. Therefore $g = a_j;h$ holds on nodes, but not necessarily on edges: there could be an edge $e \in E_R$ that is mapped to two different edges $g(e)$ and $h(a_j(e))$, which must have the same source and target nodes, and the same label. Let $h'\of P_j \to G$ be defined as $h'_V = h_V$, $h_E(a_j(e)) = g(e)$ for all $e \in E_R$, and $h'(e) = h(e)$ for all $e \in E_{P_j}\setminus a_j(E_R)$. Then by costruction we have $g = a_j ; h'$.

Finally, note that $\fv(\tofol {c_j}) \subseteq V_{P_j}$, Then by Lemma~\ref{lem:sat_only_free_vars} since $k\sat^\FOL \neg \tofol {c_j}$  also $h'\sat^\FOL \neg \tofol {c_j}$. Since $\depth(c_j) < n$, by induction hypothesis $h' \not \sat c_j$, which concludes the proof.
%
\qed
\end{proof}

\subsubsection{From formulas to ab-conditions.} 
The other way around, we start by showing that every $\FOL$ formula $\phi$ generated by the grammar of Def.~\ref{def:graph_formulas} can be encoded as an ab-condition $\abc{\phi}$ having as root $\disc{\fv(\phi)}$, the discrete graph including the free variables of $\phi$, so that $\phi$ and $\abc{\phi}$ have the same morphims with source $\disc{\fv(\phi)}$ as models. Later we show that by exploiting the shift operator of Def.~\ref{def:shift} arbitrary models of $\phi$ are can be captured by $\abc{\phi}$ 



% . Since $g:A \to G \sat^\FOL \phi$ implies that $V_A$ contains the free variables of $\phi$, the root graph of the ab-condition encoding $\phi$ must include $\fv(\phi)$ in the nodes, but can be larger. Therefore with each formula $\phi$ we associate an ``upward-closed'' set of ab-conditions $\abc{\phi}$, all having a discrete root including $\fv(\phi)$. 
% To formalize this, we introduce an operation that adds fresh nodes to the root of a condition, intuitively copying them identically along all branches.

% \begin{definition}[adding nodes to a condition]
%   \label{def:adding-nodes-to-condition}
%   Let $c = (R,(a_1,c_1)\ccdots (a_w,c_w))$ be an ab-condition, and $J$ be a non-empty, finite set disjoint from all graphs in $c$; in particular, $J \cap V_R = \varnothing$. Condition $c \uplus J$ is defined as $c \uplus J = (R \cup \disc{J}, (a_1 \cup id_{\disc{J}}, c_1 \uplus J)\ccdots(a_w \cup id_{\disc{J}}, c_w \uplus J))$. 

%   A set of ab-conditions $\cC$ is \emph{upward closed} if for each $c \in \cC$ and non-empty finite set $J$ disjoint from all graphs in $c$ it holds that $c \uplus J \in \cC$. \todo{AR: disjoint from all graphs in $c$? AC: done} 
% \end{definition}

% Note that $c$ and $c \uplus J$ are incomparable with respect to entailment because they have different roots. Nevertherless, it is easy to prove that  
% for each morphism $m \of R \uplus \disc{J} \to G$,\todo{AC: explict proof? AR: I really think this is immediate}
% \begin{eqnarray}
% m \sat c \uplus J & \iff & m \restr R \sat c \eqlabel{eq:modRestricted}\\
% m\sat^\FOL \tofol c & \iff & m \sat^\FOL \tofol {c\uplus J} \eqlabel{eq:condExpanded}
% \end{eqnarray}

  
\begin{definition}[from formulas to ab-conditions]
  \label{def:from-formulas-to-ab-conditions}
The  \emph{ab-condition encoding a formula $\phi$}, denoted $\abc{\phi}$, is the condition with root $\disc{\fv(\phi)}$ defined by the following inductive clauses: 
\begin{enumerate}[itemsep=1ex]
\item 
If $\phi = \False$, then $ \abc{\phi} = (\disc{\varnothing}, \epsilon)$.
\item If $\phi = \True$, then $ \abc{\phi} = (\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))$.
\item 
If $\phi = x \Eq y$, then $ \abc{\phi} = (\disc{\{x,y\}}, (\{x\mapsto z,y \mapsto z\}, (\disc{\{z\}},\epsilon)))$
\item 
If $\phi = \la(x,y)$, then $ \abc{\phi} = (\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon)))$.
\item 
If $\phi = \neg \phi'$ and $ \abc{\phi'} = (R,p_1\ccdots p_w)$ then $ \abc{\phi} = (R,(id_R, \abc{\phi'}))$.
%$ \abc{\phi} = (R,(id_R, (R,p_1\ccdots p_w)))$.
\item 
If $\phi = \phi_1 \lor \phi_2$ and $ \abc{\phi_1} = (R_1,p_1\ccdots p_w)$, $ \abc{\phi_2} = (R_2,q_1\ccdots q_v)$, then by construction $V_{R_i} = \fv(\phi_i)$ for $i \in \{1,2\}$.  Let $R = \disc{V_{R_1} \cup V_{R_2}}$, with $in_i\of R_i \hookrightarrow R$ for $i \in \{1,2\}$  the obvious injections, and let $\shift{c_1}{in_1} = (R,p'_1\ccdots p'_w)$, $\shift{c_2}{in_2} = (R,q'_1\ccdots q'_v)$ be obtained by shifting the conditions (see Def.~\ref{def:shift}). Then $\abc{\phi} = (R,p'_1\ccdots p'_wq'_1\ccdots q'_v)$. (Note that by construction $R = \disc{\fv(\phi)}$ as required).
\item 
If $\phi = \exists X \st \phi'$ and $ \abc{\phi'} = (R',(a_1,c_1)\ccdots (a_w,c_w))$, then $V_{R'} = \fv(\phi')$. Let $R = \disc{V_{R'} \setminus X}$, and $in \of R \hookrightarrow R'$ be the obvious injection. Then $ \abc{\phi} = \bshift{\abc{\phi'}}{in} = (R,(in;a_1,c_1)\ccdots (in;a_w,c_w))$, is obtained by precomposing $\abc{\phi'}$ with $in$ (see Def.~\ref{def:shift}). (Note that by construction $R = \disc{\fv(\phi)}$ as required.)

\item 
Finally, by exploiting the usual equivalences we define $\abc{\phi_1 \land \phi_2} = \abc{\neg (\neg \phi_1 \lor \neg \phi_2)}$ and $\abc{\forall X\st \phi} = \abc{\neg \exists X \st \neg \phi}$.
\end{enumerate}
\end{definition}
%
The correctness of this encoding is stated as follows.
% \todo{In this form, it does not emerge why we need the upward-closedness. I would like to include a corollary that states something for \emph{any} $g$; maybe $g \sat^\FOL \phi \iff \exists c\in C(\phi)\st g \sat c$?\\ AC: Conceptually this is stated by the last result of the section.}

\begin{proposition}[properties of $\abc{\phi}$]
  \label{pr:same-models-2}
Let $\phi$ be a $\FOL$ formula and $\abc{\phi} = (R, (p_1\ccdots p_w))$ be its encoding as for Def.~\ref{def:from-formulas-to-ab-conditions}. Given a graph morphism $g: R \to G$ we have
 \[ g \sat^\FOL \phi \qquad \iff \qquad g \sat \abc{\phi} \enspace.\] 

\end{proposition}
\begin{proof}[]
We show by induction on depth that each formula $\phi$ is logically equivalent to the $\FOL$ encoding  $\tofol {\abc{\phi}}$  of its associated ab-condition $\abc{\phi}$ (see Defs.~\ref{def:encoding} and~\ref{def:from-formulas-to-ab-conditions}). 
Since by Prop.~\ref{pr:same-models} $\abc{\phi}$ and $\tofol {\abc{\phi}}$ have exactly the same morphisms from $R$ as models, the statement follows. 
% Actually, given \eqref{eq:modRestricted} it is sufficient to prove $\phi \equiv \tofol {c}$ for the generators of sets $\abc{\phi}$ as defined in Def.~\ref{def:from-formulas-to-ab-conditions}.\todo{AC: explain better why?}

\begin{enumerate}[itemsep=1ex]
  \item 
  If $\phi = \False$ then $\abc{\phi} = (\disc{\varnothing}, \epsilon)$. Thus $\tofol {\abc{\phi}}$ is an empty disjunction, which is $\False$. More generally, $\tofol c \equiv \False$ for every ab-condition $c = (R,\epsilon)$ with an empty list of branches. 
  
  \item If $\phi = \True$ then $\abc{\phi}  = (\disc{\varnothing}, (id_{\disc{\varnothing}},(\disc{\varnothing},\epsilon)))$. Thus 
  \[\tofol {\abc{\phi}} = \bigvee_{i \in \{1\}}  \exists \varnothing\st \grtofol {\disc{\varnothing}} \land \True' \land \neg \tofol {(\disc{\varnothing},\epsilon)} \quad \equiv \quad \True.\] 
  In fact  $\True'$ arises from an empty conjunction,  the existential over an empty set can be dropped, $\grtofol {\disc{\varnothing}} = \True$ (see \eqref{psiR}), and $\tofol {(\disc{\varnothing},\epsilon)} = \False$ by the previous point.
  \item 
If $\phi = x \Eq y$ then $\abc{\phi} = (\disc{\{x,y\}}, (\{x\mapsto z,y \mapsto z\}, (\disc{\{z\}},\epsilon)))$. Thus 
\[\tofol {\abc{\phi}} = \bigvee_{i \in \{1\}}  \exists \{z\} \st  \grtofol {\disc{\{z\}}} \land (x \Eq z \land y \Eq z) \land \neg \tofol {(\disc{\{z\}},\epsilon)}.\]
 Since $ \grtofol {\disc{\{z\}}} = (z\Eq z) \equiv \True$ (see \eqref{psiR}) and $\tofol {(\disc{\{z\}},\epsilon)} \equiv \False$ by point 1, $\tofol {\abc{\phi}}$ is equivalent to $\exists \{z\} \st  x \Eq z \land y \Eq z$, which in turn is equivalent to $x \Eq y$, as desired, by the singleton law~\eqref{singleton}.

\item 
If $\phi = \la(x,y)$ then  $\abc{\phi} = (\disc{\{x,y\}}, (\{x\mapsto x',y \mapsto y'\}, (\inline{\oneedge{x'}{a}{y'}},\epsilon)))$. Thus 
\[\tofol {\abc{\phi}}  = \bigvee_{i \in \{1\}}  \exists \{x', y'\} \st  \grtofol {\inline{\oneedge{x'}{a}{y'}}} \land (x \Eq x' \land y \Eq y') \land \neg \tofol {(\inline{\oneedge{x'}{a}{y'}},\epsilon)}.\] 
We have $ \grtofol {\inline{\oneedge{x'}{a}{y'}}}  = \la(x',y')$ by \eqref{psiR}, and  $\tofol {(\inline{\oneedge{x'}{a}{y'}},\epsilon)} = \False$ by point 1, thus $\tofol {\abc{\phi}} \equiv \exists \{x', y'\} \st   \la(x',y') \land x \Eq x' \land y \Eq y'$. By a first application of the singleton law  $\tofol {\abc{\phi}} \equiv \exists \{y'\} \st   \la(x,y')  \land y \Eq y'$, and by a second application $\tofol {\abc{\phi}} \equiv \la(x,y)$, as desired.
\item 
If $\phi = \neg \phi'$ and $\abc{\phi'} = (R,p_1\ccdots p_w)$ then $\abc{\phi} = (R,(id_R, \abc{\phi'}))$. To avoid variable capturing, let $c'' = (R',p'_1\ccdots p'_w)$ be a renamed-apart version of $\abc{\phi'}$ obtained by replacing each item $x$ with $x'$. Let $c = (R,(id'_R, c''))$, where $id'_R(x) = x'$.   Then\todo{AC: Should it be stressed somewhere that if $c \cong c'$ (they are isomorphic) then $\tofol c \equiv \tofol {c'}$?}
\[\tofol {\abc{\phi}} \equiv \tofol c = \bigvee_{i \in \{1\}}  \exists V_{R'} \st \grtofol {R'} \land \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big) \land \neg \tofol {c''}.\] 
Note that 
the effect of $\exists V_{R'} \st  \big(\bigwedge_{x \in V_R} x \Eq id'_R(x)\big)$, by repeated applications of the singleton law, consists of applying the substitution $x' \mapsto x$ to the remaining quantified formulas, i.e. $\grtofol {R'} \land \neg \tofol {c''}$, thus obtaining $\tofol {\abc{\phi}} \equiv \grtofol {R} \land \neg \tofol {c''}$. Formula $\grtofol {R}$ is trivially satisfied by any candidate model, which must be a morphism with $R$ as source, thus $\tofol {\abc{\phi}} \equiv \neg \tofol {c''} \equiv \neg \tofol {\abc{\phi'}}$. By induction hypothesis we have $\phi' \equiv \tofol {\abc{\phi'}}$, thus $\tofol {\abc{\phi}} \equiv \neg \tofol {\abc{\phi'}} \equiv \neg \phi' = \phi$, as desired.

% If $\phi = \neg \phi'$ and $c' = (R,p_1\ccdots p_w)\in \abc{\phi'}$, let $c = (R,(id_R, c'))$. Then $\tofol c = \bigvee_{i \in \{1\}}  \exists V_R \st \grtofol R \land \big(\bigwedge_{x \in V_R} x \Eq id_R(x)\big) \land \neg \tofol {c'}$. 
\item 
If $\phi = \phi_1 \lor \phi_2$, let $\abc{\phi_1} = (R_1,p_1\ccdots p_w)$ and $\abc{\phi_2} = (R_2,q_1\ccdots q_v)$. By definition $\abc{\phi} = (R,p'_1\ccdots p'_wq'_1\ccdots q'_v)$, where 
$R = \disc{V_{R_1} \cup V_{R_2}}$ and the branches are the concatenation of those of $\shift{c_1}{in_1}$ and $\shift{c_2}{in_2}$. Since formula \eqref{phiC} is a disjunction over all the branches, we have $(\dagger)\ \tofol {\abc{\phi}} =  \tofol {\shift{\abc{\phi_1}}{in_1}} \lor \tofol {\shift{\abc{\phi_2}}{in_2}}$. Furthermore, $(\ddagger)\ \tofol {\abc{\phi}} \equiv \tofol {\shift{\abc{\phi}}{in}}$ (at least for all models $m$ from $\disc{\fv(\shift{\abc{\phi}}{in})}$)***.\todo{AC: No, not convincing, check it!} Therefore\\

$\begin{array}{lll}
  \tofol {\abc{\phi_1 \lor \phi_2}} & \equiv & (\dagger)\\
  \tofol {\shift{\abc{\phi_1}}{in_1}} \lor \tofol {\shift{\abc{\phi_2}}{in_2}}& \equiv & (\ddagger)\\
  \tofol {\abc{\phi_1}} \lor \tofol {\abc{\phi_2}} & \equiv &\text{by induction hypothesis}\\
  \phi_1 \lor \phi_2 & = & \phi 
\end{array}
$

% $c_1 = (R,p_1\ccdots p_w) \in \abc{\phi_1}$, and $c_2 = (R,q_1\ccdots q_v) \in \abc{\phi_2}$. Let $c = (R,p_1\ccdots p_wq_1\ccdots q_v)$. We have to show that $\tofol c \equiv \phi_1 \lor \phi_2$. This is obvious, by exploiting the induction hypothesis ($\phi_1 \equiv \tofol {c_1}$ and $\phi_2 \equiv \tofol {c_2}$) and given that $\tofol c$ is a disjunction over the set of branches of $c$ (which is the union of branches of $c_1$ and $c_2$) of formulas that depend only on the branch itself and of the root graph $R$, which is the same for $c$, $c_1$ and $c_2$.\\
% Def of $\abc{\phi_1 \lor \phi_2}$\\
% If $\phi = \phi_1 \lor \phi_2$ and $\abc{\phi_1} = (R_1,p_1\ccdots p_w)$, $ \abc{\phi_2} = (R_2,q_1\ccdots q_v)$, then by induction hypothesis $V_{R_i} = \fv(\phi_i)$ for $i \in \{1,2\}$.  Let $R = \disc{V_{R_1} \cup V_{R_2}}$, $in_i\of R_i \hookrightarrow R$ for $i \in \{1,2\}$ be the obvious injections, and $\shift{c_1}{in_1} = (R,p'_1\ccdots p'_w)$, $\shift{c_2}{in_2} = (R,q'_1\ccdots q'_v)$ be obtained by shifting the conditions along the corresponding injections (see Def.~\ref{def:shift}). Then $\abc{\phi} = (R,p'_1\ccdots p'_wq'_1\ccdots q'_v)$, and by construction $R = \disc{\fv(\phi)}$.
\item 
If $\phi = \exists X \st \phi'$ and $\abc{\phi'} = (R',(a_1,c_1)\ccdots (a_w,c_w))$, 
$ \abc{\phi} = \bshift{\abc{\phi'}}{in} = (R,(in;a_1,c_1)\ccdots (in;a_w,c_w))$, where $R = \disc{V_{R'} \setminus X}$, and $in \of R \hookrightarrow R'$. 

We show that $\tofol  {\abc{\phi}} \equiv\exists X\st \tofol {\abc{\phi'}}$, and conclude by induction hypothesis. Note that $\tofol c$ and $\tofol {\abc{\phi'}}$ are almost identical, only differing for the conjuction of equalities, which ranges over $V_{R'}$ in $\tofol {\abc{\phi'}}$ ($\bigwedge_{x\in V_{R'}} x \Eq a_i(x)$) and over $V_{{R'}\setminus \disc{X}} = V_{R'} \setminus X$ in $\tofol {c}$ ($\bigwedge_{x\in {V_{R'}\setminus X}} x \Eq a_i(x)$).\todo{AC: formalize this better.} By repeated applications of the singleton law one obtains that $\exists X\st \bigwedge_{x\in V_{R'}} x \Eq a_i(x)\quad \equiv \quad \bigwedge_{x\in {V_{R'}\setminus X}} x \Eq a_i(x)$.\footnote{For example, $\exists x\st x \Eq f(x) \wedge y \Eq f(y) \quad \equiv \quad  y \Eq f(y)[^{f(x)}/_x] \quad \equiv \quad  y \Eq f(y)$.}
Thus we can conclude observing that the existential quantification on $X$ in $\exists X\st \tofol {\abc{\phi'}}$ can be pushed inside the disjunction (by a $\FOL$ law), and it does not affect the other formulas like $\psi_i$ or $\neg \phi_i$, assuming that the condition is well formed (therefore $X$ is disjoint from all the graphs in the branches).  
\end{enumerate}
\end{proof}

We conclude this section by showing that the encoding of formulas via ab-conditions is complete, i.e., that for each formula $\phi$ its encoding $\abc{\phi}$ captures all models of $\phi$, not only those having as source the discrete graph including the free variables of $\phi$. This is achieved by exploiting the shift operator of Def.~\ref{def:shift}.

\begin{proposition}[completeness of encoding of formulas via shift]
\label{pr:completenessShift}
Let $\phi$ be a $\FOL$ formula, and $\abc{\phi}$ its encoding. For each graph $A$ such that $\disc{\fv(\phi)} \stackrel{in}{\hookrightarrow} A$ it holds that $m\of A \to G$ is a model of  $\phi$ if and only if $m$ is a model of $\shift{\abc{\phi}}{in}$. 
\end{proposition}

\begin{proof}[]

  $\begin{array}{lll}
    m \sat^{\FOL} \phi & \iff & \text{ by Lemma~\ref{lem:sat_only_free_vars}}\\
    in;m \sat^{\FOL} \phi & \iff & \text{ by  Prop.~\ref{pr:same-models-2}}\\
    in;m \sat \abc{\phi} & \iff & \text{ by Prop.~\ref{pr:shiftSat}}\\
    m \sat \shift{\abc{\phi}}{in}
  \end{array}
  $
\end{proof}
  

