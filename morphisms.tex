\section{Morphisms of arrow-based conditions}

The notion of \emph{morphism} of nested conditions has not received much attention in the literature. Given the fact that an ab-condition is essentially a diagram in the category $\bC$, it is natural to think that a morphism from $b$ to $c$ should essentially be a morphism between their diagrams, involving arrows from objects of $b$ to objects of $c$ such that all subdiagrams commute. This intuition turns out to be not entirely correct, however, given that we also want morphisms to \emph{preserve ssatisfaction} (in a precise sense, formalised below). 
For that to be the case, we need a notion of morphism that plays well with the second clause of \dcite{ab-satisfaction}, in which there is a negation: the witness $h$ should \emph{not} satisfy the subcondition $c_i$ of the chosen branch $p_i$. This explains why in the morphisms we are going to introduce, at each subsequent level the (sub)conditions are related by arrows going in the \emph{opposite} direction.

As it turns out, the criterion of preservation of satisfaction can be guaranteed in more than one way. That is, we have two independent candidate notions of morphism: one in which (a subset of) the arrows going back and forth between the condition diagrams are required to be \emph{retractions} and one in which they have to be \emph{epis} --- each with slightly different commutation conditions. For the sake of completeness we present both; in the sequel, we will adopt the retraction-based morphisms, for reasons that will be explained.

\subsection{Retraction-based morphisms}

Recall that, in any category, given an arrow $r: A \to B$ a \emph{section} for $r$ is an arrow $s: B \to A$ such that $s;r = id_B$. In this case $r$ is called a \emph{retraction} (for $s$). It is easily shown that $r$ is then epi.

\begin{definition}[arrow-based condition morphism]\dlabel{ab-morphism}
  Given two ab-conditions $b$ and $c$, an \emph{arrow-based condition morphism} $m: b \to c$ is a triple $(t,o,m_1\ccdots m_{|b|})$ where
  \begin{itemize}
    \item $t:R^b\func R^c$ is an arrow, called the \emph{top-level arrow} of $m$;
	\item $o:[1,|b|]\to[1,|c|]$ is a function from $b$'s branches to $c$'s branches;
  \item for all $1\leq i\leq |b|$, $m_i:c_{o(i)}\to b_i$ is an ab-morphism with top-level arrow $t_i$
  \end{itemize}
such that, moreover, for all $1\leq i\leq |b|$ there is a section $s_i:R^c\to R^b$ for $t$ (meaning $s_i;t=\id$) satisfying
\begin{equation}\eqlabel{ab-morphism}
s_i;a^b_i=a^c_{o(i)};t_i \enspace.
\end{equation}
\end{definition}
%
Hence, a morphism consists of a \emph{top} arrow $t$ from the root of the source condition to that of the target condition, and for each branch $p^b_i$ of the source condition a \emph{backward} morphism $m_i$ from the subcondition of a branch $p^c_{o(i)}$ of the target condition to the subcondition of $p^b_i$, such that there is a section of $t$ making the square composed with the top arrow of $m_i$ commute.

Pictorially, $m$ can be visualised as in \fcite{ab-morphism}. We use $t^m$ to denote the top arrow of morphism $m:b\to c$. Note that if $|b|>0$, then $t^m$ is a retraction, as it must have at least one section.  The dashed arrows $s_1, \ldots, s_w$ are the required sections for $t$, one for each $1\leq i\leq |b|$: they may be distinct but don't need to be distinct.  
%
\begin{figure}
  \centering
  \input{figs/ab-morphism}
  \caption{Pictorial representation of an arrow-based condition morphism $m:b\func c$, with $b=(R^b,p^b_1\ccdots p^b_w)$ and $m = (t,o,m_1\ccdots m_w)$. For each $1 \leq i \leq w$, $s_i$ is the section of $t$ required by the definition.}
  \flabel{ab-morphism}
\end{figure}

\medskip\noindent Morphisms have the expected properties: identities and composition exist and the categorical laws are satisfied, thus arrow-based conditions and their morphisms form a category.
%

\begin{proposition}[category \cat{AB-Cond}]
  The category $\cat{AB-Cond}$ having arrow-based conditions (\dcite{ab-condition}) as objects and arrow-based condition morphisms (\dcite{ab-morphism}) as arrows is well-defined.
\end{proposition}
 
\begin{proof}
  Given an ab-condition $c=(R,p_1\ccdots p_w)$, the identity morphism $\id_c:c\func c$ is defined as $(\id_R,\id_{[1,w]},\id_{c_1}\ccdots\id_{c_w})$: the required commutativity trivially holds since $\id_R$ is a section for itself.
  
Given two ab-condition morphisms $m:b\func c$ and $n:c\func e$, their composition is defined as $m;n=(t^m;t^n,o^m;o^n,(n_{o^m(1)};m_1)\ccdots (n_{o^m(w)};m_{w}))$ (where $w=|b|$). The well-definedness of $m;n$ can be proved in a standard way, also considering that if $s^m$ is a section for $t^m$ and $s^n$ is a section for $t^n$, then $s^n;s^m$ is a section for $t^m;t^n$.

The identity laws and associativity of composition can be proved in a standard way. \qed
\end{proof}
%
With this notion of morphism, we have the desired preservation of satisfaction, in the following sense.

\begin{proposition}[ab-condition morphisms preserve satisfaction]
  \plabel{ab-preserve-satisfaction}
Let $b$ and $c$  be arrow-based conditions. If $m:b\func c$ is an ab-condition morphism, then $t^m;g\sat b$ implies $g \sat c$ for all arrows $g:R^c\func G$.
\end{proposition}
%
\emph{Proof.} By induction. Assume that for all $1\leq i\leq |b|$, the property holds for $m_i:c_{o(i)} \to b_i$. Let $p_i$ be the responsible branch and $h: P^b_i \to G$ the witness for $t^m;g\sat b$. 
Hence we have $(\dagger)\, t^m; g=a_i;h$ and $h \nsat c_i$.  Now let $q \in \cB_c$ be the source branch of $m_{p}$, and $s_i$ be the section for $t^m$ such that $(\star)\, s_i;a^b_i = a^c_{o(i)}; t_i$. 
We show that $p^c_{o(i)}$ itself is a responsible branch and $(\ddagger)\, h'=t_i;h$ a witness for $g\sat c$, namely that 
\begin{itemize}
\item $g = a^c_{o(i)};h'$: In fact, $a^c_{o(i)};h' =\!(\ddagger)\ a^c_{o(i)};t_i;h =\!(\star)\ s_i;r^b_i; h  =\!(\dagger)\ s_i;t^m;g = g$. 
\item $h' \nsat c_{o(i)}$: In fact, since there is an ab-condition morphism $m_i: c_{o(i)} \to b_i$, if $h'= t_i;h \sat c_{o(i)}$ then by the induction hypothesis we can infer that $h \sat b_i$, contradicting the hypothesis. \qed
\end{itemize}

It is noteworthy that the models for $b$ and $c$ are not the \emph{same} ones --- in general they cannot be, as $b$ and $c$, having different roots, actually express properties of different domains (the arrows from $R^b$ and $R^c$, respectively). However, the morphism $m$ establishes $t^m:R^b\func R^c$, and the proposition then states that for any arrow from $R^b$ \emph{that factors through $t^m$}, satisfaction of $b$ (by that arrow) implies satisfaction of $c$ by ``the remainder after $t^m$''.

\subsection{Epi-based morphisms}

The definition of ab-condition morphisms of \dcite{ab-morphism} is strongly motivated by results presented later in the paper, but is by no means the only possible one. Still assuming that at each level arrows relating the roots of the conditions should flip direction, a possibly simpler definition of condition morphism is obtained by requiring the top-level arrow to be \emph{epi}, rather than for it to have a section for every branch. For want of a better term, we call these morphisms \emph{simple}.\todo{I am not convinced that introducing the hardly used notion of simple morphism makes this more understandable} In this subsction, we refer to the notion of morphism introduced earlier as \emph{retraction-based}, to contrast them with the epi-based morphisms below.

\begin{definition}[simple arrow-based condition morphism]\dlabel{simple ab-morphism}
  Given two ab-conditions $b,c$, a \emph{simple ab-condition morphism} $m$ from $b$ to $c$ is a triple $(t,o,m_1\ccdots m_{|b|})$ where
    \begin{itemize}
    \item $t:R_b\func R_c$ is the top-level arrow of $m$;
	\item $o:[1,|b|]\to[1,|c|]$ is a function from $b$'s branches to $c$'s branches;
  \item for all $1\leq i\leq |b|$, $m_i:c_{o(i)}\to b_i$ is a simple ab-morphism
  \end{itemize}
  such that, moreover, for all $1\leq i\leq |b|$, if $t_i$ is the top-level arrow of $m_i$ then
  \begin{equation}\eqlabel{simple ab-morphism}
  t;a^c_{o(i)};t_i=a^b_i \enspace.
  \end{equation}
  A simple morphism is called \emph{epi-based} if all the arrows composing it (relating the roots of (sub)conditions) are epi.
\end{definition}
%
Ab-conditions and simple condition morphisms again form a category, as do ab-conditions and epi-based morphisms.
% denoted \cat{AB$^\to$-Cond}, while by \cat{AB$^\twoheadrightarrow$-Cond} we denote the category having the same objects but only epi-based morphisms.
In general, simple morphisms do not preserve satisfaction, as shown in \excite{non-surjective-mapping}. However, epi-based morphisms do preserve satisfaction, making them potentially interesting to study.

\begin{proposition}\plabel{epi-based implies entailment}
  Let $b,c$ be arrow-based conditions. If $m:b\func c$ is an epi-based condition morphism, then $t^m;g\sat b$ implies $g \sat c$ for all arrows $g:R^c\func G$.
\end{proposition}
%
\begin{proof}
By induction. Assume that for all $1\leq i\leq |b|$, the property holds for $m_i$. Let $p$ be the responsible branch and $h$ the witness for $t^m;g\sat b$; hence $(\dagger)\, t^m;g=a^b_i;h$ and $h\nsat c_i$. We show that $p^c_{o(i)}$ is a responsible branch and $(\ddagger)\, h'=t_i;h$ a witness for $t^m;g\sat p^c_{o(i)}$. In fact, 
  \begin{itemize}
  \item $g = a^c_{o(i)};h'$: for, $t^m;a^c_{o(i)};h' =\!(\ddagger)\, t^m;a^c_{o(i)};t_i;h =\!\eqcite{epi-based}\, a^b_i; h =\!(\dagger)\, t^m;g$, from which  $g = a^c_{o(i)};h'$ follows because $t^m$ is epi. 
  \item $h'\nsat p^c_{o(i)}$: as in the proof of \pcite{ab-preserve-satisfaction}.\qed
  \end{itemize}
\end{proof}
%
Even though both retraction-based morphisms and epi-based ones preserve satisfaction, they are incomparable: if two conditions are related by one kind of morphisms they are not necessarily related by the other kind. In other words, if we consider the existence of a morphism as ``explaining'' some cases of entailment of conditions, then these two types of morphism are complementary. This is shown by the following two examples.
%
\begin{figure}
\centering
\subcaptionbox
  {A retraction-based morphism where there is no epi-based one
   \flabel{retraction-no-epi}
  }
  {\input{figs/ex-retraction-no-epi}}
  \qquad
\subcaptionbox
  {An epi-based morphism where there is no retraction-based one
   \flabel{epi-no-retraction}
  }
  {\input{figs/ex-epi-no-retraction}}
\caption{Retraction-based versus epi-based morphisms}
\flabel{retraction versus epi}
\end{figure}
%
\begin{example}\exlabel{retraction-no-epi}
\fcite{epi-no-retraction} shows two ab-conditions between which there exists an retraction-based morphism (shown in the figure) but no epi-based one.
\begin{itemize}
\item $c_1$ encodes the property $\lb(z,x)$, in a context where we know $\la(x,y)\wedge \la(x,z)$;
\item $c_2$ also encodes $\lb(z,x)$, but now in a context where we (only) know $\la(x,z)$.
\end{itemize}
The top-level arrow $t$ modifies the context of $c_1$ to that of $c_2$ by equating $y=z$; the existence of the morphism $(t,\setof{1\mapsto 1},v)$ with $s;t=\id$ and $s;a_1=a_2;v$ implies that, in that modified context, $c_1$ implies $c_2$ --- which is obviously correct. However, no epi-based morphism exists, since $t$ is the only arrow from $R^{c_1}$ to $R^{c_2}$ and the requirement for an epi-based morphism is that $t;a_2;w=a_1$ for some arrow $w$, which cannot be satisfied because $a_1(x)\neq a_1(z)$ whereas $(t;a_2)(x)=(t;a_1)(z)$.
\end{example}
%
\begin{example}\exlabel{epi-no-retraction}
\fcite{epi-no-retraction} shows two ab-conditions between which there exists an epi-based morphism (shown in the figure) but no retraction-based one.
\begin{itemize}
\item $c_3$ encodes the property $\lc(y,x)\wedge y=z$, in a context where $\la(x,y)\wedge \lb(z,z)$;
\item $c_4$ encodes the property $\exists z.\lc(z,x)$, in a context where $\la(x,y)\wedge \lb(y,y)$.
\end{itemize}
The top-level arrow $t'$ modifies the context of $c_3$ to that of $c_4$ by equating $y=z$; the existence of the epi-based morphism $(t',\setof{1\mapsto 1},v')$ with $a_3=t';a_4;v'$ implies that, in that modified context, $c_3$ implies $c_4$ --- which is clearly correct. However, no retraction-based morphism exists, since $t'$ (which is the only arrow from $R^{c_3}$ to $R^{c_4}$) is not a retraction.
\end{example}
%
Further comparing the two notions of morphism, note that retractions are epi in any category, but not vice versa: for example, in \cat{Graph} there are epis which do not have a section (an example being $t'$ in \fcite{epi-no-retraction}). Therefore, asking for the existence of a section is a stronger condition than being an epi, suggesting that every retraction-based morphism may be epi-based, but certainly not vice versa. However, this also fails to be the case, for two reasons:
%
\begin{itemize}
\item The existence of a section (in retraction-based morphisms) is only required when the source condition has branches, whereas our definition of epi-based morphism asks for all arrows to be epi.
\item The commutativity requirement for epi-based morphisms is stronger than the one for retraction-based morphisms: if there is a section $s_i: R_c \to R_b$ for $t$, then \eqcite{simple ab-morphism} implies \eqcite{ab-morphism} but not the other way around.
\end{itemize}
%
While the discrepancy in the first bullet could be resolved by only requiring those arrows in an epi-based morphism to be epi that start in a condition with sub-branches (this does not invalidate the proof of \pcite{epi-based implies entailment}), the second is more fundamental. Fur instance, in \excite{retraction-not-epi}, no epi-based morphism $m:c_1\to c_2$ exists, even under this relaxed condition.

%$t;a^c_{o(i)};t_i=a^b_i$ (as in simple \dcite{ab-morphism}) implies $s_i; a^b_i = a^c_{o(i)}; t_i$ (as in \dcite{ab-morphism}. 

Simple morphisms will not be studied further in the remainder of this paper.
