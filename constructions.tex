\section{Constructions on span-based conditions}


% \subsection{Interface enrichment: A satisfaction invariant trasformation}

\begin{itemize}
  \item Shift of span-based conditions along an arrow $\shift{c}{f}$
  \item Back-shift of condition along an arrow $\bshift{c}{f}$, performing pullbacks of interfaces. 
  \item Back-shift preserves satisfaction 
  \item Prof: shift preserves and reflects satisfaction
  \item Interface enlargement: given  branch $p$ and interface decomposition $u = k;u'$, we build branch with up-arrow $u'$ taking the pushout for the down arrow, and shiting the subconditions.
  \item Proposition: Interface enlargement preserves and reflects satisfaction.
  \item Interface reduction: take subinterface $I' \subseteq I$ and look for POC of $\subseteq ; d$. If it exists, back-shift all subconditions. 
  \item ``Perfect'' interface reduction: when $I'$ is the minimal one such that all subconditions back-shift identically. This guarantees existence of morphism from the original to the new one. 
\end{itemize}  

The category of span-based conditions and their morphisms provides a framework 
where one could define several constructions on conditions, typically described using categorical construction. Some of such constructions are presented in this section, and for each of them we explore whether it preserves and/or reflects satisfaction. All along the section, ``condition'' means by default ``span-based condition'', and similar for morphisms. 

For conditions $b$ and $c$, let us write $b \leq_t c$ if there exists a morphism $m: b \to c$ with top arrow $t$. Thus by \pcite{sb-morphism preserves satisfaction} we have
\begin{equation}
    \label{eq:morphPresSat}
    b \leq_t c \quad \mbox{  implies  }\quad  t;g \sat b \implies g \sat c
\end{equation}

\begin{definition}[shifting a condition along an arrow]
    Let $c = (A,p_1\cdots p_w)$ be a condition over $A$ and $f: A \to B$ be an arrow. Then $\shift{c}{f}$, the \emph{shift of $c$ along $f$} is the condition over $B$ defined as:
    \begin{itemize}
        \item $\shift{c}{f} = (B, p'_1\cdots p'_w)$
        \item $p'_i = \{(u_i;f,d_i,c_i) \mid 1\leq i\leq w\}$.
     \end{itemize}
\end{definition}
We will show later that shifting preserves and reflects satisfaction, in the following sense: 
\begin{equation}
    \label{eq:shiftPresReflSat}
    f;g \sat c \quad \iff\quad  g \sat \shift{c}{f}
\end{equation} 

Note that shifting a condition only affects the upper leg of the top level spans, which are composed with $f$. A condition can also be shifted backwards along an arrow having its root as target. In this case the interfaces of the branches are affected, by not their subconditions.  

\begin{definition}[back-shifting a condition along an arrow]
    Let $c = (B,p_1\cdots p_w)$ be a condition over $B$ and $f: A \to B$ be an arrow. Then $\bshift{c}{f}$, the \emph{back-shift of $c$ along $f$} is the condition over $A$ defined as:
    \begin{itemize}
        \item $\bshift{c}{f} = (A, p'_1\cdots p'_w)$
        \item $p'_i = \{(u'_i,f'_i;d_i,c_i) \mid 1\leq i\leq w \mbox{ and } (u'_i,f'_i) \mbox{ is a pullback of } (f,u_i)\}$.
     \end{itemize}
\end{definition}

Back-shifting a condition preserves satisfaction, but in general does not reflect it.

\begin{proposition}[back-shifting preserves satisfaction]
\dlabel{bshift_preserves_sat}
\begin{equation}
    g \sat c \quad \implies \quad f;g \sat \bshift{c}{f}
\end{equation}    
\end{proposition} 
\emph{Proof sketch.} Note that back-shifting preserves the conditions of the branches of $c$. Then the witness for $g \sat c$ is also a witness for $f;g \sat \bshift{c}{f}$. The resulting diagram is easily shown to commute because a pullback commutes.

In general the converse implication does not hold.\todo{AC: example where $A = \varnothing$. Then $\bshift{c}{f}$ quantifies existentially all free variables of $c$} However, it does if all the components $f'_i$ in the pullbacks are epi:
\begin{equation}
    \label{eq:bshiftPresSat}
    \mbox{if $f'_i$ is epi for each $(u'_i,f'_i;d_i,c_i)$ in $\bshift{c}{f}$ then }
    \quad f;g \sat \bshift{c}{f}
     \quad \implies g \sat c
\end{equation}
In categories like \cat{Set}, \cat{Graph} and presheaf toposes in general, where pullbacks are constructed pointwise, it is sufficient that $f$ is epi to ensure this property.

Shift and back-shift are not inverse each other in general, but a weaker relation holds.

\begin{proposition}
    Given a condition $c$ and an arrow $f:R_c \to B$ there is a morphism of conditions from $c$ to the result of first shifting $c$ along $f$, and then back-shifting the resulting condition along $f$, namely:
\begin{equation}
    \label{eq:shift-bshift}
    \bshift{\shift{c}{f}}{f} \leq_{id_{R_c}} c
\end{equation}    
\end{proposition}
\emph{Proof.} Exploits the use of pullbacks in back-shifting.

\begin{proposition}
    Equation \eqref{eq:shiftPresReflSat} follows from \eqref{eq:morphPresSat}, \eqref{eq:shift-bshift} and \eqref{eq:bshiftPresSat}.
\end{proposition}
