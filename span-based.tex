\section{Span-based conditions}

The peculiar definition of morphisms of ab-conditions just introduced, with arrows changing direction at each layer in order to ensure the preservation of models, clashes with a structural property of arrow-based conditions, namely the fact that the pattern of each subcondition contains a copy of the parent pattern because a branch consists of an arrow of $\cat{C}$ from the latter to the former. Thus if a morphism maps, say, the pattern $P^b$ of (a subcondition) of $b$ to a pattern $P^c$ of $c$, at the next layer (the copy of) $P^c$ must be mapped backwards to (the copy) of $P^b$. The consequence is that morphisms fail to exist even in very simple situations.\todo{AC: refer to an example?}
  
Inspired by these observation, we present now one main contribution of this paper: an original definition of nested condition where the duplication of structure just described does not appear, because at each level we can specify only the \emph{additional} structure (and how it is connected). This is achieved by replacing the branch arrows $a^c_i$ of a condition $c$ by \emph{spans}.\footnote{We discuss and contrast an alternative way to resolve the same issue, using \emph{cospans} rather than spans, later in this paper.}\todo{AC: Remove the footnote and add a sentence in the future work section.}

% We now present the main idea of this paper, inspired by on the observation that arrow-based conditions over graphs contain a lot of duplication: the children of a node essentially contain all the structure of that (parent) node, and add some constraints on top of it. It turns out to be possible to avoid this duplication by only specifying the \emph{additional} structure (and how it is connected). This is achieved by replacing the branch arrows $a^c_i$ of a condition $c$ by \emph{spans}.\footnote{We discuss and contrast an alternative way to resolve the same issue, using \emph{cospans} rather than spans, later in this paper.}\todo{AC: Remove the footnote and add a sentence in the future work section.}

A span $s = (f: I \to A, g:I \to B)$ over \cat{C}, that we will denote $\spanof f g$, is a pair of arrows of \cat{C} having the same source. Objects $A$ and $B$ are the \emph{source} and \emph{target} of $s$, respectively, while $I$ is its \emph{interface}. Spans can be composed: if the target of $\spanof u d$ is equal to the source of $\spanof v w$, then $\spanof u d;\spanof v w=\spanof{v';u}{d';w}$ where $\spanof {v'}{d'}$ is the pullback span of $(d,v)$. The result is defined, because \cat{C} has all pullbacks, but non-deterministic in general because pullbacks are defined up to iso. The standard solution would be to consider spans up to isomorphism of their interface (yielding category {\SpanC} having the same objects of \cat{C} and equivalence classes of spans as arrows), but to avoid further technicalities we will gloss over this along the paper.
An arrow $a:A \to B$ can be seen as a span $\spanof{id_A}{a}$. This defines an embedding of standard arrows of \cat{C} into spans over \cat{C} that preserves composition. Composing an arrow with a span, as in $a ; \spanof f g$, is intended to mean $\spanof{id}{a}  ; \spanof f g$.\todo{delete if not used}

\medskip
Span-based conditions are inductively defined as follows:

\begin{definition}[span-based condition]\dlabel{sb-condition}
  For any object $R$ of $\bC$, $\SC R$ (the set of \emph{span-based conditions} over $R$) and $\SB R$ (the set of \emph{span-based branches} over $R$) are the smallest sets such that
  \begin{itemize}
  \item $c\in \SC R$ if $c=(R,p_1\ccdots p_w)$ is a pair with $p_i\in \SB R$ for all $1\leq i\leq w$;
  \item $p\in \SB R$ if $p=(\spanof u d,c)$ where $u: I\to R, d:I\func P$ form a span of arrows of $\bC$ and $c\in \SC P$.
  \end{itemize}
\end{definition}
%
In the span $\spanof u d$ of a branch $p=(\spanof u d,c)$, $u$ stands for the \emph{up-arrow} and $d$ for the \emph{down-arrow}. As before, we use $|c|=w$ to denote the width of a span-based condition $c$, $R^c$ to denote its root, and $p^c_i=(s^c_i,c_i)$ with span $s^c_i=\spanof{u^c_i}{d^c_i}$ its $i$-th branch. Finally, we use $I^c_i$ for the interface of span $s^c_i$ and $P^c_i$ ($=R^{c_i}$) for its target (hence $u^c_i:I^c_i\func R^c$ and $d^c_i:I^c_i\rightarrow P^c_i$). In all these cases, we may omit the superscript $c$ if it is clear from the context. Pictorially, $c$ can be visualised as in \fcite{sb-condition}.
%
\begin{figure}
\centering
\subcaptionbox
  {Condition $c=(R,p_1\ccdots p_w)$, with $p_i=(\spanof{u_i}{d_i},c_i)$ for $1\leq i\leq w$
   \flabel{sb-condition}}
  [.4\textwidth]
  {\input{figs/sb-condition}}
\qquad
\subcaptionbox
  {$g\sat c$, with responsible branch $p_i=(\spanof{u_i}{d_i},c_i)$ and witness $h$ such that $\spanof{u_i}{d_i}\commutes (g,h)$
   \flabel{sb-satisfaction}}
  [.4\textwidth]
  {\input{figs/sb-satisfaction}}
\caption{Visualisation of span-based conditions}
\end{figure}
%
As we will see later, we can reconstruct an arrow-based condition from a span-based one by taking pushouts over the spans $\spanof{u_i}{d_i}$; the arrows $a_i$ will then correspond to the image of $d_i$ in the pushout cospan.

\medskip\noindent The careful reader might have observed that \dcite{sb-condition} is essentially \dcite{ab-condition} instantiated to the category {\SpanC}. But first, this would not fall in our framework because {\SpanC} is not a presheaf topos even if \cat{C} is, and second, the definitions that follow (satisfaction, morphisms, \ldots) are phrased using arrows and diagrams of \cat{C}, not of {\SpanC}. \todo{exchange 1 and 2}

We now present the modified notion of satisfaction for span-based conditions. First we recognise that the purpose of an arrow $a$ in an ab-condition is essentially to establish ``correct" model/witness pairs $(g,h)$ --- namely, those pairs that commute with $a$ in the sense of satisfying $g=a;h$. We may write $a\commutes (g,h)$ to express this commutation relation. This is what we now formalise for spans, as follows:
\[ \spanof u d \commutes (g,h) \text{ if } u;g=d;h \enspace. \]
Satisfaction of sb-conditions is then defined as follows:

\begin{definition}[satisfaction of span-based conditions]\dlabel{sb-satisfaction}
  Let $c$ be a span-based condition and $g:R\func G$ an arrow from $c$'s root to an object $G$. We say that \emph{$g$ satisfies $c$}, denoted $g\sat c$, if there is a branch $p_i$ and an arrow $h:R_i\func G$ such that
  \begin{enumerate*}
  \item $s_i \commutes (g, h)$, and
  \item $h\nsat c_i$.
  \end{enumerate*}
\end{definition}
%
Note that this is entirely analogous fo \dcite{ab-satisfaction}, especially if we would retrofit the notation $a\commutes (g,h)$ there. Like before, we call $p_i$ the \emph{responsible branch} and $h$ the \emph{witness} of $g\sat c$. Satisfaction of sb-conditions is visualised in \fcite{sb-satisfaction}.

To conclude this section let us observe that there is an obvious embedding of arrow-based conditions into span-based conditions, and that it preserves the models. Simply, given a condition $c \in \AC {R}$, define $\cS(c)\in \SC R$ inductively by replacing every branch $(a_i,c_i)$ of $c$ with $(\spanof{id_R}{a_i},\cS(c_i))$. 
The result is a span based condition, and it is easily shown that for each $g:R \to G$ we have that $g \sat c$ with witness $h$, by \dcite{ab-satisfaction}, if and only if $g \sat \cS(c)$ with the same witness, by \dcite{sb-satisfaction}. This embedding will be turned into a functor after defining morphisms of span-based conditions.\todo{to be checked.} 

\subsection{Span-based root shifting}

To define morphisms of sb-conditions, we will go over the same ground as for ab-conditions, but take a slightly more abstract view --- as we did for satisfaction by introducing $\commutes$. Having recognised that the \emph{semantics} of a span in sb-conditions is essentially given by the set of model/witness pairs that it commutes with, we can now in general consider relations over spans that either preserve or reflect their semantics, in the sense that if $s_1,s_2$ are related, then either $s_1\commutes (g,h)$ implies $s_2\commutes (g,h)$ (preservation) or $s_2\commutes (g,h)$ implies $s_1\commutes (g,h)$ (reflection). Typically, however, the model/witness pairs are not preserved or reflected precisely, but modulo some arrow that gets added to or erased from the model or witness. Thus:
%
\begin{itemize}
\item $(s_1,s_2)$ preserves models adding $v$ if $s_1\commutes (g,h)$ implies $s_2\commutes (v;g,h)$;
\item $(s_1,s_2)$ preserves models erasing $v$ if $s_1\commutes (v;g,h)$ implies $s_2\commutes (g,h)$;
\item $(s_1,s_2)$ reflects models adding $v$ if $s_2\commutes (g,h)$ implies $s_1\commutes (v;g,h)$;
\item $(s_1,s_2)$ reflects models erasing $v$ if $s_2\commutes (v;g,h)$ implies $s_1\commutes (g,h)$.
\end{itemize}
%
The above is defined on individual pairs. For a relation $\cR$ over spans, we say that $\cR$ preserves [reflects] models adding [erasing] $v$ if it consists of pairs that do so.

To extend \eqcite{shifters are functors} from arrows to spans, we also need to consider span composition. This is defined as usual: $\spanof u d;\spanof v w=\spanof{v';u}{d';w}$ where $(v',d')$ is the pullback span of $(d,v)$.\footnote{Technically, this is only well-defined if we consider spans up to isomorphism of their middle objects; we will gloss over this here.}

\begin{definition}[span source shifters]
Let $X,Y$ be objects. A \emph{span source shifter} $\cS$ from $X$ to $Y$ is a function from $X$-sourced spans to $Y$-sourced spans having the same target, say $Z$, such that for all spans $s:X\to Y,t:Y\to Z$:
%
\begin{equation}\eqlabel{span shifters are functors}
\cS(s;t) = \cS(s);t \enspace.
\end{equation}
%
Now let $v=A\to B$ be an arrow. $\cS$ is a \emph{forward span source shifter for $v$} if it is a span source shifter from $A$ to $B$ that preserves models erasing $v$, i.e., such that for all spans $s:A\to C$ and all and all pairs $g:A\to G,h:C \to G$:
%
\begin{equation}\eqlabel{sb-forward condition}
s\commutes (v;g,h) \enspace\text{ implies }\enspace \cS(s) \commutes (g,h) \enspace.
\end{equation}
%
A forward span source shifter is called \emph{complete} if it also reflects models adding $v$; i.e., if the ``implies" in \eqref{eq:sb-forward condition} is an ``if and only if".

Instead, $\cS$ is a \emph{backward span source shifter for $v$} if it is a span source shifter from $B$ to $A$ that reflects models erasing $v$, i.e., such that for all spans $s:B\to C$ and all pairs $g:B\to G,h:C\to G$:
%
\begin{equation}\eqlabel{sb-backward condition}
\cS(s) \commutes (v;g,h) \enspace\text{ implies }\enspace s\commutes (g,h) \enspace.
\end{equation}
%
A backward span source shifter is called \emph{complete} if it also preserves models adding $v$; i.e., if the ``implies" in \eqref{eq:sb-backward condition} is an ``if and only if".
\end{definition}
%
Span source shifters extend to root shifters (of span-based conditions) exactly as in the arrow-based case. Before showing how this gives rise to morphisms, however, let us investigate the possible instantiations of span source shifters.

Since span source shifters from $X$ are, just as in the arrow-based case, completely determined by $\cS(\id_X)$ (due to \eqref{eq:span shifters are functors}), we can enumerate the choices of forward and backward shifters for $v$ that are generally available (without having additional information about $v$).
%
\begin{description}
\item[Forward shifting.] For $\cS$ to be a forward span source shifter for $v:A\to B$, there must be a span $t=\cS(\id_A):B\to A$, which automatically determines $\cS(s)=t;s$ for all $s:A\to C$. There are essentially two options: $t=\spanof{v}{\id_B}$ or $t=\spanof{\id_A}{x}$ for some section $x$ of $v$, i.e., such that $x;v=\id_B$. We denote the resulting span source shifters by $\cF_v^\circ$ and $\cF_v^x$, respectively.

\item[Backward shifting.] For $\cS$ to be a backward span source shifter for $v:A\to B$, there must be a span $t=\cS(\id_B):A\to B$, which automatically determines $\cS(s)=t;s$ for all $s:B\to C$. Again, there are essentially two options: $t=\spanof{\id_A}{v}$, or $t=\spanof{x}{\id_B}$ for some section $x$ of $v$, i.e., such that $x;v=\id_A$. We denote the resulting span source shifters by $\cB_v^\circ$ and $\cB_v^x$, respectively.
\end{description}
%
These options are depicted in \fcite{sb-source shifters} (in a simplified construction that omits the intermediate steps of the span composition where possible). We call $\dcF v$ and $\dcB v$ \emph{direct shifters} and $\rcF v x$ and $\rcB v x$ \emph{retraction-based shifters}. It turns out that, indeed, each of these four options gives rise to a valid shifter.
%
\begin{figure}
\centering
\input{figs/sb-source-shifting}
\caption{Forward and backward span source shifters. In each case, $\spanof{u'}{d'}$ is the image of $\spanof{u}{d}$.}
\flabel{sb-source shifters}
\end{figure}
%
\begin{proposition}[span source shifters]\plabel{sb-source shifters}
\begin{enumerate}
\item $\cF_v^\circ$ is a complete forward span source shifter for $v$, and $\cF_v^x$ is a forward span shifter for $v$ if $x$ is a section of $v$.
\item $\cF_v^\circ$ is a complete backward span source shifter for $v$ if $v$ is epi, and $\cF_v^x$ is a backward span shifter for $v$ if $x$ is a section of $v$.
\end{enumerate}
\end{proposition}

\begin{proof}
In the proof, we make use of the diagrams (especially the arrow names) in \fcite{sb-source shifters}.
\begin{enumerate}
\item We first show that $\cF_v^\circ$ is a complete forward span source shifter. Let $g:B\to G$ and $h:C\to G$; then $\spanof{u}{d}\commutes (g,h)$ and $\spanof{u'}{d'}\commutes (g,h)$ are both equivalent to $u;v;g=d;h$, hence they are equivalent to one another. It follows that $\cF_v^\circ$ both  preserves models erasing $v$ and reflects models adding $v$.

We now show that $\cF_v^x$ is a forward source shifter, i.e., that it preserves models erasing $v$. Let $g:B\to G$ and $h:C\to G$ be such that $\spanof{u}{d}\commutes (v;g,h)$, meaning $u;v;g=d;h$. It follows that $x';u;v;g=x';d;h$ and hence $u';g=u';x;v;g=d';h$, hence $\spanof{u'}{d'}\commutes (g;h)$.

\item We first show that $\cB_v^\circ$ is a complete backward span source shifter for $v$ if $v$ is epi. First note that in toposes the pullback of an epi is epi; hence, as already indicated in the figure, $v'$ is epi. Now let $g:B\to G$ and $h:C\to G$; then $\spanof{u}{d}\commutes (g,h)$ comes down to $u;g=d;h$ whereas $\spanof{u'}{d'}\commutes (v;g,h)$ comes down to $u';v;g=d';h$, which is equivalent to $v';u;g=v';d;g$. Because $v'$ is epi, $u;g=d;h$ if and only if $v';u;g=v';d;g$, implying that $\cB_v^\circ$ both reflects models erasing $v$ and preserves models adding $v$.

We now show that $\cB_v^x$ is a backward span source shifter for $v$, i.e., that it reflects models erasing $v$. Let $g:B\to G$ and $h:C\to G$ be such that $\spanof{u'}{d'}\commutes (v;g,h)$, meaning $u';v;g=d';h$. It follows that $u;g=u;x;v;g=u';v;g=d';h=d;h$, hence $\spanof u d\commutes (g,h)$.\qed
\end{enumerate}
\end{proof}
%
The ability to forward-shift and backward-shift in many different ways means that there are equally many options for building morphisms. In fact, however, we will show later that all above root shifters for $v$ (both forward and backward) are subsumed by $\cF_v^\circ$, in the sense that entailment or equivalence of sb-conditions ``explained" by morphisms based on any of the (other) known root shifters can also be ``explained" by morphisms based on $\cF_v^\circ$.

The step from span source shifters to span root shifters is completely identical to the arrow-based case; we omit the definition here. Span root shifters satisfy the analogous properties of arrow root shifters formulated in Propositions \pref{ab-root shifters preserve} and \pref{ab-shifters compose}, extended with the case of complete shifters. As the proofs are essentially identical, we omit them here.\todo{AR: do you agree?}

\begin{proposition}[span root shifters preserve models]\plabel{ab-root shifters preserve}~
Let $v:A\to B$.
\begin{enumerate}[topsep=\smallskipamount]
\item If $c\in \SC A$ and $\cF$ is a forward span root shifter for $v$ that is defined on $c$, then $v;g\sat c$ implies $g\sat \cF(c)$. If, moreover, $\cF$ is complete then also $g\sat \cF(c)$ implies $v;g\sat c$.
\item If $c\in \SC B$ and $\cB$ is a backward span root shifter for $v$ that is defined on $c$, then $v;g\sat \cB(c)$ implies $g\sat c$. If, moreover, $\cF$ is complete then also $v;g\sat \cF(c)$ implies $g\sat c$.
\end{enumerate}
\end{proposition}

\begin{proposition}[span shifters compose]\plabel{sb-shifters compose}
\begin{enumerate}[topsep=\smallskipamount]
\item If $\cU$ is a span source [root] shifter from $X$ to $Y$ and $\cV$ a span source [root] shifter from $Y$ to $Z$, then $\cU;\cV$ (understood as partial function composition) is a span source [root] shifter from $X$ to $Z$. 
\item If $\cU$ and $\cV$ are [complete] forward span source [root] shifters for $u: X\to Y$ and $v: Y \to Z$, respectively, then $\cU;\cV$ is a [complete] forward source [root] shifter for $u;v$.
\item Dually, if $\cU$ and $\cV$ are [complete] backward span source [root] shifters for $u: Y\to X$ and $v: Z \to Y$, respectively, then $\cU;\cV$ is a [complete] backward span source [root] shifter for $v;u$.
\end{enumerate}
\end{proposition}

\subsection{Span-based morphisms}

A final change with respect to the arrow-based case is that we also abstract the commutation condition in \dcite{ab-morphism} by relying instead on a family of \emph{pattern shift relations} --- which essentially complement the root shifters regarding their role in morphisms.
%
\begin{definition}[pattern shift]
Let $v:P_1\to P_2$ be an arrow. \emph{Pattern shift for $v$} is a relation $\cP_v$ over spans $(s_1,s_2)$ such that, letting $s_i=\spanof{u_i:I_i\to A}{d_i:I_i\to P_i}$ for $i=1,2$ (for any $A$), there is an arrow $k:I_1\to I_2$ for which both halves of the following diagram commute:
\begin{equation}\eqlabel{pattern shift}
\begin{tikzpicture}[on grid,baseline=(I1.center)]
\node (A) {$A$};
\node (I1) [below left=1 and 1.5 of A] {$I_1$};
\node (P1) [below=1.5 of I1] {$P_1$};
\node (I2) [below right=1 and 1.5 of A] {$I_2$};
\node (P2) [below=1.5 of I2] {$P_2$};
\path
  (I1) edge[->] node[above left,inner sep=1] {$u_1$} (A)
  (I1) edge[->] node[left] {$d_1$} (P1)
  (I2) edge[->] node[above right,inner sep=1] {$u_2$} (A)
  (I2) edge[->] node[right] {$d_2$} (P2);
\path[morphism]
  (P1) edge[->] node[above] {$v$} (P2);
\path[red,color=red]
  (I1) edge[->] node[below] {$k$} (I2);
\end{tikzpicture}
\end{equation}
\emph{Conservative pattern shift for $v$} is the subrelation $\ccP_v\subseteq \cP_v$ consisting of span pairs for which, in addition, the lower square of \eqref{eq:pattern shift} is a pushout.
\end{definition}
%
The following lists some essential properties of pattern shifting.

\begin{proposition}[pattern shift properties]\plabel{pattern shift}
Let $v:P_1\to P_2$ be an arrow, and let $(s_1,s_2)\in \cP_v$.
\begin{enumerate}[topsep=\smallskipamount]
\item\label{pattern-preserves} For all arrows $g,h$, if $s_2\commutes (g,h)$ then $s_1\commutes (g,v;h)$;
\item\label{pattern-transitive} For all arrows $t:P_2\to P_2$, if $(s_2,s_3)\in \cP_t$ than  $(s_1,s_3)\in \cP_{v;t}$;
\item\label{pattern-congruence} For all spans $s$, if $s;s_1$ and $s;s_2$ are defined then $(s;s_1,s;s_2)\in \cP_v$.
\end{enumerate}
If $(s_1,s_2)\in \ccP_v$, then in addition:
\begin{enumerate}[resume,topsep=\smallskipamount]
\item\label{conservative-reflects} For all arrows $g,h$, if $s_1\commutes (g,h)$ then $h=v;h'$ such that $s_2\commutes (g,h')$;
\item\label{conservative-transitive} For all arrows $t:P_2\to P_2$, if $(s_2,s_3)\in \ccP_t$ then $(s_1,s_3)\in \ccP_{v;t}$;
\item\label{conservative-congruence} For all spans $s=\spanof{a}{\id}$, if $s;s_1$ and $s;s_2$ are defined then $(s;s_1,s;s_2)\in \ccP_v$.
\end{enumerate}
\end{proposition}
%
\begin{proof}
Let $v:P_1\to P_2$ and $t:P_2\to P_3$ be arrows, and let $(s_1,s_2)\in \cP_v$. Let $s_i=\spanof{u_i:I_i\to A}{d_i:I_i\to P_i}$ for $i=1,2,3$.
\begin{enumerate}[topsep=\smallskipamount]
\item Assume $s_2\commutes (g,h)$, hence $u_2;g=d_1;h$. It follows that $u_1;g=k;u_2;g=k;d_1;h=d_2;v;h$, hence $s_1\commutes (g,v;h)$.

\item Assume $(s_2,s_3)\in \cP_{t}$; hence there are $k_v$ and $k_t$ making the pentagons of \eqcite{pattern shift} commute for $v$ and $t$, respectively. Then $k_v;k_t$ likewise satisfies the role of $k$ in \eqref{eq:pattern shift} for $v;t$. If, moreover, the lower square of the constituent pentagons (for $v$ and $t$) are pushouts, then by pushout composition so is the lower square of the composed pentagon, which establishes clause \ref{conservative-transitive}.

\item Let $s=\spanof{b:J\to B}{a:J\to A}$. The following figure shows the pentagon obtained for $(s;s_1,s;s_2)$.
\begin{center}
\begin{tikzpicture}[on grid]
\node (A) {$A$};
\node (J1) [left=1.5 of A] {};
\node (J2) [right=1.5 of A] {};
\node (I1) [below left=1 and 1.5 of A] {$I_1$};
\node (P1) [below=of I1] {$P_1$};
\node (I2) [below right=1 and 1.5 of R] {$I_2$};
\node (P2) [below=of I2] {$P_2$};
\path
  (I1) edge[->] node[above left,near end,inner sep=1] {$u_1$} (A)
  (I1) edge[->] node[left] {$d_1$} (P1)
  (I2) edge[->] node[above right,near end,inner sep=1] {$u_2$} (A)
  (I2) edge[->] node[right] {$d_2$} (P2);
\path[morphism]
  (P1) edge[->] node[above] {$v$} (P2);
\path
  (I1) edge[->] node[above] {$k$} (I2);

\node (J) [above=1.5 of A] {$J$};
\node (B) [above=of J] {$B$};
\node (J1) [below left=1 and 1.5 of J,inner sep=1pt] {$J_1$};
\node (J2) [below right=1 and 1.5 of J,inner sep=1pt] {$J_2$};
\path (J) edge[->] node[right] {$b$} (B)
      (J) edge[->] node[right] {$a$} (A)
	  (J1) edge[->] node[above left,inner sep=1] {$u'_1$} (J)
	  (J2) edge[->] node[right] {$a_2$} (I2)
	  (J2) edge[->] node[above right,inner sep=1] {$u'_2$} (J)
	  (J1) edge[->] node[left] {$a_1$} (I1);
\path (J1) edge[-{Straight Barb[black,length=6pt,width=17pt]},white] +(5mm,-2.5mm);
\path (J2) edge[-{Straight Barb[black,length=6pt,width=17pt]},white] +(-5mm,-2.5mm);

\path[red,color=red]
  (J1) edge[->] node[near start,below] {$k'$} (J2);
\end{tikzpicture}
\end{center}
%
Given that $J_2$ is the pullback object of $(a,u_2)$ and $u'_1;a=a_1;u_2=a_1;k;u_2$, the red $k'$ uniquely exists such that $k';u'_2=u'_1$ and $k';a_2=a_1;k$. Hence $k'$ satisfies the properties of the required mediating morphism between $s;s_1=\spanof{u'_1;b}{a_1;d_1}$ and $s;s_2=\spanof{u'_2;b}{a_2;d_2}$.
\end{enumerate}
%
Now let $(s_1,s_2)\in \ccP_v$.
%
\begin{enumerate}[resume,topsep=\smallskipamount]
\item Assume $s_1\commutes (g,h)$ for $g:A\to G,h:P_1\to G$, hence $u_1;g=d_1;h$. It follows that $k;u_2;g=d_1;h$, hence by the pushout property of the lower square of \eqref{eq:pattern shift} there is a unique $e:P_2\to G$ such that $u_2;g=d_2;e$ and $h=v;e$, implying $s_2\commutes (g,e)$.

\item Shown as part of the proof of clause \ref{pattern-transitive} above.

\item In the case where $s=\spanof{a}{\id_A}$ for some arrow $a$, the composition $s;s_i$ is simply $\spanof{a;u_i}{d_i}$. The lower square of the pentagon \eqref{eq:pattern shift} for $(s;s_1,s;s_2)$ is then the same as that for $(s_1,s_2)$, hence it is a pushout.
\qed
\end{enumerate}
\end{proof}
%
Hence pattern shift preserves models (clause \ref{pattern-preserves}) and conservative pattern shift reflects models (clause \ref{conservative-reflects}), both ``modulo" the arrow $v$; both pattern shift and conservative pattern shift are transitively closed (module the arrow: clauses \ref{pattern-transitive} and \ref{conservative-transitive}) and both pattern shift and conservative pattern shift are a congruence with respect to span prefixing (clauses \ref{pattern-congruence} and \ref{conservative-congruence}).

For the analogy with the arrow-based case, let $\cA_v=\setof{(a_1,a_2)\mid a_2=a_1;v}$; this constitutes a set of ``arrow pattern shift pairs" that play exactly the role captured by clause \ref{pattern-preserves}, but with respect to the satisfaction relation of ab-conditions. The conservative case (which we did not go into for ab-morphisms) would correspond to $\ccA_v=\setof{(a_1,a_2)\in \cA\mid a_1=a_2;x \text{ with } x;v=\id}$.

Using pattern shift, we define morphisms over sb-conditions as follows.
%
\begin{definition}[span-based (complete) condition morphism]\dlabel{sb-morphism}
  Given two sb-conditions $b,c$, a \emph{forward-shift [backward-shift] sb-morphism} $m:b\to c$ is a pair $(o,(v_1,m_1)\ccdots (v_{|b|},m_{|b|}))$ where
  \begin{itemize}[topsep=\smallskipamount]
  \item $o:[1,|b|]\to [1,|c|]$ is a function from $b$'s branches to $c$'s branches;
  \item for all $1\leq i\leq |b|$, $v_i:P^c_{o(i)}\to P^b_i$ is a arrow from the pattern of $p^c_{o(i)}$ to that of $p^b_i$ such that $(s^c_{o(i)},s^b_i)\in \cP_{v_i}$;
  \item \emph{Forward shift:} for all $1\leq i\leq |b|$, there is a forward root shifter $\cF_i$ for $v_i$ such that $m_i:\cF_i(c_{o(i)})\to b_i$ is a forward-shift morphism;
  \item \emph{Backward shift:} for all $1\leq i\leq |b|$, there is a backward root shifter $\cB_i$ for $v_i$ such that $m_i:c_{o(i)}\to \cB(b_i)$ is a backward-shift morphism.
  \end{itemize}
  The morphism $m$ is called \emph{complete} if $o$ is surjective, $(s^c_{o(i)},s^b_i)\in \ccP_{v_i}$ for all $1\leq i\leq |b|$, and $\cF_i$ [$\cB_i$] is complete.
\end{definition}
%
Note that only direct (forward or backward) root shifters are complete, hence complete morphisms can only use direct root shifters.

On of the most essential properties of morphisms is that they preserve models and, in the case of complete morphisms, also reflect models. This is the analogous property of \pcite{ab-morphisms preserve models}, extended with the case for completeness.
%
\begin{proposition}[sb-condition morphisms preserve models]
                   \plabel{sb-morphisms preserve models}
Let $b,c \in \SC{R}$ be span-based conditions. If $m:b\func c$ is an sb-morphism, then $g\sat b$ implies $g \sat c$ for all arrows $g:R\func G$. Moreover, if $m$ is complete, then also $g\sat c$ implies $g\sat b$ for all $g$.
\end{proposition}
%
\begin{proof}
By induction on the depth of $m$. If $m:b\func c$ is an sb-morphism and $g\sat b$, then let $p^b_i$ be the responsible branch and $h$ the witness such that $\spanof{u^b_i}{d^b_i}\commutes (g,h)$ and $h\nsat b_i$, and let $j=o(i)$. Since $(s^c_j,s^b_i)\in \cP_{v_i}$, it follows by \pcite{pattern shift}.\ref{pattern-preserves} that $\spanof{u^c_j}{d^c_j}\commutes (g,v_i;h)$. Now assume (ad absurdum) that $v_i;h\sat c_j$.
\begin{itemize}[topsep=\smallskipamount]
\item For the forward-shift case, 
\item For the backward-shift case,
\end{itemize}
If $m$ is complete and $g\cat c$, then let $p^c_j$ be the responsible branch and $h$ the witness such that $\spanof{u^c_j}{d^c_j}\commutes (g,h)$ and $h\nsat c_j$. Let $i$ be such that $j=o(i)$ (which exists because $o$ is surjective). Since $(s^c_j,s^b_i)\in \ccP_{v_i}$, it follows by \pcite{pattern shift}.\ref{conservative-reflects} that $\spanof{u^b_i}{d^b_i}\commutes (g,h')$ for some $h'$ such that $h=v;h'$.
\begin{itemize}[topsep=\smallskipamount]
\item For the forward-shift case, 
\item For the backward-shift case,
\end{itemize}
\end{proof}
%
Given the number of possible forward and backward shifters we identified, it would seem that there is a lot of choice within the concept of a morphism, possibly making them complex to reason about. However, the following result states that we actually only have to consider direct forward shifting.
%
\begin{proposition}\plabel{sb-forward only}
Let $b,c$ be sb-conditions.
\begin{enumerate}[topsep=\smallskipamount]
\item If $m$ is a [complete] forward-shift morphism from $b$ to $c$, then $m$ is also a [complete] forward-shift morphism using only direct forward root shifters.
\item If $m$ is a [complete] backward-shift morphism from $b$ to $c$, then there is an sb-condition $c'$ such that $m$ is a [complete] forward-shift morphism from $b$ to $c'$ using only direct forward root shifters, and there is a complete forward-shift morphism from $c$ to $c'$.
\end{enumerate}
\end{proposition}
%
This is a consequence of the following lemma.
%
\begin{lemma}~
Let $b\in\SC(A)$, $c\in\SC(B)$ be sb-conditions, and let $v:A\to B$ be an arrow.
\begin{enumerate}[topsep=\smallskipamount]
\item There is a complete forward-shift morphism from $c$ to $\dcF v(\dcB v(c))$.
\item For any section $x$ of $v$, $\dcF v(\rcB v x(c))=c$.
\item If $m$ is a forward-shift morphism from $\rcF v x(b)$ to $c$, then $m$ is a forward-shift morphism from $\dcF v(b)$ to $c$.
\end{enumerate}
\end{lemma}
%
\begin{proof}
\todo{AR: to be redone.} The result follows by induction on the depth of $m$ from the following separate observations, in which $v:R_1\to R_2$, $t:P_2\to P_1$ and $s_i:R_i\to P_i$ for $i=1,2$ are arbitrary, and $x$ is an arbitrary section of $v$.
\begin{enumerate}[topsep=\smallskipamount]
\item $(s_1,\cB_v^\circ(s_2))\in \cP_t$ implies $(\cF_v^\circ(s_1),s_2)\in \cP_t$ and $(s_1,\cB_v^\circ(s_2))\in \hat\cP_t$ implies $(\cF_v^\circ(s_1),s_2)\in \hat\cP_t$.

\item $(s_1,\cB_v^x(s_2))\in \cP_t$ implies $(\cF_v^\circ(s_1),s_2)\in \cP_t$.

\item $(\cF_v^x(s_1),s_2)\in \cP_t$ implies $(\cF_v^\circ(s_1),s_2)\in \cP_t$.
\qed
\end{enumerate}
\end{proof}
%
Motivated by \pref{sb-forward only}, from now on we drop the qualifiers ``forward-shift" and ``backward-shift" and just talk about (sb-)morphisms, always meaning those that are based on direct forward shifting.

\begin{theorem} 
Let $\SBC$ and $\SBC^\circ$ be the categories having sb-conditions as objects and sb-morphims, respectively complete sb-morphisms, as arrows. These are well-defined, and there are identity-on-objects functors $\SBC \to \SBC^{\entails}$ and $\SBC^\circ \to \SBC^{\equiv}$.
\end{theorem}

\subsection{From arrow-based to span-based and back}

\emph{There is a faithful, semantics-preserving functor from $\ABC$ to $\SBC$, as well as a semantics-preserving mapping from sb-conditions to ab-conditions. Every sb-condition is provably equivalent to an ab-condition (i.e., they are $\cong$-related).}

\subsection{Normal forms}


%
\begin{center}
\input{figs/completeness}
\end{center}
%
We write $t^m$ and $o^m$ for the components of $m$, and (for all $1\leq i\leq |b|$) $t^m_i$ ($=t_{m_i}$) for the top-level arrow of $m_i$ --- often omitting the superscript $m$ if it is clear from the context. Pictorially, $m$ can be visualised as in \fcite{sb-morphism}.
%
\begin{figure}
  \centering
  \input{figs/sb-morphism}
  \caption{Pictorial representation of a span-based condition morphism $m:b\func c$ (with $w=|b|$ and $m=(t,o,m_1\ccdots m_w)$)}
  \flabel{sb-morphism}
\end{figure}

\medskip\noindent Again, span-based condition morphisms have the expected properties: identities and composition exist and the categorical laws are satisfied, thus span-based conditions and their morphisms form a category.

\begin{proposition}[category \cat{SB-Cond}]
  The category $\cat{SB-Cond}$ having span-based conditions (\dcite{sb-condition}) as objects and span-based condition morphisms (\dcite{sb-morphism}) as arrows is well-defined. In addition, identities in $\cat{SB-Cond}$ are complete, and complete morphisms compose.
\end{proposition}
 
\begin{proof}
  Given an sb-condition $c=(R,p_1\ccdots p_w)$, the identity morphism $\id_c:c\func c$ is inductively defined as $(\id_R,\id_w,\id_{c_1}\ccdots \id_{c_w})$: the required commutativity properties trivially hold by choosing $k_i=\id_{I_i}$. By construction, $\id_c$ is complete.
  
Given two ab-condition morphisms $m:b\func c$ and $n:c\func e$, their composition is defined as $m;n=(t^m;t^n,o^m;o^n,(n_{o^m(1)};m_1)\ccdots (n_{o^m(w)};m_{w}))$ (where $w=|b|$).
The well-definedness of $m;n$ can be proved in a standard way, choosing as intermediate morphisms $k_i=k^n_{o(i)};k^m_i$ for all $1\leq i\leq w$. If $m$ and $n$ are complete, so is $m;n$ (due to the fact that $o^m;o^n$ is surjective if both $o^m$ and $o^n$ are, and that pushouts compose).

The identity laws and associativity of composition can be proved in a standard way. \qed
\end{proof}
%
With this notion of morphism, we not only have the desired preservation of satisfaction, but also reflection of satisfaction in case of completeness, in the following sense:
%
\begin{proposition}[morphisms preserve satisfaction]\plabel{sb-morphism preserves satisfaction}
Let $b$ and $c$ be span-based conditions. If $m:b\func c$ is an sb-condition morphism, then $t;g\sat b$ implies $g\sat c$ for all arrows $g:R^c\to G$. Moreover, if $m$ is complete then also the converse is true: $g\sat c$ implies for $t;g\sat b$ all arrows $g:R^c\to G$.
\end{proposition}
%
\begin{proof}
By induction. Assume that $p_i$ is the responsible branch of $b$ and $h^b\colon R_{c_p}\func G$ the witness for $t;g\sat b$; hence the induction hypothesis implies that the proposition holds for $c_{o(i)}$, and moreover, $u^b_i;t;g=d^b_i;h^b$ and $h^b\nsat b_i$. Moreover, let $j=o(i)$ and let $k\colon I^c_j\func I^b_i$ be as required in \dcite{sb-morphism}. This is visualised in \fcite{sb-morphism preserves satisfaction}.
%
\begin{figure}
  \centering
  \input{figs/sb-morphism-preserves-satisfaction}
  \caption{Pictorial representation of \pref{sb-morphism preserves satisfaction}: if $m:b\rightarrow c$ is an sb-morphism, then $t;g\sat b$ implies $g\sat c$}
  \flabel{sb-morphism preserves satisfaction}
\end{figure}

Now $h^c=t_i;h^b$ can be shown to satisfy the conditions for $h$ in \dcite{sb-satisfaction} to be a witness for $g\sat c$, with responsible branch $p^c_j$:
\begin{enumerate}
\item $u^c_j;g = k_i;u^c_i;t;g= k_i;d^b_i;h^b = d^c_j;t_i;h^b=d^c_j;h^c$.
\item Suppose that $h^c\sat c_j$, meaning $t_i;h^b\sat c_j$; then by the induction hypothesis and the fact that $m_i$ is a morphism from $c_j$ to $b_i$, it follows that $h^b\sat b_i$, which is in contradiction with the initial assumption of this proof. Hence $h^c\nsat c_j$.
\end{enumerate}
%
Now assume that $m$ is complete and $g\sat c$, with responsible branch $p^c_j$ and witness $h^c$. The essential observation is that we can find a responsible branch $p^b_i$ and witness $h^c$ showing $t;g\sat b$.

In fact, since $o$ is surjective, take $i$ such that $j=o(i)$; this determines $p^b_i$. Now observe that $k_i;u^b_i;t;g=u^c_j;g=d^c_j;h^c$ and hence (since the lower square of \fcite{sb-morphism preserves satisfaction} is a pushout) there is a unique $h^b:P^b_i\to G$ with $d^b_i;h^b=u^b_i;t;g$ and $t_i;h^b=h^c$. Together with the induction hypothesis and the fact that $m^i$ is complete, these are precisely the properties needed for $h^b$ to be a witness of $t;g\sat b$.\qed
\end{proof}

\subsection{From arrow-based to span-based conditions}

Span-based conditions are richer than arrow-based conditions. In this subsection we show the existence of a full, satisfaction-invariant functor from $\ABC_\bC$ to $\SBC_\bC$.

First, we inductively define the ``natural'' span-based conditon $\hat c$ for an arbitrary arrow-based condition $c$. Let $R\in\bC$.
\begin{itemize}
\item For an arbitrary $c=(R,p_1\ccdots p_w)\in \AC R$, let $\hat c=(R,\hat p_1\ccdots \hat p_w)$; 
\item For an arbitrary $p=(r,c)\in \AB R$, let $\hat p=(\id_R,r,\hat c)$.
\end{itemize}
%
It follows (by induction) that $\hat c\in \SC R$ for all $c\in \AC R$ and $\hat p\in \SB R$ for all $p\in \AB R$. In particular, an arrow-based branch $p=(r,c)$ (with root $R$) is translated to a span-based branch in which $R$ is the interface and the span consists of up-arrow $\id_R$ and down-arrow $r$.

The structure of morphisms remains essentially identical. Let $b,c\in \ABC$.
%
\begin{itemize}
\item For arbitrary $m:b\func c$ with $m=(t,o,m_1\ccdots m_w)$, let $\hat m=(t,o,\hat m_1\ccdots \hat m_w)$.
\end{itemize}
%
\begin{proposition}
$m$ is an ab-morphism from $b$ to $c$ if and only if $\hat m$ is an sb-morphism from $\hat b$ to $\hat c$. Moreover, $\hat \id_c=\id_{\hat c}$ for all ab-conditions $c$ and $\widehat{m;n}=\hat m;\hat n$ for all ab-morphisms $m,n$.
\end{proposition}
%
Now let $\cF$ map every $c\in \ABC$ to $\hat c$, and every $m\in \ABC(b,c)$ to $\hat m$.

\begin{theorem}
$\cF$ is a full and faithful functor from $\ABC$ to $\SBC$ such that, for all $c\in \ABC$ and all arrows $g$, $g\sat c$ if and only if $g\sat \cF(c)$.
\end{theorem}




