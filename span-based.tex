\section{Span-based conditions}

We now present one the main idea of this paper based on the observation that there is a lot of duplication in a nested condition: the children of a node essentially contain all the structure of that (parent) node, and add some constraints on top of it. It turns out to be possible to avoid this duplication by only specifying the \emph{additional} structure (and how it is connected). This is achieved by replacing the branch arrows $r^c_i$ of a condition $c$ by \emph{spans}.

Span-based conditions are inductively defined as follows:

\begin{definition}[span-based condition]\dlabel{sb-condition}
  For any object $R$ of $\bC$, $\SC R$ (the set of \emph{span-based conditions} over $R$) and $\SB R$ (the set of \emph{span-based branches} over $R$) are the smallest sets such that
  \begin{itemize}
  \item $c\in \SC R$ if $c=(R,p_1\ccdots p_w)$ is a pair with $p_i\in \SB R$ for all $1\leq i\leq w$;
  \item $p\in \SB R$ if $p=(u,d,c)$ where $u: I\to R, d:I\func S$ form a span of arrows of $\bC$ and $c\in \SC S$.
  \end{itemize}
\end{definition}
%
%\emph{Terminology and notation:}
In a branch $p=(u,d,c)$, $u$ stands for the \emph{up-arrow} and $d$ for the \emph{down-arrow}. As before, we use $|c|=w$ to denote the width of a span-based condition $c$, $R^c$ to denote its root, and $p^c_i=(u^c_i,d^c_i,c_i)$ its $i$-th branch. Finally, we use $I^c_i$ for the interface of branch $p^c_i$ and $P^c_i$ ($=R^{c_i}$) for the root of its subcondition (hence $u^c_i:I^c_i\func R^c$ and $d^c_i:I^c_i\rightarrow R^c_i$). In all these cases, we may omit the superscript $c$ if it is clear from the context. Pictorially, $c$ can be visualised as in \fcite{sb-condition}.
%
\begin{figure}
  \centering
  \input{figs/sb-condition}
  \caption{Pictorial representation of a span-based condition $c=(R,p_1\ccdots p_w)$, with $p_i=(u_i,d_i,c_i)$ for all $1\leq i\leq w$}
  \flabel{sb-condition}
\end{figure}
%
As we will see later, the arrows $r^c_i$ of an arrow-based condition can be reconstructed by taking the pushout over the spans $R^c\cnuf I^c_i\func R^c_i$.

\medskip\noindent Span-based conditions come with a modified notation of satisfaction.

\begin{definition}[satisfaction of span-based conditions]\dlabel{sb-satisfaction}
  Let $c$ be a span-based condition and $g:R\func G$ an arrow from $c$'s root to an object $G$. We say that \emph{$g$ satisfies $c$}, denoted $g\sat c$, if there is a branch $p_i$ and an arrow $h:R_i\func G$ such that
  \begin{enumerate}
  \item $u_i;g=d_i;h$
  \item $h\nsat c_i$.
  \end{enumerate}
\end{definition}
%
%\emph{Terminology and notation.} 
Like before, we call $p_i$ the \emph{responsible branch} and $h$ the \emph{witness} of $g\sat c$. Pictorially, $g\sat c$ with responsible branch $p_i$ and witness $h$ can be visualised as in \fcite{sb-satisfaction}.
%
\begin{figure}
  \centering
  \input{figs/sb-satisfaction}
  \caption{Pictorial representation of $g\sat c$ for a span-based condition $c$, with responsible branch $p_i=(u_i,d_i,c_i)$ and witness $h$}
  \flabel{sb-satisfaction}
\end{figure}

\medskip\noindent
Span-based conditions have a notion of morphism.
%
\begin{definition}[span-based condition morphism]\dlabel{sb-morphism}
  Given two sb-conditions $b,c$, an \emph{sb-morphism} $m:b\to c$ is a triple $(t,o,m_1\ccdots m_{|b|})$ such that
  \begin{itemize}
  \item $t:R^b\func R^c$ is an arrow in $\bC$, called the \emph{top-level arrow} of $m$;
  \item $o:[1,|b|]\to [1,|c|]$ is a function from $b$'s branches to $c$'s branches;
  \item for all $1\leq i\leq |b|$:
    \begin{enumerate*}[label=(\roman*)]
    \item $m_i:c_{o(i)}\to b_i$ is an sb-morphism with top-level arrow $t_i$ and 
	\item there is an arrow $k_i:I^c_{o(i)}\to I^b_i$,
    \end{enumerate*}
	such that
    \begin{enumerate}
    \item\label{up-commutes} $k_i;u^b_i;t=u^c_{o(i)}$;
    \item\label{down-commutes} $k_i;d^b_i=d^c_{o(i)};t_i$.
    \end{enumerate}
  \end{itemize}
  $m$ is called \emph{complete} if $o$ is surjective and for all $i$, the commuting square of clause~\ref{down-commutes} is a pushout and $m_i$ is complete.
\end{definition}
%
%\emph{Notation and terminology:}
We write $t^m$ and $o^m$ for the components of $m$, and (for all $1\leq i\leq |b|$) $t^m_i$ ($=t_{m_i}$) for the top-level arrow of $m_i$ --- often omitting the superscript $m$ if it is clear from the context. Pictorially, $m$ can be visualised as in \fcite{sb-morphism}.
%
\begin{figure}
  \centering
  \input{figs/sb-morphism}
  \caption{Pictorial representation of a span-based condition morphism $m:b\func c$ (with $w=|b|$ and $m=(t,o,m_1\ccdots m_w)$)}
  \flabel{sb-morphism}
\end{figure}
%
%\medskip\noindent
%\emph{Note to self: I find it surprising that there are no conditions on $k_p$ except for the confluence equations. For instance, $k_p,d_q$ is \emph{not} necessarily a pullback of $t_{m_p},d_p$ (\excite{no pullback} below); in fact, $k_p$ is \emph{not even} uniquely determined by the two confluence equations (\excite{k not unique} below). This is one of the reasons why the $k$ are not part of the morphism, but merely required to exist; otherwise there can be multiple morphisms between the same conditions that only differ in their $k$-components.}

\medskip\noindent Again, span-based condition morphisms have the expected properties: identities and composition exist and the categorical laws are satisfied, thus span-based conditions and their morphisms form a category.

\begin{proposition}[category \cat{SB-Cond}]
  The category $\cat{SB-Cond}$ having span-based conditions (\dcite{sb-condition}) as objects and span-based condition morphisms (\dcite{sb-morphism}) as arrows is well-defined. In addition, identities in $\cat{SB-Cond}$ are complete, and complete morphisms compose.
\end{proposition}
 
\begin{proof}
  Given an sb-condition $c=(R,p_1\ccdots p_w)$, the identity morphism $\id_c:c\func c$ is inductively defined as $(\id_R,\id_w,\id_{c_1}\ccdots \id_{c_w})$: the required commutativity properties trivially hold by choosing $k_i=\id_{I_i}$. By construction, $\id_c$ is complete.
  
Given two ab-condition morphisms $m:b\func c$ and $n:c\func e$, their composition is defined as $m;n=(t^m;t^n,o^m;o^n,(n_{o^m(1)};m_1)\ccdots (n_{o^m(w)};m_{w}))$ (where $w=|b|$).
The well-definedness of $m;n$ can be proved in a standard way, choosing as intermediate morphisms $k_i=k^n_{o(i)};k^m_i$ for all $1\leq i\leq w$. If $m$ and $n$ are complete, so is $m;n$ (due to the fact that $o^m;o^n$ is surjective if both $o^m$ and $o^n$ are, and that pushouts compose).

The identity laws and associativity of composition can be proved in a standard way. \qed
\end{proof}
%
With this notion of morphism, we not only have the desired preservation of satisfaction, but also reflection of satisfaction in case of completeness, in the following sense:
%
\begin{proposition}[morphisms preserve satisfaction]\plabel{sb-morphism preserves satisfaction}
Let $b$ and $c$ be span-based conditions. If $m:b\func c$ is an sb-condition morphism, then $t;g\sat b$ implies $g\sat c$ for all arrows $g:R^c\to G$. Moreover, if $m$ is complete then also the converse is true: $g\sat c$ implies for $t;g\sat b$ all arrows $g:R^c\to G$.
\end{proposition}
%
\begin{proof}
By induction. Assume that $p_i$ is the responsible branch of $b$ and $h^b\colon R_{c_p}\func G$ the witness for $t;g\sat b$; hence the induction hypothesis implies that the proposition holds for $c_{o(i)}$, and moreover, $u^b_i;t;g=d^b_i;h^b$ and $h^b\nsat b_i$. Moreover, let $j=o(i)$ and let $k\colon I^c_j\func I^b_i$ be as required in \dcite{sb-morphism}. This is visualised in \fcite{sb-morphism preserves satisfaction}.
%
\begin{figure}
  \centering
  \input{figs/sb-morphism-preserves-satisfaction}
  \caption{Pictorial representation of \pref{sb-morphism preserves satisfaction}: if $m:b\rightarrow c$ is an sb-morphism, then $t;g\sat b$ implies $g\sat c$}
  \flabel{sb-morphism preserves satisfaction}
\end{figure}

Now $h^c=t_i;h^b$ can be shown to satisfy the conditions for $h$ in \dcite{sb-satisfaction} to be a witness for $g\sat c$, with responsible branch $p^c_j$:
\begin{enumerate}
\item $u^c_j;g = k_i;u^c_i;t;g= k_i;d^b_i;h^b = d^c_j;t_i;h^b=d^c_j;h^c$.
\item Suppose that $h^c\sat c_j$, meaning $t_i;h^b\sat c_j$; then by the induction hypothesis and the fact that $m_i$ is a morphism from $c_j$ to $b_i$, it follows that $h^b\sat b_i$, which is in contradiction with the initial assumption of this proof. Hence $h^c\nsat c_j$.
\end{enumerate}
%
Now assume that $m$ is complete and $g\sat c$, with responsible branch $p^c_j$ and witness $h^c$. The essential observation is that we can find a responsible branch $p^b_i$ and witness $h^c$ showing $t;g\sat b$.

In fact, since $o$ is surjective, take $i$ such that $j=o(i)$; this determines $p^b_i$. Now observe that $k_i;u^b_i;t;g=u^c_j;g=d^c_j;h^c$ and hence (since the lower square of \fcite{sb-morphism preserves satisfaction} is a pushout) there is a unique $h^b:R^b_i\to G$ with $d^b_i;h^b=u^b_i;t;g$ and $t_i;h^b=h^c$. Together with the induction hypothesis and the fact that $m^i$ is complete, these are precisely the properties needed for $h^b$ to be a witness of $t;g\sat b$.\qed
\end{proof}

\subsection{From arrow-based to span-based conditions}

Span-based conditions are richer than arrow-based conditions. In this subsection we show the existence of a full, satisfaction-invariant functor from $\ABC_\bC$ to $\SBC_\bC$.

First, we inductively define the ``natural'' span-based conditon $\hat c$ for an arbitrary arrow-based condition $c$. Let $R\in\bC$.
\begin{itemize}
\item For an arbitrary $c=(R,p_1\ccdots p_w)\in \AC R$, let $\hat c=(R,\hat p_1\ccdots \hat p_w)$; 
\item For an arbitrary $p=(r,c)\in \AB R$, let $\hat p=(\id_R,r,\hat c)$.
\end{itemize}
%
It follows (by induction) that $\hat c\in \SC R$ for all $c\in \AC R$ and $\hat p\in \SB R$ for all $p\in \AB R$. In particular, an arrow-based branch $p=(r,c)$ (with root $R$) is translated to a span-based branch in which $R$ is the interface and the span consists of up-arrow $\id_R$ and down-arrow $r$.

The structure of morphisms remains essentially identical. Let $b,c\in \ABC$.
%
\begin{itemize}
\item For arbitrary $m:b\func c$ with $m=(t,o,m_1\ccdots m_w)$, let $\hat m=(t,o,\hat m_1\ccdots \hat m_w)$.
\end{itemize}
%
\begin{proposition}
$m$ is an ab-morphism from $b$ to $c$ if and only if $\hat m$ is an sb-morphism from $\hat b$ to $\hat c$. Moreover, $\hat \id_c=\id_{\hat c}$ for all ab-conditions $c$ and $\widehat{m;n}=\hat m;\hat n$ for all ab-morphisms $m,n$.
\end{proposition}
%
Now let $\cF$ map every $c\in \ABC$ to $\hat c$, and every $m\in \ABC(b,c)$ to $\hat m$.

\begin{theorem}
$\cF$ is a full and faithful functor from $\ABC$ to $\SBC$ such that, for all $c\in \ABC$ and all arrows $g$, $g\sat c$ if and only if $g\sat \cF(c)$.
\end{theorem}




